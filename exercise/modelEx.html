<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Olalla Díaz-Yáñez">
<meta name="author" content="Laura Dobor">
<meta name="author" content="Katarina Merganicova">
<meta name="author" content="Mats Nieberg">

<title>Forest Modeling Exercise</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="modelEx_files/libs/clipboard/clipboard.min.js"></script>
<script src="modelEx_files/libs/quarto-html/quarto.js"></script>
<script src="modelEx_files/libs/quarto-html/popper.min.js"></script>
<script src="modelEx_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="modelEx_files/libs/quarto-html/anchor.min.js"></script>
<link href="modelEx_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="modelEx_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="modelEx_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="modelEx_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="modelEx_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-overview" id="toc-sec-overview" class="nav-link active" data-scroll-target="#sec-overview">Overview</a>
  <ul class="collapse">
  <li><a href="#data-and-model" id="toc-data-and-model" class="nav-link" data-scroll-target="#data-and-model">Data and model</a></li>
  </ul></li>
  <li><a href="#sec-pb" id="toc-sec-pb" class="nav-link" data-scroll-target="#sec-pb">Process based</a>
  <ul class="collapse">
  <li><a href="#iland-model" id="toc-iland-model" class="nav-link" data-scroll-target="#iland-model">iLand model</a>
  <ul class="collapse">
  <li><a href="#general" id="toc-general" class="nav-link" data-scroll-target="#general">General</a></li>
  <li><a href="#input-and-outputs-of-iland" id="toc-input-and-outputs-of-iland" class="nav-link" data-scroll-target="#input-and-outputs-of-iland">Input and outputs of iLand</a></li>
  <li><a href="#how-to-work-with-the-model" id="toc-how-to-work-with-the-model" class="nav-link" data-scroll-target="#how-to-work-with-the-model">How to work with the model</a></li>
  </ul></li>
  <li><a href="#excercises" id="toc-excercises" class="nav-link" data-scroll-target="#excercises">Excercises</a>
  <ul class="collapse">
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting started</a></li>
  <li><a href="#explore-input-files" id="toc-explore-input-files" class="nav-link" data-scroll-target="#explore-input-files">Explore input files</a></li>
  <li><a href="#run-the-model" id="toc-run-the-model" class="nav-link" data-scroll-target="#run-the-model">Run the model</a></li>
  <li><a href="#working-with-the-output" id="toc-working-with-the-output" class="nav-link" data-scroll-target="#working-with-the-output">Working with the output:</a></li>
  <li><a href="#run-alternative-scenarios" id="toc-run-alternative-scenarios" class="nav-link" data-scroll-target="#run-alternative-scenarios">Run alternative scenarios</a></li>
  <li><a href="#sec-A_1" id="toc-sec-A_1" class="nav-link" data-scroll-target="#sec-A_1">Question A - Group 1</a></li>
  <li><a href="#sec-B_1" id="toc-sec-B_1" class="nav-link" data-scroll-target="#sec-B_1">Question B - Group 1</a></li>
  <li><a href="#sec-A_2" id="toc-sec-A_2" class="nav-link" data-scroll-target="#sec-A_2">Question A - Group 2</a></li>
  <li><a href="#sec-B_2" id="toc-sec-B_2" class="nav-link" data-scroll-target="#sec-B_2">Question B - Group 2</a></li>
  <li><a href="#sec-A_3" id="toc-sec-A_3" class="nav-link" data-scroll-target="#sec-A_3">Question A - Group 3</a></li>
  <li><a href="#sec-B_3" id="toc-sec-B_3" class="nav-link" data-scroll-target="#sec-B_3">Question B - Group 3</a></li>
  <li><a href="#sec-A_4" id="toc-sec-A_4" class="nav-link" data-scroll-target="#sec-A_4">Question A - Group 4</a></li>
  <li><a href="#sec-B_4" id="toc-sec-B_4" class="nav-link" data-scroll-target="#sec-B_4">Question B - Group 4</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-em" id="toc-sec-em" class="nav-link" data-scroll-target="#sec-em">Empirical modeling</a>
  <ul class="collapse">
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
  <ul class="collapse">
  <li><a href="#sec-dataDescription" id="toc-sec-dataDescription" class="nav-link" data-scroll-target="#sec-dataDescription">Data description</a></li>
  </ul></li>
  <li><a href="#species-description" id="toc-species-description" class="nav-link" data-scroll-target="#species-description">Species description</a>
  <ul class="collapse">
  <li><a href="#species-1---bryophytes" id="toc-species-1---bryophytes" class="nav-link" data-scroll-target="#species-1---bryophytes">Species 1 - Bryophytes</a></li>
  <li><a href="#species-2---great-spotted-woodpecker" id="toc-species-2---great-spotted-woodpecker" class="nav-link" data-scroll-target="#species-2---great-spotted-woodpecker">Species 2 - Great spotted woodpecker</a></li>
  <li><a href="#species-3---eurasian-treecreeper" id="toc-species-3---eurasian-treecreeper" class="nav-link" data-scroll-target="#species-3---eurasian-treecreeper">Species 3 - Eurasian treecreeper</a></li>
  </ul></li>
  <li><a href="#models" id="toc-models" class="nav-link" data-scroll-target="#models">Models</a>
  <ul class="collapse">
  <li><a href="#generalized-linear-models-glms" id="toc-generalized-linear-models-glms" class="nav-link" data-scroll-target="#generalized-linear-models-glms">Generalized Linear Models (GLMs)</a></li>
  <li><a href="#sec-modelBRT" id="toc-sec-modelBRT" class="nav-link" data-scroll-target="#sec-modelBRT">Boosted regression trees (BRTs)</a></li>
  </ul></li>
  <li><a href="#the-exercise" id="toc-the-exercise" class="nav-link" data-scroll-target="#the-exercise">The exercise</a>
  <ul class="collapse">
  <li><a href="#the-project-folder" id="toc-the-project-folder" class="nav-link" data-scroll-target="#the-project-folder">The project folder</a></li>
  <li><a href="#download-the-data" id="toc-download-the-data" class="nav-link" data-scroll-target="#download-the-data">Download the data</a></li>
  <li><a href="#explore-the-data" id="toc-explore-the-data" class="nav-link" data-scroll-target="#explore-the-data">Explore the data</a></li>
  <li><a href="#sec-C_1" id="toc-sec-C_1" class="nav-link" data-scroll-target="#sec-C_1">Question C - Group 1</a></li>
  <li><a href="#sec-D_1" id="toc-sec-D_1" class="nav-link" data-scroll-target="#sec-D_1">Question D - Group 1</a></li>
  <li><a href="#sec-C_2" id="toc-sec-C_2" class="nav-link" data-scroll-target="#sec-C_2">Question C - Group 2</a></li>
  <li><a href="#sec-D_2" id="toc-sec-D_2" class="nav-link" data-scroll-target="#sec-D_2">Question D - Group 2</a></li>
  <li><a href="#sec-C_3" id="toc-sec-C_3" class="nav-link" data-scroll-target="#sec-C_3">Question C - Group 3</a></li>
  <li><a href="#sec-D_3" id="toc-sec-D_3" class="nav-link" data-scroll-target="#sec-D_3">Question D - Group 3</a></li>
  <li><a href="#sec-C_4" id="toc-sec-C_4" class="nav-link" data-scroll-target="#sec-C_4">Question C - Group 4</a></li>
  <li><a href="#sec-D_4" id="toc-sec-D_4" class="nav-link" data-scroll-target="#sec-D_4">Question D - Group 4</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Forest Modeling Exercise</h1>
<p class="subtitle lead">Process-based and empirical modeling group assignments</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Olalla Díaz-Yáñez </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            olalla.diaz@usys.ethz.ch (ETH Zurich)
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    <p class="author">Laura Dobor </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            dobor@fld.czu.cz (CZU)
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    <p class="author">Katarina Merganicova </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            merganicova@fld.czu.cz (CZU)
          </p>
      </div>
      <div class="quarto-title-meta-contents">
    <p class="author">Mats Nieberg </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            mats.nieberg@pik-potsdam.de (PIK-Potsdam | EFI)
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<section id="sec-overview" class="level1">
<h1>Overview</h1>
<p>This document contains the instructions and solutions of the modeling group assignments. First, you will find the section for the process model approach (<a href="#sec-pb">Section&nbsp;2</a>) and after that the section for the empirical modelling (<a href="#sec-em">Section&nbsp;3</a>). This document is very long because it describes all the exercises and solutions step by step.</p>
<p>You will work per groups in the four groups established at the beginning of the week. Each of the four groups will be divided internally in four subgroups (A-D). Each subgroup (A-D) inside each group (1-4) will address one question that will have to be answered using one approach. In the table below you can find a link to the section to each question e.g.&nbsp;group 1 subgroup A will answer the questions “<strong>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 1?</strong>” using the approach based on the model iLand and will have the full instructions and solution in <a href="#sec-A_1">Section&nbsp;2.2.6</a>.</p>
<p>Please, always ask your coach if you do not know what is the section where you should be working in.</p>
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Group</th>
<th>Subgroup Question</th>
<th>Question</th>
<th>Approach</th>
<th>Go to</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>A</td>
<td>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 1?</td>
<td>iLand</td>
<td><a href="#sec-A_1">Section&nbsp;2.2.6</a></td>
</tr>
<tr class="even">
<td>1</td>
<td>B</td>
<td>How the species distribution and total living biomass C content changing in time on Plot 1?</td>
<td>iLand</td>
<td><a href="#sec-A_2">Section&nbsp;2.2.8</a></td>
</tr>
<tr class="odd">
<td>1</td>
<td>C</td>
<td>Does a more diverse forest in structure and composition have more Bryophites species?</td>
<td>GLM</td>
<td><a href="#sec-C_1">Section&nbsp;3.4.4</a></td>
</tr>
<tr class="even">
<td>1</td>
<td>D</td>
<td>Is the number of Bryophites species affected by forest management type and the forest structural diversity?</td>
<td>GLM</td>
<td><a href="#sec-D_1">Section&nbsp;3.4.5</a></td>
</tr>
<tr class="odd">
<td>2</td>
<td>A</td>
<td>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 2?</td>
<td>iLand</td>
<td><a href="#sec-A_2">Section&nbsp;2.2.8</a></td>
</tr>
<tr class="even">
<td>2</td>
<td>B</td>
<td>How the species distribution and total living biomass C content changing in time on Plot 2?</td>
<td>iLand</td>
<td><a href="#sec-B_2">Section&nbsp;2.2.9</a></td>
</tr>
<tr class="odd">
<td>2</td>
<td>C</td>
<td>Does a more diverse forest in structure and composition have more bird species?</td>
<td>GLM</td>
<td><a href="#sec-C_2">Section&nbsp;3.4.6</a></td>
</tr>
<tr class="even">
<td>2</td>
<td>D</td>
<td>Is the number of bird species affected by forest management type and the forest structural diversity?</td>
<td>GLM</td>
<td><a href="#sec-D_2">Section&nbsp;3.4.7</a></td>
</tr>
<tr class="odd">
<td>3</td>
<td>A</td>
<td>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 3?</td>
<td>iLand</td>
<td><a href="#sec-A_3">Section&nbsp;2.2.10</a></td>
</tr>
<tr class="even">
<td>3</td>
<td>B</td>
<td>How the species distribution and total living biomass C content changing in time on Plot 3?</td>
<td>iLand</td>
<td><a href="#sec-B_3">Section&nbsp;2.2.11</a></td>
</tr>
<tr class="odd">
<td>3</td>
<td>C</td>
<td>Is the presence of the Great spotted woodpecker affected by forest density?</td>
<td>BRT</td>
<td><a href="#sec-C_3">Section&nbsp;3.4.8</a></td>
</tr>
<tr class="even">
<td>3</td>
<td>D</td>
<td>Is the presence of the Great spotted woodpecker affected by forest diversity?</td>
<td>BRT</td>
<td><a href="#sec-D_3">Section&nbsp;3.4.9</a></td>
</tr>
<tr class="odd">
<td>4</td>
<td>A</td>
<td>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 4?</td>
<td>iLand</td>
<td><a href="#sec-A_4">Section&nbsp;2.2.12</a></td>
</tr>
<tr class="even">
<td>4</td>
<td>B</td>
<td>How the species distribution and total living biomass C content changing in time on Plot 4?</td>
<td>iLand</td>
<td><a href="#sec-B_4">Section&nbsp;2.2.13</a></td>
</tr>
<tr class="odd">
<td>4</td>
<td>C</td>
<td>Is the presence of the Eurasian treecreeper affected by forest density?</td>
<td>BRT</td>
<td><a href="#sec-C_4">Section&nbsp;3.4.10</a></td>
</tr>
<tr class="even">
<td>4</td>
<td>D</td>
<td>Is the presence of the Eurasian treecreeper affected by forest management?</td>
<td>BRT</td>
<td><a href="#sec-D_4">Section&nbsp;3.4.11</a></td>
</tr>
</tbody>
</table>
<section id="data-and-model" class="level2">
<h2 class="anchored" data-anchor-id="data-and-model">Data and model</h2>
<p>We provide all data, model and scripts for the excercises. However if you will use the model iLand for your research in the future please get in contact with the model developers at the Technical University Münich: Werner Rammer (werner.rammer@tum.de) and Rupert Seidl (rupert.seidl@tum.de). Regarding the biodiversity data used in the empirical modeling processed in the emprical modeling part, in case of further usage please contact Jeňýk Hofmeister at the Czech University of Life Sciences Prague (jenyk.hofmeister@email.cz).</p>
</section>
</section>
<section id="sec-pb" class="level1">
<h1>Process based</h1>
<section id="iland-model" class="level2">
<h2 class="anchored" data-anchor-id="iland-model">iLand model</h2>
<section id="general" class="level3">
<h3 class="anchored" data-anchor-id="general">General</h3>
<p>iLand is an ecosystem model that simulates forest landscape dynamics, including growth and regeneration, disturbance dynamics, and management in a spatially explicit manner. The main entity in the model is a tree, for which the demographic processes are simulated. Processes at the stand and landscape scale constrain the dynamics of individual trees and thus allow for the scaling of tree-scale processes to large areas. The model explicitly simulates tree competition for resources such as light, water, and nutrients. A light use efficiency approach is used to simulate the production physiology. Carbon starvation is used as a process oriented indicator of tree stress, which can result from competition for resources as well as suboptimal environmental conditions for tree growth (e.g., drought).</p>
<p>iLand’s mechanistic representation of forest disturbances and vegetation dynamics, as well as the climatic sensitivity of these processes, makes it well suited for the research of disturbance dynamics under climate change. Additionally, flexible implementation of management operations, which include planting after harvests or natural disturbances, thinning, harvesting, and post-disturbance salvaging, allows for testing the effects of various disturbance management strategies.</p>
<p>A detailed model documentation is availabe on iLand WIKI page: https://iland-model.org/iLand+Hub</p>
</section>
<section id="input-and-outputs-of-iland" class="level3">
<h3 class="anchored" data-anchor-id="input-and-outputs-of-iland">Input and outputs of iLand</h3>
<p>iLand needs information in specific formats about environment (mainly climate and soil) and trees. Daily climate data is needed (https://iland-model.org/ClimateData) for minimum, maximum temperature, precipitation, vapor pressure deficit and radiation. Soil depth and soil texture (sand, silt, clay %) information are needed. The soil is represented as a one-layer bucket, no depth-dependent information is needed. The model needs species-specific parameters (https://iland-model.org/species+parameter) that are describing the behavior of each tree species (growth, mortality, competition etc.). Currently there are 31 species parametrizied for iLand, and the species specific parameters are stored in a database that is an input for the model. The parameters were previously calibrated for European conditions (species_param_europe.sqlite). iLand uses short codes for species derived from the latin names (e.g.&nbsp;Picea Abies - piab, Fagus Sylvatica - fasy, ..) Information on the initial forest is also required to start a simulation.</p>
<p>As iLand is a landscape scale model, both climate, soil and tree information need to be set spatially. For larger areas environmental maps can be set using a 100x100m resolution grid, a so called resource grid with resource units, and tree information can be set by maximum 10x10m resolution grid on a stand grid using stand IDs. There are more options how to initialize a landscape in iLand depending on our spatial scales and available data (https://iland-model.org/initialization).</p>
<p>In our case now we will use iLand in a stand-scale mode (called torus), where we simulate only one 100x100m pixel, 1 ha forest area. We will use single-tree initialization method, where we set the x-y coordinates of the trees inside the 100x100m area, tree species, dbh and height of each tree. From inventory we have data for the a circle with 13.82m radius. We generated trees for the 1ha area based on the plot-data. See details later.</p>
<p>The output of the model is an sqlite database file. The output produced by the model is highly versatile and needs to be set in advance of the simulation which output tables we would like to get.</p>
</section>
<section id="how-to-work-with-the-model" class="level3">
<h3 class="anchored" data-anchor-id="how-to-work-with-the-model">How to work with the model</h3>
<p>Simulations are driven by one xml file, the project file. After starting iland.exe, we should call the project file, load the initial forest and then run the simulation for the required length of period. iLand comes with a graphical interface where you can visualize single trees and many other things: https://iland-model.org/iLand+viewer</p>
</section>
</section>
<section id="excercises" class="level2">
<h2 class="anchored" data-anchor-id="excercises">Excercises</h2>
<p>Your group will work with the plot which you measured and worked with in the previous days (Plot1-Plot4). The 2 process based subgroups will do the same modeling experiment, just addressing different questions based on the results (see the 2 questions below).</p>
<p>You will simulate the growth and development using the process-based model, iLand. The task is to simulate your study plot for 100 years under reference conditions and one/two simplified scenarios that you could define upon your ideas. You can define scenarios assuming different temperature, precipitation and CO2 concentration levels (see more details how to do it later below). The questions that you should address forming 2 sub-groups are the following:</p>
<ol type="A">
<li><p>How biodiversity indices are changing in time and across the simulated scenario(s)? (Calculate indices)</p></li>
<li><p>How the species distribution and total living biomass C content changing in time? Compare 0 year and 100 year status in the reference case and in the case of your scenario(s)!</p></li>
</ol>
<section id="getting-started" class="level3">
<h3 class="anchored" data-anchor-id="getting-started">Getting started</h3>
<p>Navigate to this folder and download the materials for the process-based modeling exercise: https://drive.google.com/drive/folders/1o2_K3ZN-SnPR44UzZoHj9lFZQu-vU3wg?usp=drive_link</p>
<p>Go to the <em>iLand_simulations</em> folder. Here you will find several folders that are the part of the model, others are containing input data for the model and one folder is dedicated for the outputs. Additionally, you will find <em>iland.exe</em> and <em>.xml</em> files. The <em>.xml</em> file is called <em>project file</em>. This file is driving the settings of simulations, such as input/output file names, output variables and many other settings. This file is what you need to run in the model.</p>
<p>The xml file structure follows a tree structure, e.g:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span>root<span class="sc">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>child<span class="sc">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>subchild<span class="sc">&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a> ...</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span><span class="er">/</span>subchild<span class="sc">&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;/</span>child<span class="sc">&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;/</span>root<span class="sc">&gt;</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The iLand project file consists of five main sections:</p>
<ul>
<li>system: settings like file path, database locations, or logging</li>
<li>model:main settings of the models: extent (world), site specific setting, used climate, model initialization and management</li>
<li>modules: settings related to the disturbance modules of iLand</li>
<li>output: definition of which outputs should be created by the model</li>
<li>user: this section can be used for user-defined settings</li>
</ul>
<p>More details about the project file structure and meaning of each record can be found here: https://iland-model.org/project+file</p>
<p>We prepared one project file for each group (for each simulation plot). You can right away run it, and then copy-paste and modify it to specify your own scenarios for alternative simulations. You can open a project file in any text editor, but we recommend to use Notepad++ for this (https://notepad-plus-plus.org/downloads/).</p>
</section>
<section id="explore-input-files" class="level3">
<h3 class="anchored" data-anchor-id="explore-input-files">Explore input files</h3>
<p>The following input files are needed and prepared for you to run the model: This is all prepared, YOU DO NOT HAVE TO CHANGE ANYTHING:</p>
<ul>
<li>Species parameter file: database/species_param_europe.sqlite Containing the parameters for each species that are driving growth, mortality, establishment and other processes. https://iland-model.org/species+parameter</li>
</ul>
<p>Set in project file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span>path<span class="sc">&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>home<span class="sc">&gt;</span><span class="er">&lt;/</span>home<span class="sc">&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>database<span class="sc">&gt;</span>database<span class="sc">&lt;</span><span class="er">/</span>database<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!--------</span> HERE </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>      <span class="sc">&lt;</span>lip<span class="sc">&gt;</span>lip<span class="sc">&lt;</span><span class="er">/</span>lip<span class="sc">&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>temp<span class="sc">&gt;</span>temp<span class="sc">&lt;</span><span class="er">/</span>temp<span class="sc">&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>script<span class="sc">&gt;</span>scripts<span class="sc">&lt;</span><span class="er">/</span>script<span class="sc">&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>init<span class="sc">&gt;</span>init<span class="sc">&lt;</span><span class="er">/</span>init<span class="sc">&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>output<span class="sc">&gt;</span>output<span class="sc">&lt;</span><span class="er">/</span>output<span class="sc">&gt;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="er">&lt;/</span>path<span class="sc">&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    …</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>database<span class="sc">&gt;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span><span class="cf">in</span><span class="sc">&gt;</span>species_param_europe.sqlite<span class="sc">&lt;</span><span class="er">/</span><span class="cf">in</span><span class="sc">&gt;</span>  <span class="er">&lt;</span><span class="sc">!--------</span> HERE </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>      <span class="sc">&lt;</span>out<span class="sc">&gt;</span>Output_plot1_4deg_30percdrier.sqlite<span class="sc">&lt;</span><span class="er">/</span>out<span class="sc">&gt;</span>        </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>climate<span class="sc">&gt;</span>E<span class="sc">-</span>OBSv27_Roznik_46<span class="fl">.05</span>_14<span class="fl">.45</span>_1961<span class="fl">-1990.</span>sqlite<span class="sc">&lt;</span><span class="er">/</span>climate<span class="sc">&gt;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="er">&lt;/</span>database<span class="sc">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Climate file: database/E-OBSv27_Roznik_46.05_14.45_1961-1990.sqlite<br>
Daily climate data for the area based on the E-OBS dataset. https://iland-model.org/ClimateData https://surfobs.climate.copernicus.eu/dataaccess/access_eobs.php#datafiles We are using the same climate input for all plots. The E-OBS data is representative for a 0.1x0.1 degree resolution gridbox</li>
</ul>
<p>Set in project file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>database<span class="sc">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span><span class="cf">in</span><span class="sc">&gt;</span>species_param_europe.sqlite<span class="sc">&lt;</span><span class="er">/</span><span class="cf">in</span><span class="sc">&gt;</span>                  </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>out<span class="sc">&gt;</span>Output_plot1_4deg_30percdrier.sqlite<span class="sc">&lt;</span><span class="er">/</span>out<span class="sc">&gt;</span>        </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>climate<span class="sc">&gt;</span>E<span class="sc">-</span>OBSv27_Roznik_46<span class="fl">.05</span>_14<span class="fl">.45</span>_1961<span class="fl">-1990.</span>sqlite<span class="sc">&lt;</span><span class="er">/</span>climate<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!----</span> HERE</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="sc">&lt;</span><span class="er">/</span>database<span class="sc">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Enviromental file: gis/Environment.txt<br>
The structure of this file is very flexible, more or less columns can be set. If we would have a landscape with larger area with different environments, we could set more lines into this file. For now we have only one simulation pixel with 1ha area. Here we set which climate table to use from the climate file (there could be more tables, but now we have only one), what is the soil texture, soil depth. The column names are referring to specific lines in the project file.</li>
</ul>
<p>For example: if we set here “model.site.pctSand”, the model will use this sand % value instead of the value that we have in the project file under:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>  <span class="sc">&lt;</span>model<span class="sc">&gt;</span>   </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    …</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="sc">&lt;</span>site<span class="sc">&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>              <span class="er">&lt;</span>availableNitrogen<span class="sc">&gt;</span><span class="dv">84</span><span class="sc">&lt;</span><span class="er">/</span>availableNitrogen<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!--</span> kg<span class="sc">/</span>ha<span class="sc">/</span>yr <span class="sc">-</span><span class="ot">-&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>     <span class="er">&lt;</span>soilDepth<span class="sc">&gt;</span><span class="dv">38</span><span class="sc">&lt;</span><span class="er">/</span>soilDepth<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!--</span> <span class="cf">in</span> cm <span class="sc">-</span><span class="ot">-&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>     <span class="er">&lt;</span>pctSand<span class="sc">&gt;</span><span class="dv">9</span><span class="sc">&lt;</span><span class="er">/</span>pctSand<span class="sc">&gt;</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>     <span class="er">&lt;</span>pctSilt<span class="sc">&gt;</span><span class="dv">53</span><span class="sc">&lt;</span><span class="er">/</span>pctSilt<span class="sc">&gt;</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>     <span class="er">&lt;</span>pctClay<span class="sc">&gt;</span><span class="dv">38</span><span class="sc">&lt;</span><span class="er">/</span>pctClay<span class="sc">&gt;</span> </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a> ...</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span><span class="er">/</span>site<span class="sc">&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a> ...</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span><span class="er">/</span>model<span class="sc">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Set in project file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>environmentGrid<span class="sc">&gt;</span>gis<span class="sc">/</span>environment_grid.asc<span class="sc">&lt;</span><span class="er">/</span>environmentGrid<span class="sc">&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>     <span class="er">&lt;</span>environmentFile<span class="sc">&gt;</span>gis<span class="sc">/</span>Environment.txt<span class="sc">&lt;</span><span class="er">/</span>environmentFile<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!----</span> HERE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Environment grid: gis/environment_grid.asc This would specify the map of different environments. Now we have only 1 pixel, with the id of 1. In the previous file we had also id column, this specifys we want to use that environment for our pixel.</li>
</ul>
<p>Set in project file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>environmentGrid<span class="sc">&gt;</span>gis<span class="sc">/</span>environment_grid.asc<span class="sc">&lt;</span><span class="er">/</span>environmentGrid<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!----</span> HERE</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>environmentFile<span class="sc">&gt;</span>gis<span class="sc">/</span>Environment.txt<span class="sc">&lt;</span><span class="er">/</span>environmentFile<span class="sc">&gt;</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Tree initialization file: init/Tree_init_plot_1.txt This is the list of the tree with x,y coordinates, species, dbh, height and optionally with age. (age=0 means, there is no data on age, model will generate) There are other options to set initial trees/landscape (e.g.&nbsp;using distributions, number of trees in a given dbh range, or using outputs of another simulation) More details: https://iland-model.org/initialize+trees</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>initialization<span class="sc">&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>     <span class="er">&lt;</span>type<span class="sc">&gt;</span>single<span class="sc">&lt;</span><span class="er">/</span>type<span class="sc">&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>     <span class="er">&lt;</span>mode<span class="sc">&gt;</span>unit<span class="sc">&lt;</span><span class="er">/</span>mode<span class="sc">&gt;</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>     ...</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span>file<span class="sc">&gt;</span>Tree_init_plot_1.txt<span class="sc">&lt;</span><span class="er">/</span>file<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!----</span> HERE</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>saplingFile<span class="sc">&gt;</span><span class="er">&lt;/</span>saplingFile<span class="sc">&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a> ...</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span><span class="er">/</span>initialization<span class="sc">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we initialize trees taller than 4 meters. Trees smaller than 4m are handled as sapling cohorts in separated input file. Now we do not put there saplings and we do not have a sapling file.</p>
<p>We assume now no-management scenario for all simulations. Generally iLand has a very sophisticated so called “agent based management engine” functionality for large landscapes, but also simple management activities are possible for stand-scale simulations. However, for the sake of simplicity in these examples we do not simulate any management activities. This need to keep in mind during the interpretation of the results.</p>
<p>NOTE: in the graphical interface you also wont see trees smaller than 4m, because they are not simulated as individuals rather in cohorts. But as regeneration will work, after a while as they grow above 4m, they become individual trees and we can see them also visually and they have own properties (dbh, height, age,…https://iland-model.org/tree+variables ). More details on saplings: https://iland-model.org/sapling+growth+and+competition</p>
<p>Setting the output tables: In the output section you can set which tables you want to enable. Here you can find more info on the structure and variables of each table: https://iland-model.org/Outputs</p>
<p>To answer the questions the most straight forward way is to look the <em>landscape</em> output and use the <em>total_carbon_kg</em> column (total carbon in living biomass (aboveground compartments and roots) of all living trees (including regeneration layer) (kg/ha) ). This output table aggregates on the level of landscape x species. Values are always aggregated per hectare. The output is created after the growth of the year. We pre-set the project file to have this output. Additionally we will work with the <em>tree</em> output, where individual trees are recorded with position.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span>output<span class="sc">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>tree<span class="sc">&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>enabled<span class="sc">&gt;</span>true<span class="sc">&lt;</span><span class="er">/</span>enabled<span class="sc">&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;/</span>tree<span class="sc">&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a> ...</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span>landscape<span class="sc">&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>enabled<span class="sc">&gt;</span>true<span class="sc">&lt;</span><span class="er">/</span>enabled<span class="sc">&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;/</span>landscape<span class="sc">&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;/</span>output<span class="sc">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-the-model" class="level3">
<h3 class="anchored" data-anchor-id="run-the-model">Run the model</h3>
<ul>
<li>Double click on iland.exe and wait until the graphical interface opens.</li>
<li>Load the required project file on the left-hand-side under <em>iLand project file</em> by browsing on your computer after clicking on the folder icon next to the box.</li>
<li>After you selected a project file, click on the “Create Model” on the top-left part of the window with an icon of a Globe.</li>
<li>Wait until the simulation area shown in the middle.</li>
<li>Try out some visualizations on the right hand-side *Visualization options”. e.g individual trees + color by species. Here you can explore the initial stage of the 1 ha simulation area.</li>
<li>To run the model click on Run Model icon on the top and give 100 years to simulate.</li>
<li>On the bottom of the window you can follow how fast the model is running and see if it is finished.</li>
<li>Stage of the last year remains in the simulation area, and you can go to the folder <em>output</em> to check your output file.</li>
<li>When you want to run another simulation, first click on “Destroy”, then start the process again by “Creating Model” for the same project file or loading new project file.</li>
</ul>
</section>
<section id="working-with-the-output" class="level3">
<h3 class="anchored" data-anchor-id="working-with-the-output">Working with the output:</h3>
<p>The output database has a <em>.sqlite</em> extension. You can explore outputs:</p>
<ul>
<li>Open and browse it in the <em>DB Browser</em> software that was on the software list. (https://sqlitebrowser.org/)</li>
<li>Load the file into R, where you can make additional data analyses needed to answer the questions in the exercise.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model/iLand_simulations/output/Output_plot1.sqlite"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a> sqlite.driver <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a> db1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file) <span class="co"># connect to the file</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a> tabs <span class="ot">&lt;-</span>DBI<span class="sc">::</span><span class="fu">dbListTables</span>(db1) <span class="co"># explore the tables in the file</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">print</span>(tabs)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a> landscape <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1,<span class="st">"landscape"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a> DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">summary</span>(landscape)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a> <span class="fu">head</span>(landscape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are different output tables in iLand and all have specific structure, column and spatial representation of the records. The landscape output gives information on the whole landscape, but here we will work with one 1 ha pixel that is our “whole” landscape for now. Here species specific information is also available for each year. More about the meaning of the columns in the landscape output you can find here: https://iland-model.org/Outputs#Landscape_aggregates_per_species Not always all outputs are produced, in the project file we can set which output tables we want to enable, and those will be created.</p>
</section>
<section id="run-alternative-scenarios" class="level3">
<h3 class="anchored" data-anchor-id="run-alternative-scenarios">Run alternative scenarios</h3>
<p>The prepared simulation is using the 30years climate of 1961-1990, and repeating during the simulation. (The model copy paste the 30year time series after each other to fill up the simulation period) For CO2 concentration 400ppm is given. Your task is to run 2 extra alternative scenarios where you modify the output data. For example assuming 800ppm, and 4degree warming, or keep CO2 on 400ppm and decrease precipitation by 20%.</p>
<p>All of these modification can be done in the project file directly, you do not need to modify input data files!</p>
<p>For this, go to the climate section and modify the values there, and save as the project file as your alternative scenario.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span>climate<span class="sc">&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>co2concentration<span class="sc">&gt;</span><span class="dv">400</span><span class="sc">&lt;</span><span class="er">/</span>co2concentration<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!--------</span> HERE </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>tableName<span class="sc">&gt;</span>Roznik<span class="sc">&lt;</span><span class="er">/</span>tableName<span class="sc">&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>batchYears<span class="sc">&gt;</span><span class="dv">30</span><span class="sc">&lt;</span><span class="er">/</span>batchYears<span class="sc">&gt;</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>     <span class="er">&lt;</span>temperatureShift<span class="sc">&gt;</span><span class="dv">4</span><span class="sc">&lt;</span><span class="er">/</span>temperatureShift<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!--------</span> HERE </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>precipitationShift<span class="sc">&gt;</span><span class="fl">0.8</span><span class="sc">&lt;</span><span class="er">/</span>precipitationShift<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!--------</span> HERE </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>     <span class="sc">&lt;</span>randomSamplingEnabled<span class="sc">&gt;</span>false<span class="sc">&lt;</span><span class="er">/</span>randomSamplingEnabled<span class="sc">&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>         <span class="er">&lt;</span>randomSamplingList<span class="sc">&gt;</span><span class="er">&lt;/</span>randomSamplingList<span class="sc">&gt;</span> </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;/</span>climate<span class="sc">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the same CO2 concentration will be used during the whole simulation period (there is a possibility to give annually changing CO2 concentration using an external file, but for now we won’t use it for simplicity). The temperature shift is applied by the model on each day’s temperature values. The precipitation shift is a scaler that the model applies on each day’s precipitation amount. (0.8 gives 20% decrease)</p>
<p>DO NOT FORGET TO CHANGE THE OUTPUT FILE NAME AS WELL for your alternative scenario, otherwise it will overwrite the previous output. You can do it in this section in the beginning of the project file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span>database<span class="sc">&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span><span class="cf">in</span><span class="sc">&gt;</span>species_param_europe.sqlite<span class="sc">&lt;</span><span class="er">/</span><span class="cf">in</span><span class="sc">&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;</span>out<span class="sc">&gt;</span>Output_plot1_4deg_20percdrier.sqlite<span class="sc">&lt;</span><span class="er">/</span>out<span class="sc">&gt;</span> <span class="er">&lt;</span><span class="sc">!--------</span> HERE </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a> <span class="sc">&lt;</span>climate<span class="sc">&gt;</span>E<span class="sc">-</span>OBSv27_Roznik_46<span class="fl">.05</span>_14<span class="fl">.45</span>_1961<span class="fl">-1990.</span>sqlite<span class="sc">&lt;</span><span class="er">/</span>climate<span class="sc">&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a> <span class="er">&lt;/</span>database<span class="sc">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Running the alternative scenario follows the same steps as before.</p>
</section>
<section id="sec-A_1" class="level3">
<h3 class="anchored" data-anchor-id="sec-A_1">Question A - Group 1</h3>
<ul>
<li>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 1?</li>
</ul>
<p>Run the model as it is described in the previous chapters to have at least 2 simulations completed: one with reference conditions and one scenario with some changes in the environment. Check if you have the output files in the output folder: <em>iLand_simulations/output/</em>. If you manage to simulate 2 scenarios, you can expand the code to have file3, and 3rd from each variable, or make the comparison in 2 step always comparing one scenario to the reference conditions at the time.</p>
<p>Open the <em>summerSchoolExerciseProcessBased.Rproj</em> project in R studio and start working there.</p>
<p>Read in the <em>tree</em> output table from two outputs you have for your plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot1.sqlite"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot1_4deg_20percdrier.sqlite"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>file1 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path1)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path2)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Give some name for the three simulations.</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>name1 <span class="ot">&lt;-</span> <span class="st">"reference"</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>name2 <span class="ot">&lt;-</span> <span class="st">"4deg_20percdrier"</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data using the DBI package </span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>sqlite.driver  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>db1  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file1) <span class="co"># connect to the file1</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>tables.in.the.file <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbListTables</span>(db1) <span class="co"># explore the tables in the file1</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tables.in.the.file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "carbon"            "carbonflow"        "dynamicstand"     
[4] "landscape"         "landscape_removed" "runinfo"          
[7] "stand"             "tree"             </code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will work with "tree" table and tree-scale data:</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>tree1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1, <span class="st">"tree"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1)  <span class="co"># disconnect to the file1</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># READ IN DATA FROM THE SECOND FILE: -----</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>db2  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file2) <span class="co"># connect to the file2</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>tree2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db2, <span class="st">"tree"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge the data from the two files together and make a column which tells which comes from which simulation, and study the table. The column “run” will support the plotting where we can use facets in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>tree <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tree1 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name1) , </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>              tree2 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name2))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year ru rid species id  x  y      dbh   height basalArea volume_m3 age
1    0  0   1    fasy  1 79 51 69.45111 39.46735 0.3788334  6.474022 493
2    0  0   1    fasy  2 69 91 68.95086 39.18307 0.3733956  6.335131 489
3    0  0   1    fasy  3 59 83 68.42681 38.88527 0.3677414  6.191780 486
4    0  0   1    piab  4 99 19 68.36907 45.96828 0.3671210  7.138516 492
5    0  0   1    fasy  5 63 61 66.87022 38.00070 0.3512007  5.778762 475
6    0  0   1    fasy  6 55 61 65.80000 37.39252 0.3400492  5.505722 467
  leafArea_m2 foliageMass stemMass branchMass fineRootMass coarseRootMass
1    322.7507    29.34097 3099.621   378.6909     22.00573       337.2626
2    318.8086    28.98260 3049.604   372.4465     21.73695       331.6535
3    314.7003    28.60912 2997.693   365.9680     21.45684       325.8348
4    295.8482    69.61134 2192.064   365.2582     52.20850       526.4032
5    302.6273    27.51158 2846.413   347.1027     20.63368       308.8961
6    294.4398    26.76726 2744.921   334.4585     20.07544       297.5477
        lri lightResponse stressIndex reserve_kg treeFlags       run
1 0.2646746             0           0   51.34669         0 reference
2 0.5870413             0           0   50.71954         0 reference
3 0.3931382             0           0   50.06596         0 reference
4 1.0000000             0           0  121.81984         0 reference
5 0.3406834             0           0   48.14526         0 reference
6 0.4422086             0           0   46.84270         0 reference</code></pre>
</div>
</div>
<p>To explore a bit the simulation, plot the tree locations at the beginning and the end of the simulation! For plotting we use the colors for the species, and the size of a circles to show dbh differences. Here we divided dbh with the value 20 just for visualization, not to have too huge circles shading each others completely, but still see the trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>tree0 <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tree0, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> tree0<span class="sc">$</span>dbh <span class="sc">/</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Year 0"</span>) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>tree100 <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">100</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tree100, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> tree100<span class="sc">$</span>dbh <span class="sc">/</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Year 100"</span>) <span class="sc">+</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>( <span class="sc">~</span>run) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(g1, g2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that the species composition has changed and the forest become more dense. We can even identify the same trees at the same location.</p>
<p>Visualize some changes in time, for example the mean diameter of the trees!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>sum.table <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, run) <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">MD =</span> <span class="fu">mean</span>(dbh, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co">#mean diameter</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">BA =</span> <span class="fu">sum</span>(basalArea)) <span class="co">#basal area</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(sum.table, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> MD, <span class="at">color =</span> run)) <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Mean diameter [cm]"</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that there is an initial increase in mean dbh, then a drop after 20/25 years. This is due to the growing regeneration layer that is produced by the seeds of the existing trees. In the initial year we do not have regeneration layer in the simulations (it is possible to put there, but we do not have it now). And until the small trees grow up to higher than 4 m they are not appearing in the individual <em>tree</em> output as they are handled in cohorts.</p>
<p>To study biodiversity aspects, we can calculate biodiversity indicators. Let’s use the <em>adiv</em> package for species diversity. First we need to change the database structure to have the number of trees for each species in different columns (pivot_wider) without any additional columns for the <em>adiv</em> package <em>speciesdiv</em> function. We work first only with tree data from one simulation (tree1). You can find the documentation of the adiv package here: <em>“documents/adiv.pdf”</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First we need to change the </span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>tlong1 <span class="ot">&lt;-</span> tree1 <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="st">'year'</span>, <span class="at">names_from =</span> <span class="st">'species'</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_from =</span> <span class="st">'N'</span>, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">head</span>(tlong1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
   abal  fasy  piab  pisy
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1    68    50   120    49
2    68    49   115    49
3    68    48   111    48
4    68    48   110    47
5    66    48   107    46
6    65    48   105    45</code></pre>
</div>
</div>
<p>Then we apply the “speciesdiv” function and we add back the year and run columns to have the information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>div1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong1)) <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">unique</span>(tree1<span class="sc">$</span>year), <span class="at">run =</span> name1) </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(div1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  richness GiniSimpson  Simpson  Shannon  Margalef Menhinick  McIntosh year
1        4   0.7095388 3.442800 1.312005 0.5300838 0.2361125 0.4899779    0
2        4   0.7131369 3.485983 1.318098 0.5320701 0.2386200 0.4938655    1
3        4   0.7150017 3.508792 1.321063 0.5341147 0.2412091 0.4960613    2
4        4   0.7150505 3.509394 1.320996 0.5348097 0.2420910 0.4962264    3
5        4   0.7162956 3.524796 1.323410 0.5369369 0.2447960 0.4978275    4
6        4   0.7169397 3.532816 1.324555 0.5383914 0.2466506 0.4987181    5
        run
1 reference
2 reference
3 reference
4 reference
5 reference
6 reference</code></pre>
</div>
</div>
<p>We make the same steps for the other simulation results (tree2).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>tlong2 <span class="ot">&lt;-</span> tree2 <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="st">'year'</span>, <span class="at">names_from =</span> <span class="st">'species'</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_from =</span> <span class="st">'N'</span>, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>div2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong2)) <span class="sc">|&gt;</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">unique</span>(tree2<span class="sc">$</span>year), <span class="at">run =</span> name2) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We merge them all together and make a plot based on Shannon index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>tlong2 <span class="ot">&lt;-</span> tree2 <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="st">'year'</span>, <span class="at">names_from =</span> <span class="st">'species'</span>,<span class="at">values_from =</span> <span class="st">'N'</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>div2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong2)) <span class="sc">|&gt;</span> </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year=</span><span class="fu">unique</span>(tree2<span class="sc">$</span>year), <span class="at">run=</span>name2) </span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>div <span class="ot">&lt;-</span> <span class="fu">rbind</span>(div1,div2)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(div, <span class="fu">aes</span>(year, Shannon , <span class="at">color=</span>run))<span class="sc">+</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Species diversity"</span>) <span class="sc">+</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Shannon index"</span>)<span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that the values of Shannon index are first stable and then tend to decrease, while the reduction under the 4deg_20percdrier is more substantial than under the reference scenario. Shannon index is calculated as follows:</p>
<p><span class="math display">\[S=-\sum{({p~i~} * log { (p~i~)})}\]</span></p>
<p>Where <span class="math inline">\({p~i~}\)</span> is the relative abundance of the species <em>i</em>, calculated as the ratio of the abundance of the species i and the abundance of all species. Shannon-index is 0 when we have only one species at the stand.</p>
<p>We can calculate some additional biodiversity indices targeting spatial diversity using the <em>treespat</em> package developed by Francesco Chianucci (fchianucci@gmail.com). You can find a short description of the package here: <em>“documents/treespat_package.pdf”</em></p>
<p>You can install the package using devtools:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_gitlab</span>(<span class="st">'fchianucci/treespat'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we are ready to use it! Let’s calculate these two indices:</p>
<ul>
<li><p>Diameter differentiation (Gadow, 1993): Spatial size inequality defined as the mean of the ratio of smaller and larger plant sizes in the nearest neighbors of a tree. The value of the index increases with increasing average size difference between neighboring trees. 0 is implying that neighboring trees have equal size.</p></li>
<li><p>Mingling (Aguirre et al., 2003): One very intuitive extension of taxonomic species diversity (either richness or abundance) is considering spatial mingling, namely how plants of the same (con-specific neighbors) or different (hetero-specific neighbors) species are arranged in space. The mingling index calculates the proportion of the k nearest neighbors that do not belong to the same species as the reference tree. For example, with four neighbors, the mingling attribute can assume five values, ranging from 0 (all trees are of the same species) to 1 (all trees belong to different species).</p></li>
</ul>
<p>Calculate the indices based on the reference run, then based on the scenario. For each index we add extra columns with the index name, and run name for further analyses. The max.k parameter is telling how many neighboring trees we want to account for.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># diameter differentiation:</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mingling</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">DIFF</span>(tree1, <span class="at">.x =</span> x, <span class="at">.y =</span> y,<span class="at">.mark =</span> dbh, <span class="at">xmax =</span> <span class="dv">100</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>         dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"DIFF"</span>, <span class="at">name=</span><span class="st">"Diameter differentiation"</span>, <span class="at">run=</span>name1))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year      DIFF index                     name       run
1    0 0.4317331  DIFF Diameter differentiation reference
2    1 0.4104274  DIFF Diameter differentiation reference
3    2 0.3988705  DIFF Diameter differentiation reference
4    3 0.3903934  DIFF Diameter differentiation reference
5    4 0.3775628  DIFF Diameter differentiation reference
6    5 0.3595558  DIFF Diameter differentiation reference</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ming <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">MING</span>(tree1, <span class="at">.x =</span> x, <span class="at">.y =</span> y, <span class="at">.species =</span> species,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"MING"</span>, <span class="at">name=</span><span class="st">"Mingling"</span>, <span class="at">run=</span>name1))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>indices1<span class="ot">&lt;-</span><span class="fu">rbind</span>(diff <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>DIFF),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a> ming <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>MINGLING ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We calculated each index as separate variable and then merged them into indices1. Here I renamed the column names to have it all “value”, for easier plotting later on. (each line has the information on which run and which index is the value) We do the same for the scenario simulation, we merge them together and make the plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">DIFF</span>(tree2, <span class="at">.x =</span> x, <span class="at">.y =</span> y,<span class="at">.mark =</span> dbh, </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"DIFF"</span>, <span class="at">name=</span><span class="st">"Diameter differentiation"</span>, <span class="at">run=</span>name2))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>ming <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">MING</span>(tree2, <span class="at">.x =</span> x, <span class="at">.y =</span> y, <span class="at">.species =</span> species, </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"MING"</span>, <span class="at">name=</span><span class="st">"Mingling"</span>, <span class="at">run=</span>name2))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>indices2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(diff <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>DIFF),</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>                  ming <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>MINGLING ) )</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">rbind</span>(indices1,indices2)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(indices, <span class="fu">aes</span>(<span class="at">x=</span>year, <span class="at">y=</span>value, <span class="at">color=</span>run))<span class="sc">+</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">ncol=</span><span class="dv">2</span>, <span class="at">scales=</span><span class="st">"free"</span>)<span class="sc">+</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The diameter differentiation increases with the increasing average difference in diameter between neighboring trees. The value 0 indicates that neighboring trees have equal diameters. The development shows that the index values decrease during the first 20/25 years, after which it steeply increases due to the occurrence of ingrowth and then the values are stabilized. The values for the reference climate scenario are slightly higher than for the climate change scenario indicating slower growth under drier and warmer conditions and/or the differences in tree species composition (proportion of tree species). The mingling index is studying the neighboring trees regarding their species. In both development there is a decrease in the index after the occurrence of regeneration. Using the climate change scenario the index shows steeper decrease.</p>
</section>
<section id="sec-B_1" class="level3">
<h3 class="anchored" data-anchor-id="sec-B_1">Question B - Group 1</h3>
<ul>
<li>How are the species distribution and total living biomass C content changing in time on Plot 1? Compare 0 year and 100 year status in the reference case and in the case of your scenario(s)!</li>
</ul>
<p>Run the model as it is described in the previous chapters to have at least 2 simulations completed: one with reference conditions and one scenario with some changes in the environment. Check if you have the output files in the output folder: <em>iLand_simulations/output/</em>. If you manage to simulate 2 scenarios, you can expand the code to have file3, and 3rd from each variable, or make the comparison in 2 step always comparing one scenario to the reference conditions at the time. Open the <em>summerSchoolExerciseProcessBased.Rproj</em> project in R studio and start working there.</p>
<p>Read in the <em>landscape</em> output table from two outputs you have for your plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot1.sqlite"</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot1_4deg_20percdrier.sqlite"</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>file1 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path1)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path2)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Give some name for the three simulations.</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>name1<span class="ot">&lt;-</span><span class="st">"reference"</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>name2<span class="ot">&lt;-</span><span class="st">"4deg_20percdrier"</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data using the DBI package </span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>sqlite.driver <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># We will work with "landscape" table and tree-scale data:</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>db1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file1) <span class="co"># connect to the file1</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>landscape1<span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1,<span class="st">"landscape"</span>)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1) <span class="co"># disconnect to the file1</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>db2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file2) <span class="co"># connect to the file2</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>landscape2<span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db2,<span class="st">"landscape"</span>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge the data from the three files together and make a column which tells which comes from which simulation, and study the table. The column “run” will support the plotting where we can use facets in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>landscape<span class="ot">&lt;-</span><span class="fu">rbind</span>(landscape1 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run=</span>name1) , </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a> landscape2 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run=</span>name2))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(landscape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year area area_100m species count_ha dbh_avg_cm height_avg_m volume_m3
1    0    1         1    abal       68   12.55456     10.04365   4.33641
2    0    1         1    fasy       50   49.86496     28.33702 136.89579
3    0    1         1    piab      120   32.73141     22.00713 150.34005
4    0    1         1    pisy       49   50.45049     28.66693 126.09230
5    1    1         1    abal       68   14.15550     11.39836   6.12901
6    1    1         1    fasy       49   50.95480     28.84830 141.11347
  total_carbon_kg    gwl_m3 basal_area_m2   NPP_kg NPPabove_kg        LAI
1        2264.490   4.33641     0.8659201    0.000       0.000 0.09848037
2       49667.453 136.89579    10.2322163    0.000       0.000 0.94517453
3       45424.641 150.34005    12.1157843    0.000       0.000 1.22598624
4       42580.564 126.09230     9.9010286    0.000       0.000 1.13237721
5        2784.089   6.12901     1.0937620 1657.542    1128.888 0.11701639
6       52091.802 143.51049    10.4297469 9855.392    6472.199 0.96978453
  cohort_count_ha       run
1               0 reference
2               0 reference
3               0 reference
4               0 reference
5              31 reference
6              54 reference</code></pre>
</div>
</div>
<p>We can see that the output is given for each year and each species in our 1ha area. Plot the living carbon (total_carbon_kg) in time, coloring by species. We give a unified species coloring in the beginning. Plot number of trees and mean diameter. Carbon and number of trees can be plotted in an additive way, but for mean dbh we do line plot per species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>cols.all<span class="ot">=</span><span class="fu">c</span>( <span class="st">"rops"</span><span class="ot">=</span><span class="st">"#e0e0e0"</span>,<span class="st">"acpl"</span><span class="ot">=</span><span class="st">"#A9A9A9"</span>,<span class="st">"alin"</span><span class="ot">=</span><span class="st">"#696969"</span>,<span class="st">"alvi"</span><span class="ot">=</span><span class="st">"#2e2e2e"</span>,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a> <span class="st">"bepe"</span><span class="ot">=</span><span class="st">"#fadfad"</span>,<span class="st">"casa"</span><span class="ot">=</span><span class="st">"#7eeadf"</span>,<span class="st">"coav"</span><span class="ot">=</span><span class="st">"#20c6b6"</span>,<span class="st">"tipl"</span><span class="ot">=</span><span class="st">"#645394"</span>, </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a> <span class="st">"ulgl"</span><span class="ot">=</span><span class="st">"#311432"</span>,<span class="st">"saca"</span><span class="ot">=</span><span class="st">"#D8BFD8"</span>,<span class="st">"soar"</span><span class="ot">=</span><span class="st">"#DDA0DD"</span>,<span class="st">"soau"</span><span class="ot">=</span><span class="st">"#BA55D3"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a> <span class="st">"pice"</span><span class="ot">=</span><span class="st">"#D27D2D"</span>,<span class="st">"pini"</span><span class="ot">=</span><span class="st">"#a81c07"</span>,<span class="st">"algl"</span><span class="ot">=</span><span class="st">"#2ECBE9"</span>,<span class="st">"tico"</span><span class="ot">=</span><span class="st">"#128FC8"</span>, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a> <span class="st">"potr"</span><span class="ot">=</span><span class="st">"#00468B"</span>,<span class="st">"poni"</span><span class="ot">=</span><span class="st">"#5BAEB7"</span>,<span class="st">"frex"</span><span class="ot">=</span><span class="st">"#fe9cb5"</span>,<span class="st">"cabe"</span><span class="ot">=</span><span class="st">"#fe6181"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a> <span class="st">"acps"</span><span class="ot">=</span><span class="st">"#fe223e"</span>,<span class="st">"lade"</span><span class="ot">=</span><span class="st">"#FFFE71"</span>,<span class="st">"abal"</span><span class="ot">=</span><span class="st">"#FFD800"</span>, <span class="st">"pisy"</span><span class="ot">=</span><span class="st">"#A4DE02"</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a> <span class="st">"fasy"</span><span class="ot">=</span><span class="st">"#76BA1B"</span>,<span class="st">"piab"</span><span class="ot">=</span><span class="st">"#006600"</span>,<span class="st">"quro"</span><span class="ot">=</span><span class="st">"#FF7F00"</span>, <span class="st">"qupe"</span><span class="ot">=</span><span class="st">"#FF9900"</span>, </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a> <span class="st">"qupu"</span><span class="ot">=</span><span class="st">"#CC9900"</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We set here the order of the run categories for the table, to have the first</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">#run first and then the second. (left-right of the plots)</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>landscape<span class="sc">$</span>run<span class="ot">&lt;-</span><span class="fu">factor</span>( landscape<span class="sc">$</span>run, <span class="at">levels=</span><span class="fu">c</span>(name1,name2))</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the living carbon content, to have tonnes/ha, we divide total_carbon_kg by 1000.</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>g1<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, total_carbon_kg<span class="sc">/</span><span class="dv">1000</span> , <span class="at">fill=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Living C t/ha"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>g2<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, count_ha , <span class="at">fill=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Number of trees per ha"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(g1,g2, <span class="at">ncol=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex24-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>g3<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, dbh_avg_cm , <span class="at">color=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Mean dbh"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(g3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex24-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that we do not have management intervention, and in the model trees shorter than 4m are not included in these outputs. However as they grow taller than 4m, model start to handle them as individual trees and including in these outputs which we are looking now.</p>
<p>At the end of the simulated 100 years, the total simulated carbon stock in living biomass under climate change scenario was slightly higher than under the reference climate. The proportion of beech and pine increased under drier and warmer climate, while the proportion of spruce was lower, since spruce is in general more susceptible to dry conditions. The changes in the number of trees of individual tree species were more substantial than the changes in carbon stock. The number of spruce trees was substantially reduced under climate change, while under reference climate it was doubled after 30 years and then remain stable until the end of simulation. In contrast, the number of beech trees increased under both scenarios, but the increase was more pronounced under climate change scenario due to the reduction of spruce trees.</p>
<p>Mean dbh of individual species reflected the development of the number of trees. The increase in the number of trees caused the reduction of mean dbh, e.g.&nbsp;of beech under both scenarios between 20 and 35 simulation years. The species-specific graphs for mean dbh indicates that some species do not have successful regeneration under the climate change scenario. Spruce and pine dbh decreased only under reference scenario, when we observed the increase of the number of trees, while under climate change scenario the mean dbh of spruce or pine was growing indicating the growth of remaining trees of the species at the plot. In the case of fir, we observed the continuous increase of dbh due to the more or less stable number of trees at the plots. While the mean dbh of fir was growing during the whole simulation period, under drier and warmer climate mean dbh of fir did not substantially change after 70 years.</p>
<p>Calculate the stored C amount in the initial year (year==0) and the last year (year==100)!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>livingC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(run) <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sum.livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(livingC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run sum.livingC
1        reference    139.9371
2 4deg_20percdrier    139.9371</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>livingC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">100</span>) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(run) <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sum.livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(livingC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run sum.livingC
1        reference    465.9313
2 4deg_20percdrier    502.2416</code></pre>
</div>
</div>
<p>The initial conditions are same for the runs, but they are ending up at different C levels.</p>
<p>Calculate the stored C amount PER SPECIES in the initial year (year==0) and the last year (year==100)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>species.livingC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(run, species) <span class="sc">|&gt;</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(species.livingC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species  livingC
1        reference    abal  2.26449
2        reference    fasy 49.66745
3        reference    piab 45.42464
4        reference    pisy 42.58056
5 4deg_20percdrier    abal  2.26449
6 4deg_20percdrier    fasy 49.66745
7 4deg_20percdrier    piab 45.42464
8 4deg_20percdrier    pisy 42.58056</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>species.livingC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">100</span>) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(run, species) <span class="sc">|&gt;</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(species.livingC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species   livingC
1        reference    abal 117.08641
2        reference    fasy 130.23479
3        reference    piab 192.96180
4        reference    pisy  25.64826
5 4deg_20percdrier    abal 123.25491
6 4deg_20percdrier    fasy 187.43320
7 4deg_20percdrier    piab 150.38585
8 4deg_20percdrier    pisy  41.16762</code></pre>
</div>
</div>
<p>Calculate the species proportions based on the stored C amount in the initial year (year==0) and the last year (year==100) For this we need the total C amount and the species-specific C amount.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>LC0 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(species.livingC0, livingC0, <span class="at">by=</span><span class="st">"run"</span> )</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>LC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(LC0 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">spec.prop=</span>livingC<span class="sc">/</span>sum.livingC, <span class="at">year=</span><span class="dv">0</span>))</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(LC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species  livingC sum.livingC  spec.prop year
1        reference    abal  2.26449    139.9371 0.01618219    0
2        reference    fasy 49.66745    139.9371 0.35492686    0
3        reference    piab 45.42464    139.9371 0.32460745    0
4        reference    pisy 42.58056    139.9371 0.30428349    0
5 4deg_20percdrier    abal  2.26449    139.9371 0.01618219    0
6 4deg_20percdrier    fasy 49.66745    139.9371 0.35492686    0
7 4deg_20percdrier    piab 45.42464    139.9371 0.32460745    0
8 4deg_20percdrier    pisy 42.58056    139.9371 0.30428349    0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>LC100 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(species.livingC100, livingC100, <span class="at">by=</span><span class="st">"run"</span> )</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>LC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(LC100 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">spec.prop=</span>livingC<span class="sc">/</span>sum.livingC, <span class="at">year=</span><span class="dv">100</span>))</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(LC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species   livingC sum.livingC  spec.prop year
1        reference    abal 117.08641    465.9313 0.25129545  100
2        reference    fasy 130.23479    465.9313 0.27951504  100
3        reference    piab 192.96180    465.9313 0.41414220  100
4        reference    pisy  25.64826    465.9313 0.05504730  100
5 4deg_20percdrier    abal 123.25491    502.2416 0.24540961  100
6 4deg_20percdrier    fasy 187.43320    502.2416 0.37319331  100
7 4deg_20percdrier    piab 150.38585    502.2416 0.29942930  100
8 4deg_20percdrier    pisy  41.16762    502.2416 0.08196777  100</code></pre>
</div>
</div>
<p>Put the two tables together and visualize the results!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>LC <span class="ot">&lt;-</span> <span class="fu">rbind</span>(LC0,LC100)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>LC<span class="sc">$</span>run <span class="ot">&lt;-</span> <span class="fu">factor</span>(LC<span class="sc">$</span>run, <span class="at">levels=</span><span class="fu">c</span>(name1,name2))</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(LC, <span class="fu">aes</span>(<span class="at">fill=</span>species, <span class="at">y=</span>livingC , <span class="at">x=</span><span class="fu">factor</span>(year))) <span class="sc">+</span> </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_bar</span>(<span class="at">position=</span><span class="st">"stack"</span>, <span class="at">stat=</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all)<span class="sc">+</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run)<span class="sc">+</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Living C absolute values"</span>)<span class="sc">+</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex28-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(LC, <span class="fu">aes</span>(<span class="at">fill=</span>species, <span class="at">y=</span>spec.prop, <span class="at">x=</span><span class="fu">factor</span>(year))) <span class="sc">+</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_bar</span>(<span class="at">position=</span><span class="st">"stack"</span>, <span class="at">stat=</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all)<span class="sc">+</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run)<span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Species proportion based on carbon"</span>)<span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex28-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The living C stock tripled over 100 years due to the accumulation of biomass in trees and no management interventions. Moreover, the proportion of individual tree species changed with fir substantially increasing its share. The living C stock of pine was reduced under the reference climate or remained unchanged under the climate change scenario.</p>
</section>
<section id="sec-A_2" class="level3">
<h3 class="anchored" data-anchor-id="sec-A_2">Question A - Group 2</h3>
<ul>
<li>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 2?</li>
</ul>
<p>Run the model as it is described in the previous chapters to have at least 2 simulations completed: one with reference conditions and one scenario with some changes in the environment. Check if you have the output files in the output folder: <em>iLand_simulations/output/</em>. If you manage to simulate 2 scenarios, you can expand the code to have file3, and 3rd from each variable, or make the comparison in 2 step always comparing one scenario to the reference conditions at the time.</p>
<p>Open the <em>summerSchoolExerciseProcessBased.Rproj</em> project in R studio and start working there.</p>
<p>Read in the <em>tree</em> output table from two outputs you have for your plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot2.sqlite"</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot2_4deg_20percdrier.sqlite"</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>file1 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path1)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path2)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Give some name for the three simulations.</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>name1 <span class="ot">&lt;-</span> <span class="st">"reference"</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>name2 <span class="ot">&lt;-</span> <span class="st">"4deg_20percdrier"</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data using the DBI package </span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>sqlite.driver  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>db1  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file1) <span class="co"># connect to the file1</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>tables.in.the.file <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbListTables</span>(db1) <span class="co"># explore the tables in the file1</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tables.in.the.file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "carbon"            "carbonflow"        "dynamicstand"     
[4] "landscape"         "landscape_removed" "runinfo"          
[7] "stand"             "tree"             </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will work with "tree" table and tree-scale data:</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>tree1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1, <span class="st">"tree"</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1)  <span class="co"># disconnect to the file1</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># READ IN DATA FROM THE SECOND FILE: -----</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>db2  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file2) <span class="co"># connect to the file2</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>tree2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db2, <span class="st">"tree"</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge the data from the two files together and make a column which tells which comes from which simulation, and study the table. The column “run” will support the plotting where we can use facets in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>tree <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tree1 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name1) , </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>              tree2 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name2))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year ru rid species id  x  y      dbh   height basalArea volume_m3  age
1    0  0   1    piab  1 65 43 85.63804 57.57916 0.5760011 14.029073  616
2    0  0   1    qupe  2  9 47 78.57278 40.23281 0.4848798  8.856667 1072
3    0  0   1    piab  3 95 39 78.37173 52.69362 0.4824016 10.752442  564
4    0  0   1    piab  4 95 91 76.88074 51.69115 0.4642212 10.150361  553
5    0  0   1    piab  5 79 75 74.49680 50.08829 0.4358782  9.235103  536
6    0  0   1    qupe  6 89 49 71.96641 36.85005 0.4067706  6.805241  982
  leafArea_m2 foliageMass stemMass branchMass fineRootMass coarseRootMass
1    420.3857    98.91427 3815.740   613.1350     74.18570       986.7341
2    394.8285    41.56089 3702.413   365.5260     31.17067      1160.0538
3    366.0804    86.13657 3067.633   500.0222     64.60242       770.4860
4    355.2738    83.59383 2925.986   478.4131     62.69537       730.2825
5    338.2381    79.58543 2707.714   444.9787     59.68908       668.8427
6    340.0686    35.79670 3147.565   311.7678     26.84752       936.2913
        lri lightResponse stressIndex reserve_kg treeFlags       run
1 0.4567858             0           0  173.09998         0 reference
2 0.2441241             0           0   72.73156         0 reference
3 1.0000000             0           0  150.73898         0 reference
4 1.0000000             0           0  146.28922         0 reference
5 0.4540371             0           0  139.27451         0 reference
6 0.2951740             0           0   62.64423         0 reference</code></pre>
</div>
</div>
<p>To explore a bit the simulation, plot the tree locations at the beginning and the end of the simulation! For plotting we use the colors for the species, and the size of a circles to show dbh differences. Here we divided dbh with the value 20 just for visualization, not to have too huge circles shading each others completely, but still see the trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>tree0 <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tree0, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> tree0<span class="sc">$</span>dbh <span class="sc">/</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Year 0"</span>) <span class="sc">+</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>tree100 <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">100</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tree100, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> tree100<span class="sc">$</span>dbh <span class="sc">/</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Year 100"</span>) <span class="sc">+</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>( <span class="sc">~</span>run) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(g1, g2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that the species composition has changed and the dbh of the trees seems to be larger, than in the initial year. We can even identify the same trees at the same location.</p>
<p>Visualize some changes in time, for example the mean diameter of the trees!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>sum.table <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, run) <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">MD =</span> <span class="fu">mean</span>(dbh, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co">#mean diameter</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">BA =</span> <span class="fu">sum</span>(basalArea)) <span class="co">#basal area</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(sum.table, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> MD, <span class="at">color =</span> run)) <span class="sc">+</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Mean diameter [cm]"</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that there is an initial increase in mean dbh, then a drop after 20/25 years under reference conditions. Under the climate change scenario, the mean dbh is growing for longer time and has the drop after 60 years. The dbh in the last year are very similar however the development of the simulations were different. The drop is due to the growing regeneration layer that is produced by the seeds of the existing trees. In the initial year we do not have regeneration layer in the simulations (it is possible to put there, but we do not have it now). And until the small trees grow up to higher than 4 m they are not appearing in the individual <em>tree</em> output as they are handled in cohorts.</p>
<p>To study biodiversity aspects, we can calculate biodiversity indicators. Let’s use the <em>adiv</em> package for species diversity. First we need to change the database structure to have the number of trees for each species in different columns (pivot_wider) without any additional columns for the <em>adiv</em> package <em>speciesdiv</em> function. We work first only with tree data from one simulation (tree1). You can find the documentation of the adiv package here: <em>“documents/adiv.pdf”</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First we need to change the </span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>tlong1 <span class="ot">&lt;-</span> tree1 <span class="sc">|&gt;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="st">'year'</span>, <span class="at">names_from =</span><span class="st">'species'</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_from =</span> <span class="st">'N'</span>, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">head</span>(tlong1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
   casa  fasy  piab  pisy  qupe
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1   385    34   118    32    68
2   358    34   117    30    64
3   335    33   115    30    63
4   319    33   114    30    63
5   310    32   112    29    63
6   303    31   112    29    62</code></pre>
</div>
</div>
<p>Then we apply the “speciesdiv” function and we add back the year and run columns to have the information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>div1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong1)) <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">unique</span>(tree1<span class="sc">$</span>year),<span class="at">run =</span> name1) </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(div1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  richness GiniSimpson  Simpson  Shannon  Margalef Menhinick  McIntosh year
1        5   0.5836227 2.401668 1.162161 0.6195048 0.1981072 0.3693616    0
2        5   0.5929556 2.456735 1.177198 0.6248128 0.2036157 0.3773673    1
3        5   0.6039255 2.524778 1.196665 0.6293160 0.2083333 0.3867710    2
4        5   0.6136885 2.588585 1.214413 0.6322962 0.2114775 0.3951745    3
5        5   0.6159951 2.604134 1.217670 0.6346568 0.2139802 0.3973226    4
6        5   0.6185478 2.621560 1.221342 0.6363349 0.2157659 0.3996270    5
        run
1 reference
2 reference
3 reference
4 reference
5 reference
6 reference</code></pre>
</div>
</div>
<p>We make the same steps for the other simulation results (tree2).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>tlong2 <span class="ot">&lt;-</span> tree2 <span class="sc">|&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="st">'year'</span>, <span class="at">names_from=</span><span class="st">'species'</span>,<span class="at">values_from=</span><span class="st">'N'</span>, </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>div2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong2)) <span class="sc">|&gt;</span> </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year=</span><span class="fu">unique</span>(tree2<span class="sc">$</span>year), <span class="at">run=</span>name2) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We merge them all together and make a plot based on Shannon index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>tlong2<span class="ot">&lt;-</span>tree2 <span class="sc">|&gt;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="st">'year'</span>, <span class="at">names_from=</span><span class="st">'species'</span>,<span class="at">values_from=</span><span class="st">'N'</span>,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>div2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong2)) <span class="sc">|&gt;</span> </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year=</span><span class="fu">unique</span>(tree2<span class="sc">$</span>year), <span class="at">run=</span>name2) </span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>div <span class="ot">&lt;-</span> <span class="fu">rbind</span>(div1,div2)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(div, <span class="fu">aes</span>(year, Shannon , <span class="at">color=</span>run))<span class="sc">+</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Species diversity"</span>) <span class="sc">+</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Shannon index"</span>)<span class="sc">+</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that the values of Shannon index are first increasing and then tend to decrease, while the reduction under the 4deg_20percdrier is starting later than under the reference scenario. Shannon index is calculated as follows:</p>
<p><span class="math display">\[S=-\sum{({p~i~} * log { (p~i~)})}\]</span></p>
<p>Where <span class="math inline">\({p~i~}\)</span> is the relative abundance of the species <em>i</em>, calculated as the ratio of the abundance of the species i and the abundance of all species. Shannon-index is 0 when we have only one species at the stand.</p>
<p>We can calculate some additional biodiversity indices targeting spatial diversity using the <em>treespat</em> package developed by Francesco Chianucci (fchianucci@gmail.com). You can find a short description of the package here: <em>“documents/treespat_package.pdf”</em></p>
<p>You can install the package using devtools:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_gitlab</span>(<span class="st">'fchianucci/treespat'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we are ready to use it! Let’s calculate these two indices:</p>
<ul>
<li><p>Diameter differentiation (Gadow, 1993): Spatial size inequality defined as the mean of the ratio of smaller and larger plant sizes in the nearest neighbors of a tree. The value of the index increases with increasing average size difference between neighboring trees. 0 is implying that neighboring trees have equal size.</p></li>
<li><p>Mingling (Aguirre et al., 2003): One very intuitive extension of taxonomic species diversity (either richness or abundance) is considering spatial mingling, namely how plants of the same (con-specific neighbors) or different (hetero-specific neighbors) species are arranged in space. The mingling index calculates the proportion of the k nearest neighbors that do not belong to the same species as the reference tree. For example, with four neighbors, the mingling attribute can assume five values, ranging from 0 (all trees are of the same species) to 1 (all trees belong to different species).</p></li>
</ul>
<p>Calculate the indices based on the reference run, then based on the scenario. For each index we add extra columns with the index name, and run name for further analyses. The max.k parameter is telling how many neighboring trees we want to account for.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(treespat)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co"># diameter differentiation:</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># mingling</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">DIFF</span>(tree1, <span class="at">.x =</span> x, <span class="at">.y =</span> y,<span class="at">.mark =</span> dbh, <span class="at">xmax =</span> <span class="dv">100</span>,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>         dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"DIFF"</span>, <span class="at">name=</span><span class="st">"Diameter differentiation"</span>, <span class="at">run=</span>name1))</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year      DIFF index                     name       run
1    0 0.4027813  DIFF Diameter differentiation reference
2    1 0.3793126  DIFF Diameter differentiation reference
3    2 0.3728755  DIFF Diameter differentiation reference
4    3 0.3672772  DIFF Diameter differentiation reference
5    4 0.3621167  DIFF Diameter differentiation reference
6    5 0.3617524  DIFF Diameter differentiation reference</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>ming <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">MING</span>(tree1, <span class="at">.x =</span> x, <span class="at">.y =</span> y, <span class="at">.species =</span> species,</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"MING"</span>, <span class="at">name=</span><span class="st">"Mingling"</span>, <span class="at">run=</span>name1))</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>indices1<span class="ot">&lt;-</span><span class="fu">rbind</span>(diff <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>DIFF),</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a> ming <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>MINGLING ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We calculated each index as separate variable and then merged them into indices1. Here I renamed the column names to have it all “value”, for easier plotting later on. (each line has the information on which run and which index is the value) We do the same for the scenario simulation, we merge them together and make the plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">DIFF</span>(tree2, <span class="at">.x =</span> x, <span class="at">.y =</span> y,<span class="at">.mark =</span> dbh, </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"DIFF"</span>, <span class="at">name=</span><span class="st">"Diameter differentiation"</span>, <span class="at">run=</span>name2))</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>ming <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">MING</span>(tree2, <span class="at">.x =</span> x, <span class="at">.y =</span> y, <span class="at">.species =</span> species, </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"MING"</span>, <span class="at">name=</span><span class="st">"Mingling"</span>, <span class="at">run=</span>name2))</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>indices2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(diff <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>DIFF),</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>                  ming <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>MINGLING ) )</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">rbind</span>(indices1,indices2)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(indices, <span class="fu">aes</span>(<span class="at">x=</span>year, <span class="at">y=</span>value, <span class="at">color=</span>run))<span class="sc">+</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">ncol=</span><span class="dv">2</span>, <span class="at">scales=</span><span class="st">"free"</span>)<span class="sc">+</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The diameter differentiation increases with the increasing average difference in diameter between neighboring trees. The value 0 indicates that neighboring trees have equal diameters. The development shows that the index values decrease during the first circa 10 years, after which it steeply increases due to the occurrence of ingrowth and then the values are stabilized. The increase is not that steep for the climate change sceanario that is in accordance with the mean dbh graph. The values for the reference climate scenario are higher than for the climate change scenario indicating slower growth under drier and warmer conditions and/or the differences in tree species composition (proportion of tree species). The mingling index is studying the neighboring trees regarding their species. In both development there is a decrease in the index after the occurrence of regeneration. Using the climate change scenario the index shows steeper decrease and ending up at lower values after 100 years.</p>
</section>
<section id="sec-B_2" class="level3">
<h3 class="anchored" data-anchor-id="sec-B_2">Question B - Group 2</h3>
<ul>
<li>How are the species distribution and total living biomass C content changing in time on Plot 2? Compare 0 year and 100 year status in the reference case and in the case of your scenario(s)!</li>
</ul>
<p>Run the model as it is described in the previous chapters to have at least 2 simulations completed: one with reference conditions and one scenario with some changes in the environment. Check if you have the output files in the output folder: <em>iLand_simulations/output/</em>. If you manage to simulate 2 scenarios, you can expand the code to have file3, and 3rd from each variable, or make the comparison in 2 step always comparing one scenario to the reference conditions at the time. Open the <em>summerSchoolExerciseProcessBased.Rproj</em> project in R studio and start working there.</p>
<p>Read in the <em>landscape</em> output table from two outputs you have for your plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot2.sqlite"</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot2_4deg_20percdrier.sqlite"</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>file1 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path1)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path2)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Give some name for the three simulations.</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>name1<span class="ot">&lt;-</span><span class="st">"reference"</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>name2<span class="ot">&lt;-</span><span class="st">"4deg_20percdrier"</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data using the DBI package </span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>sqlite.driver <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="co"># We will work with "landscape" table and tree-scale data:</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>db1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file1) <span class="co"># connect to the file1</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>landscape1<span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1,<span class="st">"landscape"</span>)</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1) <span class="co"># disconnect to the file1</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>db2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file2) <span class="co"># connect to the file2</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>landscape2<span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db2,<span class="st">"landscape"</span>)</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge the data from the three files together and make a column which tells which comes from which simulation, and study the table. The column “run” will support the plotting where we can use facets in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>landscape<span class="ot">&lt;-</span><span class="fu">rbind</span>(landscape1 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run=</span>name1) , </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a> landscape2 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run=</span>name2))</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(landscape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year area area_100m species count_ha dbh_avg_cm height_avg_m  volume_m3
1    0    1         1    casa      385   21.73276    18.052312 139.177831
2    0    1         1    fasy       34   12.91628     7.340003   1.600727
3    0    1         1    piab      118   34.75135    23.365242 215.003187
4    0    1         1    pisy       32   42.76543    24.300133  49.013727
5    0    1         1    qupe       68   40.62035    20.799453 118.797078
6    1    1         1    casa      358   22.49524    18.644885 138.166090
  total_carbon_kg     gwl_m3 basal_area_m2   NPP_kg NPPabove_kg        LAI
1       73246.102 139.177831    16.1066092    0.000       0.000 1.92032457
2        1636.821   1.600727     0.4644299    0.000       0.000 0.06445078
3       58083.681 215.003187    14.4589881    0.000       0.000 1.36948128
4       18250.374  49.013727     4.6099225    0.000       0.000 0.51041807
5       56880.735 118.797078    10.0244600    0.000       0.000 0.94624017
6       73118.915 141.336043    15.8220002 8338.849    5192.833 1.87298787
  cohort_count_ha       run
1               0 reference
2               0 reference
3               0 reference
4               0 reference
5               0 reference
6               0 reference</code></pre>
</div>
</div>
<p>We can see that the output is given for each year and each species in our 1ha area. Plot the living carbon (total_carbon_kg) in time, coloring by species. We give a unified species coloring in the beginning. Plot number of trees and mean diameter. Carbon and number of trees can be plotted in an additive way, but for mean dbh we do line plot per species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>cols.all<span class="ot">=</span><span class="fu">c</span>( <span class="st">"rops"</span><span class="ot">=</span><span class="st">"#e0e0e0"</span>,<span class="st">"acpl"</span><span class="ot">=</span><span class="st">"#A9A9A9"</span>,<span class="st">"alin"</span><span class="ot">=</span><span class="st">"#696969"</span>,<span class="st">"alvi"</span><span class="ot">=</span><span class="st">"#2e2e2e"</span>,</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a> <span class="st">"bepe"</span><span class="ot">=</span><span class="st">"#fadfad"</span>,<span class="st">"casa"</span><span class="ot">=</span><span class="st">"#7eeadf"</span>,<span class="st">"coav"</span><span class="ot">=</span><span class="st">"#20c6b6"</span>,<span class="st">"tipl"</span><span class="ot">=</span><span class="st">"#645394"</span>, </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a> <span class="st">"ulgl"</span><span class="ot">=</span><span class="st">"#311432"</span>,<span class="st">"saca"</span><span class="ot">=</span><span class="st">"#D8BFD8"</span>,<span class="st">"soar"</span><span class="ot">=</span><span class="st">"#DDA0DD"</span>,<span class="st">"soau"</span><span class="ot">=</span><span class="st">"#BA55D3"</span>,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a> <span class="st">"pice"</span><span class="ot">=</span><span class="st">"#D27D2D"</span>,<span class="st">"pini"</span><span class="ot">=</span><span class="st">"#a81c07"</span>,<span class="st">"algl"</span><span class="ot">=</span><span class="st">"#2ECBE9"</span>,<span class="st">"tico"</span><span class="ot">=</span><span class="st">"#128FC8"</span>, </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a> <span class="st">"potr"</span><span class="ot">=</span><span class="st">"#00468B"</span>,<span class="st">"poni"</span><span class="ot">=</span><span class="st">"#5BAEB7"</span>,<span class="st">"frex"</span><span class="ot">=</span><span class="st">"#fe9cb5"</span>,<span class="st">"cabe"</span><span class="ot">=</span><span class="st">"#fe6181"</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a> <span class="st">"acps"</span><span class="ot">=</span><span class="st">"#fe223e"</span>,<span class="st">"lade"</span><span class="ot">=</span><span class="st">"#FFFE71"</span>,<span class="st">"abal"</span><span class="ot">=</span><span class="st">"#FFD800"</span>, <span class="st">"pisy"</span><span class="ot">=</span><span class="st">"#A4DE02"</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a> <span class="st">"fasy"</span><span class="ot">=</span><span class="st">"#76BA1B"</span>,<span class="st">"piab"</span><span class="ot">=</span><span class="st">"#006600"</span>,<span class="st">"quro"</span><span class="ot">=</span><span class="st">"#FF7F00"</span>, <span class="st">"qupe"</span><span class="ot">=</span><span class="st">"#FF9900"</span>, </span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a> <span class="st">"qupu"</span><span class="ot">=</span><span class="st">"#CC9900"</span>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We set here the order of the run categories for the table, to have the first</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">#run first and then the second. (left-right of the plots)</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>landscape<span class="sc">$</span>run<span class="ot">&lt;-</span><span class="fu">factor</span>( landscape<span class="sc">$</span>run, <span class="at">levels=</span><span class="fu">c</span>(name1,name2))</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the living carbon content, to have tonnes/ha, we divide total_carbon_kg by 1000.</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>g1<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, total_carbon_kg<span class="sc">/</span><span class="dv">1000</span> , <span class="at">fill=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Living C t/ha"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>g2<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, count_ha , <span class="at">fill=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Number of trees per ha"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(g1,g2, <span class="at">ncol=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex42-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>g3<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, dbh_avg_cm , <span class="at">color=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Mean dbh"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(g3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex42-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that we do not have management intervention, and in the model trees shorter than 4m are not included in these outputs. However as they grow taller than 4m, model start to handle them as individual trees and including in these outputs which we are looking now.</p>
<p><em>Castanea sativa</em> gradually decreased during the simulation period under both scenarios. The reduction resulted from the mortality of chestnut trees, indicating their aging. By the end of the simulation period, chestnut almost completely disappeared from the stand due to the increased number of trees of other species at the plot, and hence higher inter-tree competition, especially under the reference climate, which hindered the chestnut regeneration and its survival. Mean dbh of chestnut is zero at the end of the simulation period under the reference climate indicating that the species completely disappeared from the stand due to the high stand density, and inter-tree competition.</p>
<p>Calculate the stored C amount in the initial year (year==0) and the last year (year==100)!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>livingC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>                         dplyr<span class="sc">::</span><span class="fu">group_by</span>(run) <span class="sc">|&gt;</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sum.livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(livingC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run sum.livingC
1        reference    208.0977
2 4deg_20percdrier    208.0977</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>livingC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>                           dplyr<span class="sc">::</span><span class="fu">group_by</span>(run) <span class="sc">|&gt;</span> </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sum.livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(livingC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run sum.livingC
1        reference    429.5477
2 4deg_20percdrier    428.2694</code></pre>
</div>
</div>
<p>The initial conditions are same for the runs, but they are ending up at different C levels.</p>
<p>Calculate the stored C amount PER SPECIES in the initial year (year==0) and the last year (year==100)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>species.livingC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>                                 dplyr<span class="sc">::</span><span class="fu">group_by</span>(run, species) <span class="sc">|&gt;</span> </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(species.livingC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                run species   livingC
1         reference    casa 73.246102
2         reference    fasy  1.636821
3         reference    piab 58.083681
4         reference    pisy 18.250374
5         reference    qupe 56.880735
6  4deg_20percdrier    casa 73.246102
7  4deg_20percdrier    fasy  1.636821
8  4deg_20percdrier    piab 58.083681
9  4deg_20percdrier    pisy 18.250374
10 4deg_20percdrier    qupe 56.880735</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>species.livingC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>                                   dplyr<span class="sc">::</span><span class="fu">group_by</span>(run, species) <span class="sc">|&gt;</span> </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(species.livingC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                run species    livingC
1         reference    casa   0.000000
2         reference    fasy  75.469157
3         reference    piab 274.331862
4         reference    pisy  12.701789
5         reference    qupe  67.044909
6  4deg_20percdrier    casa   4.546279
7  4deg_20percdrier    fasy 110.708431
8  4deg_20percdrier    piab 159.773037
9  4deg_20percdrier    pisy  55.439370
10 4deg_20percdrier    qupe  97.802295</code></pre>
</div>
</div>
<p>Calculate the species proportions based on the stored C amount in the initial year (year==0) and the last year (year==100) For this we need the total C amount and the species-specific C amount.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>LC0 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(species.livingC0, livingC0, <span class="at">by=</span><span class="st">"run"</span> )</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>LC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(LC0 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">spec.prop=</span>livingC<span class="sc">/</span>sum.livingC, <span class="at">year=</span><span class="dv">0</span>))</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(LC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                run species   livingC sum.livingC   spec.prop year
1         reference    casa 73.246102    208.0977 0.351979370    0
2         reference    fasy  1.636821    208.0977 0.007865637    0
3         reference    piab 58.083681    208.0977 0.279117344    0
4         reference    pisy 18.250374    208.0977 0.087700985    0
5         reference    qupe 56.880735    208.0977 0.273336665    0
6  4deg_20percdrier    casa 73.246102    208.0977 0.351979370    0
7  4deg_20percdrier    fasy  1.636821    208.0977 0.007865637    0
8  4deg_20percdrier    piab 58.083681    208.0977 0.279117344    0
9  4deg_20percdrier    pisy 18.250374    208.0977 0.087700985    0
10 4deg_20percdrier    qupe 56.880735    208.0977 0.273336665    0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>LC100 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(species.livingC100, livingC100, <span class="at">by=</span><span class="st">"run"</span> )</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>LC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(LC100 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">spec.prop=</span>livingC<span class="sc">/</span>sum.livingC, <span class="at">year=</span><span class="dv">100</span>))</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(LC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                run species    livingC sum.livingC  spec.prop year
1         reference    casa   0.000000    429.5477 0.00000000  100
2         reference    fasy  75.469157    429.5477 0.17569447  100
3         reference    piab 274.331862    429.5477 0.63865282  100
4         reference    pisy  12.701789    429.5477 0.02957015  100
5         reference    qupe  67.044909    429.5477 0.15608256  100
6  4deg_20percdrier    casa   4.546279    428.2694 0.01061547  100
7  4deg_20percdrier    fasy 110.708431    428.2694 0.25850184  100
8  4deg_20percdrier    piab 159.773037    428.2694 0.37306666  100
9  4deg_20percdrier    pisy  55.439370    428.2694 0.12944975  100
10 4deg_20percdrier    qupe  97.802295    428.2694 0.22836629  100</code></pre>
</div>
</div>
<p>Put the two tables together and visualize the results!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>LC <span class="ot">&lt;-</span> <span class="fu">rbind</span>(LC0,LC100)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>LC<span class="sc">$</span>run <span class="ot">&lt;-</span> <span class="fu">factor</span>(LC<span class="sc">$</span>run, <span class="at">levels=</span><span class="fu">c</span>(name1,name2))</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(LC, <span class="fu">aes</span>(<span class="at">fill=</span>species, <span class="at">y=</span>livingC , <span class="at">x=</span><span class="fu">factor</span>(year))) <span class="sc">+</span> </span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_bar</span>(<span class="at">position=</span><span class="st">"stack"</span>, <span class="at">stat=</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all)<span class="sc">+</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run)<span class="sc">+</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Living C absolute values"</span>)<span class="sc">+</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex46-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(LC, <span class="fu">aes</span>(<span class="at">fill=</span>species, <span class="at">y=</span>spec.prop, <span class="at">x=</span><span class="fu">factor</span>(year))) <span class="sc">+</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_bar</span>(<span class="at">position=</span><span class="st">"stack"</span>, <span class="at">stat=</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all)<span class="sc">+</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run)<span class="sc">+</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Species proportion based on carbon"</span>)<span class="sc">+</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex46-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The living carbon stock doubled over 100 years due to the accumulation of biomass at the plot irrespective of the climate scenario. The comparison of the results between the two climate scenarios showed the differemnce in the tree species share. The living C stock of spruce was lower under the climate change reflecting its susceptibility to dry conditions, while the living C stock of Quercus pubescens, Fagus sylvatica and Pinus sylvestris were higher. Additionally, we see a significant increase in the share of the shade-tolerant beech at the expense of light-demanding chestnut.</p>
</section>
<section id="sec-A_3" class="level3">
<h3 class="anchored" data-anchor-id="sec-A_3">Question A - Group 3</h3>
<ul>
<li>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 3?</li>
</ul>
<p>Run the model as it is described in the previous chapters to have at least 2 simulations completed: one with reference conditions and one scenario with some changes in the environment. Check if you have the output files in the output folder: <em>iLand_simulations/output/</em>. If you manage to simulate 2 scenarios, you can expand the code to have file3, and 3rd from each variable, or make the comparison in 2 step always comparing one scenario to the reference conditions at the time.</p>
<p>Open the <em>summerSchoolExerciseProcessBased.Rproj</em> project in R studio and start working there.</p>
<p>Read in the <em>tree</em> output table from two outputs you have for your plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot3.sqlite"</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot3_4deg_20percdrier.sqlite"</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>file1 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path1)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path2)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Give some name for the three simulations.</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>name1 <span class="ot">&lt;-</span> <span class="st">"reference"</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>name2 <span class="ot">&lt;-</span> <span class="st">"4deg_20percdrier"</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data using the DBI package </span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>sqlite.driver  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>db1  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file1) <span class="co"># connect to the file1</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>tables.in.the.file <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbListTables</span>(db1) <span class="co"># explore the tables in the file1</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tables.in.the.file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "carbon"            "carbonflow"        "dynamicstand"     
[4] "landscape"         "landscape_removed" "runinfo"          
[7] "stand"             "tree"             </code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will work with "tree" table and tree-scale data:</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>tree1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1, <span class="st">"tree"</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1)  <span class="co"># disconnect to the file1</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="co"># READ IN DATA FROM THE SECOND FILE: -----</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>db2  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file2) <span class="co"># connect to the file2</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>tree2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db2, <span class="st">"tree"</span>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge the data from the two files together and make a column which tells which comes from which simulation, and study the table. The column “run” will support the plotting where we can use facets in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>tree <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tree1 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name1) , </span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>              tree2 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name2))</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year ru rid species id  x  y      dbh   height basalArea volume_m3 age
1    0  0   1    piab  1  7 41 80.47096 54.10505 0.5085905 11.639825 579
2    0  0   1    piab  2 57 63 77.85299 52.34484 0.4760367 10.540342 560
3    0  0   1    fasy  3 33 45 77.32411 43.94139 0.4695910  8.934730 549
4    0  0   1    fasy  4 79 97 76.44166 43.43991 0.4589338  8.632307 542
5    0  0   1    piab  5 99 35 74.65018 50.19142 0.4376748  9.292261 537
6    0  0   1    fasy  6 11 77 74.61653 42.40273 0.4372804  8.028635 530
  leafArea_m2 foliageMass stemMass branchMass fineRootMass coarseRootMass
1    381.4915    89.76272 3273.843   531.3649     67.32204       829.4560
2    362.3074    85.24881 3017.901   492.4429     63.93661       756.3417
3    387.3896    35.21723 3946.903   484.7826     26.41292       432.6764
4    379.9038    34.53671 3846.260   472.1521     25.90253       421.3067
5    339.3250    79.84119 2721.455   447.0886     59.88089       672.6917
6    364.6130    33.14663 3642.679   446.6253     24.85997       398.3362
        lri lightResponse stressIndex reserve_kg treeFlags       run
1 0.5557720             0           0  157.08476         0 reference
2 0.3826686             0           0  149.18542         0 reference
3 0.4321580             0           0   61.63016         0 reference
4 0.7127665             0           0   60.43925         0 reference
5 1.0000000             0           0  139.72208         0 reference
6 0.3028383             0           0   58.00661         0 reference</code></pre>
</div>
</div>
<p>To explore a bit the simulation, plot the tree locations at the beginning and the end of the simulation! For plotting we use the colors for the species, and the size of a circles to show dbh differences. Here we divided dbh with the value 20 just for visualization, not to have too huge circles shading each others completely, but still see the trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>tree0 <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tree0, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> tree0<span class="sc">$</span>dbh <span class="sc">/</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Year 0"</span>) <span class="sc">+</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>tree100 <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">100</span>)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tree100, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> tree100<span class="sc">$</span>dbh <span class="sc">/</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Year 100"</span>) <span class="sc">+</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>( <span class="sc">~</span>run) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(g1, g2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that the species composition is somewhat changed and the forest become more dense. We can even identify the same trees at the same location.</p>
<p>Visualize some changes in time, for example the mean diameter of the trees!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>sum.table <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, run) <span class="sc">|&gt;</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">MD =</span> <span class="fu">mean</span>(dbh, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co">#mean diameter</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">BA =</span> <span class="fu">sum</span>(basalArea)) <span class="co">#basal area</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(sum.table, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> MD, <span class="at">color =</span> run)) <span class="sc">+</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Mean diameter [cm]"</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex50-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that there is an initial increase in mean dbh, then a drop after 20/25 years. This is due to the growing regeneration layer that is produced by the seeds of the existing trees. In the initial year we do not have regeneration layer in the simulations (it is possible to put there, but we do not have it now). And until the small trees grow up to higher than 4 m they are not appearing in the individual <em>tree</em> output as they are handled in cohorts.</p>
<p>To study biodiversity aspects, we can calculate biodiversity indicators. Let’s use the <em>adiv</em> package for species diversity. First we need to change the database structure to have the number of trees for each species in different columns (pivot_wider) without any additional columns for the <em>adiv</em> package <em>speciesdiv</em> function. We work first only with tree data from one simulation (tree1). You can find the documentation of the adiv package here: <em>“documents/adiv.pdf”</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First we need to change the </span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>tlong1 <span class="ot">&lt;-</span> tree1 <span class="sc">|&gt;</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="st">'year'</span>, <span class="at">names_from =</span><span class="st">'species'</span>,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_from =</span> <span class="st">'N'</span>, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">head</span>(tlong1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
   acps  fasy  piab  tico
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1   113    67    49    32
2   110    67    49    28
3   108    67    49    27
4   106    66    47    27
5   104    65    47    27
6   103    64    46    26</code></pre>
</div>
</div>
<p>Then we apply the “speciesdiv” function and we add back the year and run columns to have the information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>div1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong1)) <span class="sc">|&gt;</span> </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">unique</span>(tree1<span class="sc">$</span>year),<span class="at">run =</span> name1) </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(div1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  richness GiniSimpson  Simpson  Shannon  Margalef Menhinick  McIntosh year
1        4   0.6963785 3.293574 1.282865 0.5391300 0.2475938 0.4786064    0
2        4   0.6935024 3.262668 1.274467 0.5417769 0.2509823 0.4762610    1
3        4   0.6939255 3.267178 1.274173 0.5429419 0.2524778 0.4768591    2
4        4   0.6938000 3.265839 1.274493 0.5449263 0.2550307 0.4770630    3
5        4   0.6955241 3.284332 1.277850 0.5461435 0.2566001 0.4789300    4
6        4   0.6936853 3.264617 1.274063 0.5477988 0.2587385 0.4774250    5
        run
1 reference
2 reference
3 reference
4 reference
5 reference
6 reference</code></pre>
</div>
</div>
<p>We make the same steps for the other simulation results (tree2).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>tlong2 <span class="ot">&lt;-</span> tree2 <span class="sc">|&gt;</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="st">'year'</span>, <span class="at">names_from=</span><span class="st">'species'</span>,<span class="at">values_from=</span><span class="st">'N'</span>, </span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>div2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong2)) <span class="sc">|&gt;</span> </span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year=</span><span class="fu">unique</span>(tree2<span class="sc">$</span>year), <span class="at">run=</span>name2) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We merge them all together and make a plot based on Shannon index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>tlong2<span class="ot">&lt;-</span>tree2 <span class="sc">|&gt;</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="st">'year'</span>, <span class="at">names_from=</span><span class="st">'species'</span>,<span class="at">values_from=</span><span class="st">'N'</span>,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>div2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong2)) <span class="sc">|&gt;</span> </span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year=</span><span class="fu">unique</span>(tree2<span class="sc">$</span>year), <span class="at">run=</span>name2) </span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>div <span class="ot">&lt;-</span> <span class="fu">rbind</span>(div1,div2)</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(div, <span class="fu">aes</span>(year, Shannon , <span class="at">color=</span>run))<span class="sc">+</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Species diversity"</span>) <span class="sc">+</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Shannon index"</span>)<span class="sc">+</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex54-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that the values of Shannon index are first stable and then tend to decrease, while the reduction under the 4deg_20percdrier is more substantial than under the reference scenario. Shannon index is calculated as follows:</p>
<p><span class="math display">\[S=-\sum{({p~i~} * log { (p~i~)})}\]</span></p>
<p>Where <span class="math inline">\({p~i~}\)</span> is the relative abundance of the species <em>i</em>, calculated as the ratio of the abundance of the species i and the abundance of all species. Shannon-index is 0 when we have only one species at the stand.</p>
<p>We can calculate some additional biodiversity indices targeting spatial diversity using the <em>treespat</em> package developed by Francesco Chianucci (fchianucci@gmail.com). You can find a short description of the package here: <em>“documents/treespat_package.pdf”</em></p>
<p>You can install the package using devtools:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_gitlab</span>(<span class="st">'fchianucci/treespat'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we are ready to use it! Let’s calculate these two indices:</p>
<ul>
<li><p>Diameter differentiation (Gadow, 1993): Spatial size inequality defined as the mean of the ratio of smaller and larger plant sizes in the nearest neighbors of a tree. The value of the index increases with increasing average size difference between neighboring trees. 0 is implying that neighboring trees have equal size.</p></li>
<li><p>Mingling (Aguirre et al., 2003): One very intuitive extension of taxonomic species diversity (either richness or abundance) is considering spatial mingling, namely how plants of the same (con-specific neighbors) or different (hetero-specific neighbors) species are arranged in space. The mingling index calculates the proportion of the k nearest neighbors that do not belong to the same species as the reference tree. For example, with four neighbors, the mingling attribute can assume five values, ranging from 0 (all trees are of the same species) to 1 (all trees belong to different species).</p></li>
</ul>
<p>Calculate the indices based on the reference run, then based on the scenario. For each index we add extra columns with the index name, and run name for further analyses. The max.k parameter is telling how many neighboring trees we want to account for.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># diameter differentiation:</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mingling</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">DIFF</span>(tree1, <span class="at">.x =</span> x, <span class="at">.y =</span> y,<span class="at">.mark =</span> dbh, <span class="at">xmax =</span> <span class="dv">100</span>,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>         dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"DIFF"</span>, <span class="at">name=</span><span class="st">"Diameter differentiation"</span>, <span class="at">run=</span>name1))</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year      DIFF index                     name       run
1    0 0.3938630  DIFF Diameter differentiation reference
2    1 0.3825122  DIFF Diameter differentiation reference
3    2 0.3765717  DIFF Diameter differentiation reference
4    3 0.3749870  DIFF Diameter differentiation reference
5    4 0.3681887  DIFF Diameter differentiation reference
6    5 0.3639637  DIFF Diameter differentiation reference</code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>ming <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">MING</span>(tree1, <span class="at">.x =</span> x, <span class="at">.y =</span> y, <span class="at">.species =</span> species,</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"MING"</span>, <span class="at">name=</span><span class="st">"Mingling"</span>, <span class="at">run=</span>name1))</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>indices1<span class="ot">&lt;-</span><span class="fu">rbind</span>(diff <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>DIFF),</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a> ming <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>MINGLING ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We calculated each index as separate variable and then merged them into indices1. Here I renamed the column names to have it all “value”, for easier plotting later on. (each line has the information on which run and which index is the value) We do the same for the scenario simulation, we merge them together and make the plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">DIFF</span>(tree2, <span class="at">.x =</span> x, <span class="at">.y =</span> y,<span class="at">.mark =</span> dbh, </span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"DIFF"</span>, <span class="at">name=</span><span class="st">"Diameter differentiation"</span>, <span class="at">run=</span>name2))</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>ming <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">MING</span>(tree2, <span class="at">.x =</span> x, <span class="at">.y =</span> y, <span class="at">.species =</span> species, </span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"MING"</span>, <span class="at">name=</span><span class="st">"Mingling"</span>, <span class="at">run=</span>name2))</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>indices2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(diff <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>DIFF),</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>                  ming <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>MINGLING ) )</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">rbind</span>(indices1,indices2)</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(indices, <span class="fu">aes</span>(<span class="at">x=</span>year, <span class="at">y=</span>value, <span class="at">color=</span>run))<span class="sc">+</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">ncol=</span><span class="dv">2</span>, <span class="at">scales=</span><span class="st">"free"</span>)<span class="sc">+</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The diameter differentiation increases with the increasing average difference in diameter between neighboring trees. The value 0 indicates that neighboring trees have equal diameters. The development shows that the index values decrease during the first 20/25 years, after which it steeply increases due to the occurrence of ingrowth and then the values are stabilized. The values for the reference climate scenario are slightly higher than for the climate change scenario indicating slower growth under drier and warmer conditions and/or the differences in tree species composition (proportion of tree species). The mingling index is studying the neighboring trees regarding their species. In both development there is a decrease in the index after the occurrence of regeneration. Using the climate change scenario the index shows steeper decrease.</p>
</section>
<section id="sec-B_3" class="level3">
<h3 class="anchored" data-anchor-id="sec-B_3">Question B - Group 3</h3>
<ul>
<li>How are the species distribution and total living biomass C content changing in time on Plot 3? Compare 0 year and 100 year status in the reference case and in the case of your scenario(s)!</li>
</ul>
<p>Run the model as it is described in the previous chapters to have at least 2 simulations completed: one with reference conditions and one scenario with some changes in the environment. Check if you have the output files in the output folder: <em>iLand_simulations/output/</em>. If you manage to simulate 2 scenarios, you can expand the code to have file3, and 3rd from each variable, or make the comparison in 2 step always comparing one scenario to the reference conditions at the time. Open the <em>summerSchoolExerciseProcessBased.Rproj</em> project in R studio and start working there.</p>
<p>Read in the <em>landscape</em> output table from two outputs you have for your plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot3.sqlite"</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot3_4deg_20percdrier.sqlite"</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>file1 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path1)</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path2)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Give some name for the three simulations.</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>name1<span class="ot">&lt;-</span><span class="st">"reference"</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>name2<span class="ot">&lt;-</span><span class="st">"4deg_20percdrier"</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data using the DBI package </span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>sqlite.driver <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a><span class="co"># We will work with "landscape" table and tree-scale data:</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>db1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file1) <span class="co"># connect to the file1</span></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>landscape1<span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1,<span class="st">"landscape"</span>)</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1) <span class="co"># disconnect to the file1</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>db2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file2) <span class="co"># connect to the file2</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>landscape2<span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db2,<span class="st">"landscape"</span>)</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge the data from the three files together and make a column which tells which comes from which simulation, and study the table. The column “run” will support the plotting where we can use facets in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>landscape<span class="ot">&lt;-</span><span class="fu">rbind</span>(landscape1 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run=</span>name1) , </span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a> landscape2 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run=</span>name2))</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(landscape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year area area_100m species count_ha dbh_avg_cm height_avg_m volume_m3
1    0    1         1    acps      113   21.62995     18.52183  41.57766
2    0    1         1    fasy       67   52.05965     29.58422 218.19995
3    0    1         1    piab       49   50.26190     33.79384 182.14630
4    0    1         1    tico       32   30.63841     23.38127  21.38005
5    1    1         1    acps      110   22.55262     19.19236  43.91456
6    1    1         1    fasy       67   53.02260     30.03274 226.37490
  total_carbon_kg    gwl_m3 basal_area_m2    NPP_kg NPPabove_kg       LAI
1        19316.78  41.57766      4.693063     0.000       0.000 0.4800021
2        74974.41 218.19995     15.193077     0.000       0.000 1.3766679
3        45666.89 182.14630     10.724078     0.000       0.000 0.9377907
4        11816.98  21.38005      2.379258     0.000       0.000 0.2673509
5        20284.37  44.17968      4.895663  3936.955    2581.190 0.4935337
6        79317.75 226.37490     15.670265 12642.176    8302.325 1.4294626
  cohort_count_ha       run
1               0 reference
2               0 reference
3               0 reference
4               0 reference
5              27 reference
6              49 reference</code></pre>
</div>
</div>
<p>We can see that the output is given for each year and each species in our 1ha area. Plot the living carbon (total_carbon_kg) in time, coloring by species. We give a unified species coloring in the beginning. Plot number of trees and mean diameter. Carbon and number of trees can be plotted in an additive way, but for mean dbh we do line plot per species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>cols.all<span class="ot">=</span><span class="fu">c</span>( <span class="st">"rops"</span><span class="ot">=</span><span class="st">"#e0e0e0"</span>,<span class="st">"acpl"</span><span class="ot">=</span><span class="st">"#A9A9A9"</span>,<span class="st">"alin"</span><span class="ot">=</span><span class="st">"#696969"</span>,<span class="st">"alvi"</span><span class="ot">=</span><span class="st">"#2e2e2e"</span>,</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a> <span class="st">"bepe"</span><span class="ot">=</span><span class="st">"#fadfad"</span>,<span class="st">"casa"</span><span class="ot">=</span><span class="st">"#7eeadf"</span>,<span class="st">"coav"</span><span class="ot">=</span><span class="st">"#20c6b6"</span>,<span class="st">"tipl"</span><span class="ot">=</span><span class="st">"#645394"</span>, </span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a> <span class="st">"ulgl"</span><span class="ot">=</span><span class="st">"#311432"</span>,<span class="st">"saca"</span><span class="ot">=</span><span class="st">"#D8BFD8"</span>,<span class="st">"soar"</span><span class="ot">=</span><span class="st">"#DDA0DD"</span>,<span class="st">"soau"</span><span class="ot">=</span><span class="st">"#BA55D3"</span>,</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a> <span class="st">"pice"</span><span class="ot">=</span><span class="st">"#D27D2D"</span>,<span class="st">"pini"</span><span class="ot">=</span><span class="st">"#a81c07"</span>,<span class="st">"algl"</span><span class="ot">=</span><span class="st">"#2ECBE9"</span>,<span class="st">"tico"</span><span class="ot">=</span><span class="st">"#128FC8"</span>, </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a> <span class="st">"potr"</span><span class="ot">=</span><span class="st">"#00468B"</span>,<span class="st">"poni"</span><span class="ot">=</span><span class="st">"#5BAEB7"</span>,<span class="st">"frex"</span><span class="ot">=</span><span class="st">"#fe9cb5"</span>,<span class="st">"cabe"</span><span class="ot">=</span><span class="st">"#fe6181"</span>,</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a> <span class="st">"acps"</span><span class="ot">=</span><span class="st">"#fe223e"</span>,<span class="st">"lade"</span><span class="ot">=</span><span class="st">"#FFFE71"</span>,<span class="st">"abal"</span><span class="ot">=</span><span class="st">"#FFD800"</span>, <span class="st">"pisy"</span><span class="ot">=</span><span class="st">"#A4DE02"</span>,</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a> <span class="st">"fasy"</span><span class="ot">=</span><span class="st">"#76BA1B"</span>,<span class="st">"piab"</span><span class="ot">=</span><span class="st">"#006600"</span>,<span class="st">"quro"</span><span class="ot">=</span><span class="st">"#FF7F00"</span>, <span class="st">"qupe"</span><span class="ot">=</span><span class="st">"#FF9900"</span>, </span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a> <span class="st">"qupu"</span><span class="ot">=</span><span class="st">"#CC9900"</span>)</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We set here the order of the run categories for the table, to have the first</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="co">#run first and then the second. (left-right of the plots)</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>landscape<span class="sc">$</span>run<span class="ot">&lt;-</span><span class="fu">factor</span>( landscape<span class="sc">$</span>run, <span class="at">levels=</span><span class="fu">c</span>(name1,name2))</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the living carbon content, to have tonnes/ha, we divide total_carbon_kg by 1000.</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>g1<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, total_carbon_kg<span class="sc">/</span><span class="dv">1000</span> , <span class="at">fill=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Living C t/ha"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>g2<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, count_ha , <span class="at">fill=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Number of trees per ha"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(g1,g2, <span class="at">ncol=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex60-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>g3<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, dbh_avg_cm , <span class="at">color=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Mean dbh"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(g3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex60-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that we do not have management intervention, and in the model trees shorter than 4m are not included in these outputs. However as they grow taller than 4m, model start to handle them as individual trees and including in these outputs which we are looking now.</p>
<p>Beech profited from drier and warmer conditions at the expense of spruce. <em>Acer pseudoplatanus</em> and <em>Tilia cordata</em> also slightly increased their proportion in the living C stock and number of trees. The increase of the number of trees indicates the success of the regeneration under reference conditions, however this increase is much slower under the climate change scenario.</p>
<p>Mean dbh of individual species reflected the development of the number of trees. The increase in the number of trees caused the reduction of mean dbh, e.g.&nbsp;of beech under both scenarios between 20 and 35 simulation years. The species-specific graphs for mean dbh indicates that some species do not have successful regeneration under the climate change scenario. Spruce dbh decreased only under reference scenario, when we observed the increase of the number of trees, while under climate change scenario the mean dbh of spruce was growing indicating the growth of remaining trees of the species at the plot.</p>
<p>Calculate the stored C amount in the initial year (year==0) and the last year (year==100)!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>livingC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>                         dplyr<span class="sc">::</span><span class="fu">group_by</span>(run) <span class="sc">|&gt;</span> </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sum.livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(livingC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run sum.livingC
1        reference    151.7751
2 4deg_20percdrier    151.7751</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>livingC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>                           dplyr<span class="sc">::</span><span class="fu">group_by</span>(run) <span class="sc">|&gt;</span> </span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sum.livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(livingC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run sum.livingC
1        reference    416.3909
2 4deg_20percdrier    420.1472</code></pre>
</div>
</div>
<p>The initial conditions are same for the runs, but they are ending up at different C levels.</p>
<p>Calculate the stored C amount PER SPECIES in the initial year (year==0) and the last year (year==100)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>species.livingC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>                                 dplyr<span class="sc">::</span><span class="fu">group_by</span>(run, species) <span class="sc">|&gt;</span> </span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">livingC =</span> <span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(species.livingC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species  livingC
1        reference    acps 19.31678
2        reference    fasy 74.97441
3        reference    piab 45.66689
4        reference    tico 11.81698
5 4deg_20percdrier    acps 19.31678
6 4deg_20percdrier    fasy 74.97441
7 4deg_20percdrier    piab 45.66689
8 4deg_20percdrier    tico 11.81698</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>species.livingC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>                                   dplyr<span class="sc">::</span><span class="fu">group_by</span>(run, species) <span class="sc">|&gt;</span> </span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(species.livingC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species    livingC
1        reference    acps  25.042637
2        reference    fasy 164.555979
3        reference    piab 221.267535
4        reference    tico   5.524713
5 4deg_20percdrier    acps  65.167214
6 4deg_20percdrier    fasy 243.374438
7 4deg_20percdrier    piab  92.649456
8 4deg_20percdrier    tico  18.956110</code></pre>
</div>
</div>
<p>Calculate the species proportions based on the stored C amount in the initial year (year==0) and the last year (year==100) For this we need the total C amount and the species-specific C amount.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>LC0 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(species.livingC0, livingC0, <span class="at">by =</span> <span class="st">"run"</span> )</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>LC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(LC0 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">spec.prop =</span> livingC<span class="sc">/</span>sum.livingC,</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">year =</span> <span class="dv">0</span>))</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(LC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species  livingC sum.livingC spec.prop year
1        reference    acps 19.31678    151.7751 0.1272724    0
2        reference    fasy 74.97441    151.7751 0.4939837    0
3        reference    piab 45.66689    151.7751 0.3008854    0
4        reference    tico 11.81698    151.7751 0.0778585    0
5 4deg_20percdrier    acps 19.31678    151.7751 0.1272724    0
6 4deg_20percdrier    fasy 74.97441    151.7751 0.4939837    0
7 4deg_20percdrier    piab 45.66689    151.7751 0.3008854    0
8 4deg_20percdrier    tico 11.81698    151.7751 0.0778585    0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>LC100 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(species.livingC100, livingC100, <span class="at">by =</span> <span class="st">"run"</span> )</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>LC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(LC100 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">spec.prop =</span> livingC<span class="sc">/</span>sum.livingC,</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">year =</span> <span class="dv">100</span>))</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(LC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species    livingC sum.livingC  spec.prop year
1        reference    acps  25.042637    416.3909 0.06014214  100
2        reference    fasy 164.555979    416.3909 0.39519594  100
3        reference    piab 221.267535    416.3909 0.53139383  100
4        reference    tico   5.524713    416.3909 0.01326809  100
5 4deg_20percdrier    acps  65.167214    420.1472 0.15510567  100
6 4deg_20percdrier    fasy 243.374438    420.1472 0.57925991  100
7 4deg_20percdrier    piab  92.649456    420.1472 0.22051665  100
8 4deg_20percdrier    tico  18.956110    420.1472 0.04511778  100</code></pre>
</div>
</div>
<p>Put the two tables together and visualize the results!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>LC <span class="ot">&lt;-</span> <span class="fu">rbind</span>(LC0,LC100)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>LC<span class="sc">$</span>run <span class="ot">&lt;-</span> <span class="fu">factor</span>(LC<span class="sc">$</span>run, <span class="at">levels =</span> <span class="fu">c</span>(name1,name2))</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(LC, <span class="fu">aes</span>(<span class="at">fill =</span> species, <span class="at">y =</span> livingC , <span class="at">x =</span> <span class="fu">factor</span>(year))) <span class="sc">+</span> </span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_bar</span>(<span class="at">position=</span><span class="st">"stack"</span>, <span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all) <span class="sc">+</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run) <span class="sc">+</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Living C absolute values"</span>) <span class="sc">+</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex64-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(LC, <span class="fu">aes</span>(<span class="at">fill =</span> species, <span class="at">y =</span> spec.prop, <span class="at">x =</span> <span class="fu">factor</span>(year))) <span class="sc">+</span> </span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_bar</span>(<span class="at">position =</span> <span class="st">"stack"</span>, <span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cols.all) <span class="sc">+</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run) <span class="sc">+</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Species proportion based on carbon"</span>) <span class="sc">+</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex64-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The living C stock more than doubled over 100 years due to the accumulation of biomass in trees and no management interventions. Moreover, the proportion of individual tree species changed depending on the driving climatic conditions. Under reference conditions the proportion of spruce has grown, under climate change the proportion of beech.</p>
</section>
<section id="sec-A_4" class="level3">
<h3 class="anchored" data-anchor-id="sec-A_4">Question A - Group 4</h3>
<ul>
<li>How are biodiversity indices changing in time and across the simulated scenario(s) on Plot 4?</li>
</ul>
<p>Run the model as it is described in the previous chapters to have at least 2 simulations completed: one with reference conditions and one scenario with some changes in the environment. Check if you have the output files in the output folder: <em>iLand_simulations/output/</em>. If you manage to simulate 2 scenarios, you can expand the code to have file3, and 3rd from each variable, or make the comparison in 2 step always comparing one scenario to the reference conditions at the time.</p>
<p>Open the <em>summerSchoolExerciseProcessBased.Rproj</em> project in R studio and start working there.</p>
<p>Read in the <em>tree</em> output table from two outputs you have for your plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot4.sqlite"</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot4_4deg_20percdrier.sqlite"</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>file1 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path1)</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path2)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Give some name for the three simulations.</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>name1 <span class="ot">&lt;-</span> <span class="st">"reference"</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>name2 <span class="ot">&lt;-</span> <span class="st">"4deg_20percdrier"</span></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data using the DBI package </span></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>sqlite.driver  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>db1  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file1) <span class="co"># connect to the file1</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>tables.in.the.file <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbListTables</span>(db1) <span class="co"># explore the tables in the file1</span></span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tables.in.the.file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "carbon"            "carbonflow"        "dynamicstand"     
[4] "landscape"         "landscape_removed" "runinfo"          
[7] "stand"             "tree"             </code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We will work with "tree" table and tree-scale data:</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>tree1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1, <span class="st">"tree"</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1)  <span class="co"># disconnect to the file1</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="co"># READ IN DATA FROM THE SECOND FILE: -----</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>db2  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file2) <span class="co"># connect to the file2</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>tree2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db2, <span class="st">"tree"</span>)</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge the data from the two files together and make a column which tells which comes from which simulation, and study the table. The column “run” will support the plotting where we can use facets in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>tree <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tree1 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name1) , </span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>              tree2 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name2))</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year ru rid species id  x  y      dbh   height basalArea volume_m3 age
1    0  0   1    fasy  1 49 65 98.48459 55.96636 0.7617745  18.46041 699
2    0  0   1    fasy  2 51 15 94.27415 53.57367 0.6980316  16.19252 669
3    0  0   1    fasy  3 97 47 94.07941 53.46301 0.6951508  16.09238 668
4    0  0   1    fasy  4 63  7 91.67390 52.09602 0.6600568  14.88928 651
5    0  0   1    fasy  5 53 57 90.70000 51.54258 0.6461070  14.41977 644
6    0  0   1    fasy  6 13 95 89.37351 50.78876 0.6273466  13.79631 634
  leafArea_m2 foliageMass stemMass branchMass fineRootMass coarseRootMass
1    584.4382    53.13074 6802.456   845.6093     39.84806       758.3801
2    542.6002    49.32729 6165.430   764.7609     36.99547       685.2726
3    540.6961    49.15419 6136.807   761.1324     36.86565       681.9930
4    517.4045    47.03678 5789.331   717.1134     35.27758       642.2182
5    508.0949    46.19045 5651.843   699.7122     34.64284       626.5004
6    495.5272    45.04793 5467.530   676.3990     33.78595       605.4482
        lri lightResponse stressIndex reserve_kg treeFlags       run
1 0.6396535             0           0   92.97880         0 reference
2 0.4253728             0           0   86.32275         0 reference
3 1.0000000             0           0   86.01984         0 reference
4 0.4545080             0           0   82.31436         0 reference
5 0.6055760             0           0   80.83328         0 reference
6 1.0000000             0           0   78.83388         0 reference</code></pre>
</div>
</div>
<p>To explore a bit the simulation, plot the tree locations at the beginning and the end of the simulation! For plotting we use the colors for the species, and the size of a circles to show dbh differences. Here we divided dbh with the value 20 just for visualization, not to have too huge circles shading each others completely, but still see the trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>tree0 <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tree0, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> tree0<span class="sc">$</span>dbh <span class="sc">/</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Year 0"</span>) <span class="sc">+</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>tree100 <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">100</span>)</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(tree100, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> tree100<span class="sc">$</span>dbh <span class="sc">/</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Year 100"</span>) <span class="sc">+</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>( <span class="sc">~</span>run) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(g1, g2, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex67-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that the species composition is somewhat changed and the forest become more dense. We can even identify the same trees at the same location.</p>
<p>Visualize some changes in time, for example the mean diameter of the trees!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>sum.table <span class="ot">&lt;-</span> tree <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, run) <span class="sc">|&gt;</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">MD =</span> <span class="fu">mean</span>(dbh, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co">#mean diameter</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">BA =</span> <span class="fu">sum</span>(basalArea)) <span class="co">#basal area</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(sum.table, ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> MD, <span class="at">color =</span> run)) <span class="sc">+</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Mean diameter [cm]"</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex68-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that there is an initial increase in mean dbh, then a drop after 20/25 years. This is due to the growing regeneration layer that is produced by the seeds of the existing trees. In the initial year we do not have regeneration layer in the simulations (it is possible to put there, but we do not have it now). And until the small trees grow up to higher than 4 m they are not appearing in the individual <em>tree</em> output as they are handled in cohorts.</p>
<p>To study biodiversity aspects, we can calculate biodiversity indicators. Let’s use the <em>adiv</em> package for species diversity. First we need to change the database structure to have the number of trees for each species in different columns (pivot_wider) without any additional columns for the <em>adiv</em> package <em>speciesdiv</em> function. We work first only with tree data from one simulation (tree1). You can find the documentation of the adiv package here: <em>“documents/adiv.pdf”</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First we need to change the </span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>tlong1 <span class="ot">&lt;-</span> tree1 <span class="sc">|&gt;</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="st">'year'</span>, <span class="at">names_from =</span><span class="st">'species'</span>,</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_from =</span> <span class="st">'N'</span>, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">head</span>(tlong1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
   casa  fasy  pisy  qupe
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1   152    70    33    18
2   147    70    32    18
3   143    69    32    18
4   139    68    30    18
5   139    68    30    18
6   137    68    30    18</code></pre>
</div>
</div>
<p>Then we apply the “speciesdiv” function and we add back the year and run columns to have the information.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>div1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong1)) <span class="sc">|&gt;</span> </span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">unique</span>(tree1<span class="sc">$</span>year),<span class="at">run =</span> name1) </span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(div1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  richness GiniSimpson  Simpson  Shannon  Margalef Menhinick  McIntosh year
1        4   0.6052946 2.533535 1.109706 0.5348097 0.2420910 0.3956925    0
2        4   0.6092385 2.559105 1.115644 0.5369369 0.2447960 0.3993293    1
3        4   0.6131053 2.584683 1.122656 0.5387598 0.2471208 0.4028815    2
4        4   0.6129335 2.583535 1.122122 0.5413928 0.2504897 0.4030962    3
5        4   0.6129335 2.583535 1.122122 0.5413928 0.2504897 0.4030962    4
6        4   0.6154135 2.600195 1.126170 0.5421632 0.2514778 0.4053326    5
        run
1 reference
2 reference
3 reference
4 reference
5 reference
6 reference</code></pre>
</div>
</div>
<p>We make the same steps for the other simulation results (tree2).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>tlong2 <span class="ot">&lt;-</span> tree2 <span class="sc">|&gt;</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="st">'year'</span>, <span class="at">names_from=</span><span class="st">'species'</span>,<span class="at">values_from=</span><span class="st">'N'</span>, </span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>div2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong2)) <span class="sc">|&gt;</span> </span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year=</span><span class="fu">unique</span>(tree2<span class="sc">$</span>year), <span class="at">run=</span>name2) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We merge them all together and make a plot based on Shannon index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>tlong2<span class="ot">&lt;-</span>tree2 <span class="sc">|&gt;</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">group_by</span>(year, species) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">N=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a> tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="st">'year'</span>, <span class="at">names_from=</span><span class="st">'species'</span>,<span class="at">values_from=</span><span class="st">'N'</span>,</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year) </span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>div2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(adiv<span class="sc">::</span><span class="fu">speciesdiv</span>(tlong2)) <span class="sc">|&gt;</span> </span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">year=</span><span class="fu">unique</span>(tree2<span class="sc">$</span>year), <span class="at">run=</span>name2) </span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>div <span class="ot">&lt;-</span> <span class="fu">rbind</span>(div1,div2)</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(div, <span class="fu">aes</span>(year, Shannon , <span class="at">color=</span>run))<span class="sc">+</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Species diversity"</span>) <span class="sc">+</span></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Shannon index"</span>)<span class="sc">+</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex72-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We see that the values of Shannon index are first stable and then tend to decrease, while the reduction under the 4deg_20percdrier is more substantial than under the reference scenario. Shannon index is calculated as follows:</p>
<p><span class="math display">\[S=-\sum{({p~i~} * log { (p~i~)})}\]</span></p>
<p>Where <span class="math inline">\({p~i~}\)</span> is the relative abundance of the species <em>i</em>, calculated as the ratio of the abundance of the species i and the abundance of all species. Shannon-index is 0 when we have only one species at the stand.</p>
<p>We can calculate some additional biodiversity indices targeting spatial diversity using the <em>treespat</em> package developed by Francesco Chianucci (fchianucci@gmail.com). You can find a short description of the package here: <em>“documents/treespat_package.pdf”</em></p>
<p>You can install the package using devtools:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_gitlab</span>(<span class="st">'fchianucci/treespat'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we are ready to use it! Let’s calculate these two indices:</p>
<ul>
<li><p>Diameter differentiation (Gadow, 1993): Spatial size inequality defined as the mean of the ratio of smaller and larger plant sizes in the nearest neighbors of a tree. The value of the index increases with increasing average size difference between neighboring trees. 0 is implying that neighboring trees have equal size.</p></li>
<li><p>Mingling (Aguirre et al., 2003): One very intuitive extension of taxonomic species diversity (either richness or abundance) is considering spatial mingling, namely how plants of the same (con-specific neighbors) or different (hetero-specific neighbors) species are arranged in space. The mingling index calculates the proportion of the k nearest neighbors that do not belong to the same species as the reference tree. For example, with four neighbors, the mingling attribute can assume five values, ranging from 0 (all trees are of the same species) to 1 (all trees belong to different species).</p></li>
</ul>
<p>Calculate the indices based on the reference run, then based on the scenario. For each index we add extra columns with the index name, and run name for further analyses. The max.k parameter is telling how many neighboring trees we want to account for.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># diameter differentiation:</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mingling</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">DIFF</span>(tree1, <span class="at">.x =</span> x, <span class="at">.y =</span> y,<span class="at">.mark =</span> dbh, <span class="at">xmax =</span> <span class="dv">100</span>,</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>         dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"DIFF"</span>, <span class="at">name=</span><span class="st">"Diameter differentiation"</span>, <span class="at">run=</span>name1))</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year      DIFF index                     name       run
1    0 0.4874231  DIFF Diameter differentiation reference
2    1 0.4752327  DIFF Diameter differentiation reference
3    2 0.4665189  DIFF Diameter differentiation reference
4    3 0.4701394  DIFF Diameter differentiation reference
5    4 0.4668349  DIFF Diameter differentiation reference
6    5 0.4663594  DIFF Diameter differentiation reference</code></pre>
</div>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>ming <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">MING</span>(tree1, <span class="at">.x =</span> x, <span class="at">.y =</span> y, <span class="at">.species =</span> species,</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape=</span><span class="st">'square'</span>, <span class="at">.groups=</span><span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index=</span><span class="st">"MING"</span>, <span class="at">name=</span><span class="st">"Mingling"</span>, <span class="at">run=</span>name1))</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>indices1<span class="ot">&lt;-</span><span class="fu">rbind</span>(diff <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>DIFF),</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a> ming <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value=</span>MINGLING ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We calculated each index as separate variable and then merged them into indices1. Here I renamed the column names to have it all “value”, for easier plotting later on. (each line has the information on which run and which index is the value) We do the same for the scenario simulation, we merge them together and make the plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">DIFF</span>(tree2, <span class="at">.x =</span> x, <span class="at">.y =</span> y,<span class="at">.mark =</span> dbh, </span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape =</span> <span class="st">'square'</span>,</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index =</span> <span class="st">"DIFF"</span>, <span class="at">name =</span> <span class="st">"Diameter differentiation"</span>,</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">run =</span> name2))</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>ming <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(treespat<span class="sc">::</span><span class="fu">MING</span>(tree2, <span class="at">.x =</span> x, <span class="at">.y =</span> y, <span class="at">.species =</span> species, </span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">xmax =</span> <span class="dv">100</span>, <span class="at">ymax =</span> <span class="dv">100</span>, <span class="at">max.k =</span> <span class="dv">4</span>, <span class="at">shape =</span> <span class="st">'square'</span>, </span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">.groups =</span> <span class="fu">c</span>(<span class="st">'year'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">index =</span> <span class="st">"MING"</span>, <span class="at">name =</span> <span class="st">"Mingling"</span>, <span class="at">run =</span> name2))</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>indices2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(diff <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value =</span> DIFF),</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>                  ming <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">value =</span> MINGLING ) )</span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>indices <span class="ot">&lt;-</span> <span class="fu">rbind</span>(indices1,indices2)</span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(indices, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> value, <span class="at">color =</span> run)) <span class="sc">+</span></span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex75-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The diameter differentiation increases with the increasing average difference in diameter between neighboring trees. The value 0 indicates that neighboring trees have equal diameters. The development shows that the index values decrease during the first 20/25 years, after which it steeply increases due to the occurrence of ingrowth and then the values are stabilized. The values for the reference climate scenario are slightly higher than for the climate change scenario indicating slower growth under drier and warmer conditions and/or the differences in tree species composition (proportion of tree species). The mingling index is studying the neighboring trees regarding their species. In both development there is a decrease in the index after the occurrence of regeneration. Using the climate change scenario the index shows steeper decrease.</p>
</section>
<section id="sec-B_4" class="level3">
<h3 class="anchored" data-anchor-id="sec-B_4">Question B - Group 4</h3>
<ul>
<li>How are the species distribution and total living biomass C content changing in time on Plot 4? Compare 0 year and 100 year status in the reference case and in the case of your scenario(s)!</li>
</ul>
<p>Run the model as it is described in the previous chapters to have at least 2 simulations completed: one with reference conditions and one scenario with some changes in the environment. Check if you have the output files in the output folder: <em>iLand_simulations/output/</em>. If you manage to simulate 2 scenarios, you can expand the code to have file3, and 3rd from each variable, or make the comparison in 2 step always comparing one scenario to the reference conditions at the time. Open the <em>summerSchoolExerciseProcessBased.Rproj</em> project in R studio and start working there.</p>
<p>Read in the <em>landscape</em> output table from two outputs you have for your plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>path1 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot4.sqlite"</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>path2 <span class="ot">&lt;-</span> <span class="st">"model/iLand_simulations/output/Output_plot4_4deg_20percdrier.sqlite"</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>file1 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path1)</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>file2 <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(path2)</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Give some name for the three simulations.</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>name1 <span class="ot">&lt;-</span> <span class="st">"reference"</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>name2 <span class="ot">&lt;-</span> <span class="st">"4deg_20percdrier"</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in data using the DBI package </span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>sqlite.driver <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a><span class="co"># We will work with "landscape" table and tree-scale data:</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>db1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file1) <span class="co"># connect to the file1</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>landscape1 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db1,<span class="st">"landscape"</span>)</span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db1) <span class="co"># disconnect to the file1</span></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>db2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite.driver, <span class="at">dbname =</span> file2) <span class="co"># connect to the file2</span></span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>landscape2 <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(db2,<span class="st">"landscape"</span>)</span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(db2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge the data from the three files together and make a column which tells which comes from which simulation, and study the table. The column “run” will support the plotting where we can use facets in ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>landscape <span class="ot">&lt;-</span> <span class="fu">rbind</span>(landscape1 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name1), </span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a> landscape2 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">run =</span> name2))</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(landscape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  year area area_100m species count_ha dbh_avg_cm height_avg_m  volume_m3
1    0    1         1    casa      152   12.96761     10.77155   9.465222
2    0    1         1    fasy       70   48.97035     27.82864 260.513423
3    0    1         1    pisy       33   52.05737     29.57999  91.870356
4    0    1         1    qupe       18   34.83232     17.83572  15.683124
5    1    1         1    casa      147   13.72713     11.31040  10.643544
6    1    1         1    fasy       70   50.20535     28.46379 268.968996
  total_carbon_kg     gwl_m3 basal_area_m2    NPP_kg NPPabove_kg       LAI
1        8041.268   9.465222      2.099428     0.000        0.00 0.3009711
2       80391.775 260.513423     15.847768     0.000        0.00 1.3974759
3       30694.307  91.870356      7.063300     0.000        0.00 0.8112550
4       10327.265  15.683124      1.791511     0.000        0.00 0.1830485
5        8550.914  10.987314      2.266547  2834.498     1765.12 0.3118849
6       84739.791 268.968996     16.383716 13024.190     8553.20 1.4546398
  cohort_count_ha       run
1               0 reference
2               0 reference
3               0 reference
4               0 reference
5               0 reference
6             229 reference</code></pre>
</div>
</div>
<p>We can see that the output is given for each year and each species in our 1ha area. Plot the living carbon (total_carbon_kg) in time, coloring by species. We give a unified species coloring in the beginning. Plot number of trees and mean diameter. Carbon and number of trees can be plotted in an additive way, but for mean dbh we do line plot per species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>cols.all<span class="ot">=</span><span class="fu">c</span>( <span class="st">"rops"</span><span class="ot">=</span><span class="st">"#e0e0e0"</span>,<span class="st">"acpl"</span><span class="ot">=</span><span class="st">"#A9A9A9"</span>,<span class="st">"alin"</span><span class="ot">=</span><span class="st">"#696969"</span>,<span class="st">"alvi"</span><span class="ot">=</span><span class="st">"#2e2e2e"</span>,</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a> <span class="st">"bepe"</span><span class="ot">=</span><span class="st">"#fadfad"</span>,<span class="st">"casa"</span><span class="ot">=</span><span class="st">"#7eeadf"</span>,<span class="st">"coav"</span><span class="ot">=</span><span class="st">"#20c6b6"</span>,<span class="st">"tipl"</span><span class="ot">=</span><span class="st">"#645394"</span>, </span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a> <span class="st">"ulgl"</span><span class="ot">=</span><span class="st">"#311432"</span>,<span class="st">"saca"</span><span class="ot">=</span><span class="st">"#D8BFD8"</span>,<span class="st">"soar"</span><span class="ot">=</span><span class="st">"#DDA0DD"</span>,<span class="st">"soau"</span><span class="ot">=</span><span class="st">"#BA55D3"</span>,</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a> <span class="st">"pice"</span><span class="ot">=</span><span class="st">"#D27D2D"</span>,<span class="st">"pini"</span><span class="ot">=</span><span class="st">"#a81c07"</span>,<span class="st">"algl"</span><span class="ot">=</span><span class="st">"#2ECBE9"</span>,<span class="st">"tico"</span><span class="ot">=</span><span class="st">"#128FC8"</span>, </span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a> <span class="st">"potr"</span><span class="ot">=</span><span class="st">"#00468B"</span>,<span class="st">"poni"</span><span class="ot">=</span><span class="st">"#5BAEB7"</span>,<span class="st">"frex"</span><span class="ot">=</span><span class="st">"#fe9cb5"</span>,<span class="st">"cabe"</span><span class="ot">=</span><span class="st">"#fe6181"</span>,</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a> <span class="st">"acps"</span><span class="ot">=</span><span class="st">"#fe223e"</span>,<span class="st">"lade"</span><span class="ot">=</span><span class="st">"#FFFE71"</span>,<span class="st">"abal"</span><span class="ot">=</span><span class="st">"#FFD800"</span>, <span class="st">"pisy"</span><span class="ot">=</span><span class="st">"#A4DE02"</span>,</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a> <span class="st">"fasy"</span><span class="ot">=</span><span class="st">"#76BA1B"</span>,<span class="st">"piab"</span><span class="ot">=</span><span class="st">"#006600"</span>,<span class="st">"quro"</span><span class="ot">=</span><span class="st">"#FF7F00"</span>, <span class="st">"qupe"</span><span class="ot">=</span><span class="st">"#FF9900"</span>, </span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a> <span class="st">"qupu"</span><span class="ot">=</span><span class="st">"#CC9900"</span>)</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We set here the order of the run categories for the table, to have the first</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a><span class="co">#run first and then the second. (left-right of the plots)</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>landscape<span class="sc">$</span>run<span class="ot">&lt;-</span><span class="fu">factor</span>( landscape<span class="sc">$</span>run, <span class="at">levels=</span><span class="fu">c</span>(name1,name2))</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the living carbon content, to have tonnes/ha, we divide total_carbon_kg by 1000.</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>g1<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, total_carbon_kg<span class="sc">/</span><span class="dv">1000</span> , <span class="at">fill=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Living C t/ha"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>g2<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, count_ha , <span class="at">fill=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_area</span>() <span class="sc">+</span></span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Number of trees per ha"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(g1,g2, <span class="at">ncol=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex78-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>g3<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(landscape, <span class="fu">aes</span>(year, dbh_avg_cm , <span class="at">color=</span><span class="fu">factor</span>(species)))<span class="sc">+</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values=</span>cols.all, <span class="at">guide=</span><span class="fu">guide_legend</span>(<span class="at">reverse=</span><span class="cn">TRUE</span>))<span class="sc">+</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run, <span class="at">nrow=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Mean dbh"</span>,<span class="at">fill =</span> <span class="st">"Species"</span>)<span class="sc">+</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(g3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex78-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that we do not have management intervention, and in the model trees shorter than 4m are not included in these outputs. However as they grow taller than 4m, model start to handle them as individual trees and including in these outputs which we are looking now.</p>
<p>At the end of the simulated 100 years, the total simulated carbon stock in living biomass under climate change scenario was slightly higher than under the reference climate. The proportion of beech has increased under both simulations. The number of trees increased in both cases after circa 25 years, but the increase was steeper under reference conditions. This increase caused by the regeneration.</p>
<p>Mean dbh of individual species reflected the development of the number of trees. The increase in the number of trees caused the reduction of mean dbh, e.g.&nbsp;of beech under both scenarios between 20 and 35 simulation years. The species-specific graphs for mean dbh indicates that some species do not have successful regeneration under the climate change scenario. Pine dbh decreased only under reference scenario, when we observed the increase of the number of trees, while under climate change scenario the mean dbh of pine was growing indicating the growth of remaining trees of the species at the plot. The small proportion of chestnut almost decrease to 0 under both scenarios, its dbh development does not show any successful regeneration processes.</p>
<p>Calculate the stored C amount in the initial year (year==0) and the last year (year==100)!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>livingC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>                         dplyr<span class="sc">::</span><span class="fu">group_by</span>(run) <span class="sc">|&gt;</span> </span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sum.livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(livingC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run sum.livingC
1        reference    129.4546
2 4deg_20percdrier    129.4546</code></pre>
</div>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>livingC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>                           dplyr<span class="sc">::</span><span class="fu">group_by</span>(run) <span class="sc">|&gt;</span> </span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">sum.livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(livingC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run sum.livingC
1        reference    441.6930
2 4deg_20percdrier    499.1578</code></pre>
</div>
</div>
<p>The initial conditions are same for the runs, but they are ending up at different C levels.</p>
<p>Calculate the stored C amount PER SPECIES in the initial year (year==0) and the last year (year==100)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>species.livingC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>                                 dplyr<span class="sc">::</span><span class="fu">group_by</span>(run, species) <span class="sc">|&gt;</span> </span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(species.livingC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species   livingC
1        reference    casa  8.041268
2        reference    fasy 80.391775
3        reference    pisy 30.694307
4        reference    qupe 10.327265
5 4deg_20percdrier    casa  8.041268
6 4deg_20percdrier    fasy 80.391775
7 4deg_20percdrier    pisy 30.694307
8 4deg_20percdrier    qupe 10.327265</code></pre>
</div>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>species.livingC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(landscape <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(year<span class="sc">==</span><span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>                                   dplyr<span class="sc">::</span><span class="fu">group_by</span>(run, species) <span class="sc">|&gt;</span> </span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a> dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">livingC=</span><span class="fu">sum</span>(total_carbon_kg<span class="sc">/</span><span class="dv">1000</span>)) )</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(species.livingC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species     livingC
1        reference    casa   0.2319933
2        reference    fasy 380.6997702
3        reference    pisy  44.2202121
4        reference    qupe  16.5410152
5 4deg_20percdrier    casa   1.5847763
6 4deg_20percdrier    fasy 392.4993454
7 4deg_20percdrier    pisy  66.8578057
8 4deg_20percdrier    qupe  38.2158285</code></pre>
</div>
</div>
<p>Calculate the species proportions based on the stored C amount in the initial year (year==0) and the last year (year==100) For this we need the total C amount and the species-specific C amount.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>LC0 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(species.livingC0, livingC0, <span class="at">by=</span><span class="st">"run"</span> )</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>LC0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(LC0 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">spec.prop=</span>livingC<span class="sc">/</span>sum.livingC, <span class="at">year=</span><span class="dv">0</span>))</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(LC0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species   livingC sum.livingC  spec.prop year
1        reference    casa  8.041268    129.4546 0.06211650    0
2        reference    fasy 80.391775    129.4546 0.62100355    0
3        reference    pisy 30.694307    129.4546 0.23710477    0
4        reference    qupe 10.327265    129.4546 0.07977518    0
5 4deg_20percdrier    casa  8.041268    129.4546 0.06211650    0
6 4deg_20percdrier    fasy 80.391775    129.4546 0.62100355    0
7 4deg_20percdrier    pisy 30.694307    129.4546 0.23710477    0
8 4deg_20percdrier    qupe 10.327265    129.4546 0.07977518    0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>LC100 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(species.livingC100, livingC100, <span class="at">by=</span><span class="st">"run"</span> )</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>LC100 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(LC100 <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">spec.prop=</span>livingC<span class="sc">/</span>sum.livingC, <span class="at">year=</span><span class="dv">100</span>))</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(LC100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               run species     livingC sum.livingC    spec.prop year
1        reference    casa   0.2319933    441.6930 0.0005252366  100
2        reference    fasy 380.6997702    441.6930 0.8619103723  100
3        reference    pisy  44.2202121    441.6930 0.1001152679  100
4        reference    qupe  16.5410152    441.6930 0.0374491232  100
5 4deg_20percdrier    casa   1.5847763    499.1578 0.0031749006  100
6 4deg_20percdrier    fasy 392.4993454    499.1578 0.7863232430  100
7 4deg_20percdrier    pisy  66.8578057    499.1578 0.1339412339  100
8 4deg_20percdrier    qupe  38.2158285    499.1578 0.0765606224  100</code></pre>
</div>
</div>
<p>Put the two tables together and visualize the results!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>LC <span class="ot">&lt;-</span> <span class="fu">rbind</span>(LC0,LC100)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>LC<span class="sc">$</span>run <span class="ot">&lt;-</span> <span class="fu">factor</span>(LC<span class="sc">$</span>run, <span class="at">levels=</span><span class="fu">c</span>(name1,name2))</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(LC, <span class="fu">aes</span>(<span class="at">fill=</span>species, <span class="at">y=</span>livingC , <span class="at">x=</span><span class="fu">factor</span>(year))) <span class="sc">+</span> </span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_bar</span>(<span class="at">position=</span><span class="st">"stack"</span>, <span class="at">stat=</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all)<span class="sc">+</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run)<span class="sc">+</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Living C absolute values"</span>)<span class="sc">+</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex82-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(LC, <span class="fu">aes</span>(<span class="at">fill=</span>species, <span class="at">y=</span>spec.prop, <span class="at">x=</span><span class="fu">factor</span>(year))) <span class="sc">+</span> </span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">geom_bar</span>(<span class="at">position=</span><span class="st">"stack"</span>, <span class="at">stat=</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span>cols.all)<span class="sc">+</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="sc">~</span>run)<span class="sc">+</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">"Species proportion based on carbon"</span>)<span class="sc">+</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a> ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/ex82-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The living C stock tripled over 100 years due to the accumulation of biomass in trees and no management interventions and reached higher level under the climate change scenario. Both cases the proportion of beech increased.</p>
</section>
</section>
</section>
<section id="sec-em" class="level1">
<h1>Empirical modeling</h1>
<p>In the empirical modelling we will cover two examples of creating two models based on observed data. We will use two approaches Generalized Linear Models (GLMs) and Boosted Regression trees (BRTs). Please take all the results with a grain of salt, we are making very generalized statements from a limited data set, and we are not getting into the details of how each of the models should be assessed; the goal here is that you learn how observed data can be used to create models that help you to understand the data and relationships better.</p>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>We will work with one dataset derived from the inventory developed to assess forest structure and deadwood properties of six representative forest areas in the Czech Republic <span class="citation" data-cites="hosek">(<a href="#ref-hosek" role="doc-biblioref">Hošek, n.d.</a>)</span>. This dataset collects observations of the presence /absence of certain species of biodiversity importance across 99 plots.</p>
<p>The data was collected from square sampling plots (2500 m2 each) in six forested Czech Republic regions. These regions are representative of the main bio-regions and elevation range of forests, considering their importance in territorial representation, forestry, and ecology. The inventory sampled for biodiversity variables such as the presence/absence of different species of birds, Tracheophyta, bryophytes, fungi, lichens, and beetles.</p>
<p>The dataset has been generously provided by Jeňýk Hofmeister at the Czech University of Life Sciences Prague (jenyk.hofmeister@email.cz) to be used in the context of this exercise. It should not be used for other purposes or be further distributed. If you want to use this data or learn more about it, please get in touch with Jeňýk Hofmeisterhere: jenyk.hofmeister@email.cz.</p>
<p>The data you can download for this exercise is an aggregated summary of the original data, some aspects have been modified from the observed data, so the results you will obtain will only partially match the observed reality. This data is very similar in structure and observed variables to the one you collected in this summer school. The idea is to move from data collection, analysis to this part, where you use the data to create a model.</p>
<section id="sec-dataDescription" class="level3">
<h3 class="anchored" data-anchor-id="sec-dataDescription">Data description</h3>
<p>These are the variables available in the data</p>
<ul>
<li><code>longitud</code>: longitude of the plot location</li>
<li><code>latitude</code>: latitude of the plot location</li>
<li><code>forestManagementType</code>: forest management type applied in this plot</li>
<li><code>forestStructure</code>: current forest structure in the plot</li>
<li><code>slope</code>: slope of the plot</li>
<li><code>A.pseudoplatanus</code>: proportion of this tree species in the plot in volume</li>
<li><code>F.sylvatica</code>: proportion of this tree species in the plot in volume</li>
<li><code>L.decidua</code>: proportion of this tree species in the plot in volume</li>
<li><code>Q.robur</code>: proportion of this tree species in the plot in volume</li>
<li><code>S.aucuparia</code> : proportion of this tree species in the plot in volume</li>
<li><code>B.pendula</code>: proportion of this tree species in the plot in volume</li>
<li><code>P.abies</code>: proportion of this tree species in the plot in volume</li>
<li><code>P.sylvestris</code>: proportion of this tree species in the plot in volume</li>
<li><code>F.excelsior</code>: proportion of this tree species in the plot in volume</li>
<li><code>A.alba</code>: proportion of this tree species in the plot in volume</li>
<li><code>A.platanoides</code>: proportion of this tree species in the plot in volume</li>
<li><code>T.cordata</code>: proportion of this tree species in the plot in volume</li>
<li><code>S.racemosa</code>: proportion of this tree species in the plot in volume</li>
<li><code>U.glabra</code>: proportion of this tree species in the plot in volume</li>
<li><code>S.nigra</code>: proportion of this tree species in the plot in volume</li>
<li><code>P.alba</code>: proportion of this tree species in the plot in volume</li>
<li><code>U.minor</code>: proportion of this tree species in the plot in volume</li>
<li><code>S.caprea</code>: proportion of this tree species in the plot in volume</li>
<li><code>C.betulus</code>: proportion of this tree species in the plot in volume</li>
<li><code>P.nigra</code>: proportion of this tree species in the plot in volume</li>
<li><code>Q.petraea</code>: proportion of this tree species in the plot in volume</li>
<li><code>S.torminalis</code>: proportion of this tree species in the plot in volume</li>
<li><code>A.campestre</code>: proportion of this tree species in the plot in volume</li>
<li><code>P.strobus</code>: proportion of this tree species in the plot in volume</li>
<li><code>Q.rubra</code>: proportion of this tree species in the plot in volume</li>
<li><code>volAllha</code>: total volume in the plot</li>
<li><code>GiniDBH</code>: Gini index calculated to assess the forest structural diversity in diameter sizes, higher values indicate more structural heterogeneity; lower values indicate more homogeneous stands</li>
<li><code>ShannonIndexTreeSpp</code>: The Shannon index is way to measure the diversity of tree species in the plot</li>
<li><code>Tracheophyta_rich</code>: Species richness across Tracheophyta species</li>
<li><code>Birds_rich</code>: Species richness across Birds species</li>
<li><code>Bryophytes_rich</code> : Species richness across Bryophytes species</li>
<li><code>Fungi_rich</code>: Species richness across Fungi species</li>
<li><code>Lichens_rich</code>: Species richness across Lichens species</li>
<li><code>Beetles_rich</code>: Species richness across Beetles species</li>
<li><code>dendrocoposMajor</code>: presence / absence of Dendrocopos major</li>
<li><code>certhia</code>: presence / absence of Certhia familiaris</li>
<li><code>bryophitaNumObs</code>: number of observed Bryophytes species</li>
<li><code>birdNumObs</code>: number of observed Bird species</li>
<li><code>PlotID</code>: ID number for the plot</li>
</ul>
</section>
</section>
<section id="species-description" class="level2">
<h2 class="anchored" data-anchor-id="species-description">Species description</h2>
<section id="species-1---bryophytes" class="level3">
<h3 class="anchored" data-anchor-id="species-1---bryophytes">Species 1 - Bryophytes</h3>
<p>Bryophytes constitute an important and permanent component of the forest flora and diversity. They colonize various substrates, which are unsuitable for vascular plants, because of low light intensity or low nutrient level, such as deadwood, bark, rocks, and open soil. They provide shelter habitats, food, and nest material for many animals.</p>
<p>In forests, different ecological guilds of Bryophytes can be distinguished by the substrate on which they are growing, including terricolous, lignicolous, corticolous and saxicolous species that occur on soil, deadwood, bark of living trees and shrubs, or rocks, respectively. As diversity and quality of these substrates is affected by forest management, Bryophytes are suitable indicators for the effect of management on forest conditions. Especially typical woodland Bryophytes, which are strictly depending on forest conditions. It is interesting to better understand the relation of forest management effects on Bryophytes and some studies have already demonstrated their sensitivity to management practices.</p>
</section>
<section id="species-2---great-spotted-woodpecker" class="level3">
<h3 class="anchored" data-anchor-id="species-2---great-spotted-woodpecker">Species 2 - Great spotted woodpecker</h3>
<p>The&nbsp;great spotted woodpecker&nbsp;(<em>Dendrocopos major</em>) is a medium-sized&nbsp;woodpecker&nbsp;with pied black and white plumage and a red patch on the lower belly. It is found in a wide variety of woodlands,&nbsp;broadleaf,&nbsp;coniferous or mixed forests. The great spotted woodpecker spends much of its time climbing trees. It a quite generalist bird species.</p>
</section>
<section id="species-3---eurasian-treecreeper" class="level3">
<h3 class="anchored" data-anchor-id="species-3---eurasian-treecreeper">Species 3 - Eurasian treecreeper</h3>
<p>The Eurasian treecreeper or common treecreeper (<em>Certhia familiaris</em>) is a small passerine bird. It prefers mature trees, and in most of Europe, it tends to be found mainly in coniferous forest, especially spruce and fir.</p>
</section>
</section>
<section id="models" class="level2">
<h2 class="anchored" data-anchor-id="models">Models</h2>
<section id="generalized-linear-models-glms" class="level3">
<h3 class="anchored" data-anchor-id="generalized-linear-models-glms">Generalized Linear Models (GLMs)</h3>
<p>We propose to use a generalized linear model (GLM) to understand the abundance of different Bryophytes species in the 99 plots. Count data often conform to a Poisson distribution; in this case, we have a count of the number of species recorded at each plot.</p>
<p>Fitting a Poisson GLM in R is similar to analyzing covariance (or linear model), except that we now need to use the glm function. To run a GLM, we need to provide one extra piece of information beyond that required for a linear model: the family of models we want to use. In this case, we want a Poisson family, family=poisson.</p>
</section>
<section id="sec-modelBRT" class="level3">
<h3 class="anchored" data-anchor-id="sec-modelBRT">Boosted regression trees (BRTs)</h3>
<p>Boosted regression trees (BRT) are a combination of two powerful statistical techniques: boosting and regression trees. Boosting is a machine learning technique similar to model averaging, where the results of several competing models are merged. Unlike model averaging, however, boosting uses a forward, stage-wise procedure, where tree models are fitted iteratively to a subset of the training data. Subsets of the training data used at each iteration of the model fit are randomly selected without replacement, where the proportion of the training data used is determined by the modeler, this is defined with the “bag fraction” parameter. This procedure, known as stochastic gradient boosting, introduces an element of stochasticity that improves model accuracy and reduces overfitting <span class="citation" data-cites="elith2008">(<a href="#ref-elith2008" role="doc-biblioref">Elith, Leathwick, and Hastie 2008</a>)</span>.</p>
<p>The BRT model calibration is defined by four parameters:</p>
<ul>
<li><p>the <code>learning rate</code> (or shrinkage parameter): The learning rate determines the contribution of each new tree to the growing model, and it is always substantially lower than 1, higher values being related to faster learning.</p></li>
<li><p>the <code>bag fraction</code>: The bag fraction provides in- formation on which fraction of the entire data should be drawn randomly to fit the new tree. This parameter includes a random probabilistic component, making each run model different, and is aimed at improving model accuracy, speed of model creation, and the reduction of overfitting <span class="citation" data-cites="friedman">(<a href="#ref-friedman" role="doc-biblioref">Friedman, Hastie, and Tibshirani, n.d.</a>)</span>.</p></li>
<li><p>the <code>tree complexity</code>: Tree complexity controls the number of fitted interactions among variables, and determines the number of splits in each tree; for example, a value of 1 will present only one split, meaning that the model does not consider interactions; a value of 2 will result in two splits, and two interactions.</p></li>
<li><p>The <code>number of trees</code> required for optimal prediction: The optimal number of trees is selected based on the three previous parameters. The values fitted by the final model are computed as the sum of all of the predictions of the trees, multiplied by their respective learning rates.</p></li>
</ul>
</section>
</section>
<section id="the-exercise" class="level2">
<h2 class="anchored" data-anchor-id="the-exercise">The exercise</h2>
<section id="the-project-folder" class="level3">
<h3 class="anchored" data-anchor-id="the-project-folder">The project folder</h3>
<p>All the project is available in a github repository. You can download the project with this document, code, the <code>.rproj</code> and the correct folder structure in <a href="https://github.com/oldiya/summerSchoolExercise">here [2]</a>.</p>
<p>[2] https://github.com/oldiya/summerSchoolExercise</p>
<p>In this project you will find a folder called <code>code</code> where the codes for each question are stored. A folder called <code>data</code> is where you have to store the data that you have downloaded. A folder called <code>exercise</code> contains this document and all the required files to build it.</p>
</section>
<section id="download-the-data" class="level3">
<h3 class="anchored" data-anchor-id="download-the-data">Download the data</h3>
<p>You can download the data in <a href="https://polybox.ethz.ch/index.php/s/qERYKjzmFTr81Sq">here [1]</a></p>
<p>[1] https://polybox.ethz.ch/index.php/s/qERYKjzmFTr81Sq</p>
<p>Our recommendation is that you follow this folder structure and you put the data in the folder data of the project and the <code>.rproj</code> into the main folder. If you decide to organize things in a different way then you will have to change the path to the code provided to load the data in the section “Explore the data”</p>
<p><img src="images/folderStruc.png" class="img-fluid" width="300"></p>
</section>
<section id="explore-the-data" class="level3">
<h3 class="anchored" data-anchor-id="explore-the-data">Explore the data</h3>
<p>You can load the data in R by doing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>observations <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/observations.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once you have obtained the data, your next step is to explore it. It is important to carefully analyze the structure of the data and understand its meaning. Each variable must be examined closely, along with the data structure. Remember that each row in this dataset represents one plot, identified by its <code>PlotID</code>, and each column represents one variable.</p>
<p>You can explore each of the variables by doing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(observations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   99 obs. of  45 variables:
 $ X                   : int  1 2 3 4 5 6 7 8 9 10 ...
 $ longitud            : num  13.5 13.5 13.5 13.6 13.6 ...
 $ latitude            : num  49.5 49.5 49.5 49.5 49.5 ...
 $ forestManagementType: chr  "simple clearcutting" "simple clearcutting" "simple clearcutting" "simple clearcutting" ...
 $ forestStructure     : chr  "even-aged" "even-aged" "even-aged" "even-aged" ...
 $ slope               : num  16.85 6.51 4.91 5.55 14.55 ...
 $ A.pseudoplatanus    : int  0 0 0 0 0 4 1 7 16 0 ...
 $ F.sylvatica         : int  61 0 0 100 0 82 85 91 75 0 ...
 $ L.decidua           : int  38 0 0 0 4 6 0 0 0 0 ...
 $ Q.robur             : int  0 1 0 0 0 0 0 0 0 0 ...
 $ S.aucuparia         : int  0 0 0 0 0 0 0 0 0 0 ...
 $ B.pendula           : int  0 0 1 0 28 0 0 0 0 0 ...
 $ P.abies             : int  0 99 93 0 30 0 0 0 8 99 ...
 $ P.sylvestris        : int  0 0 7 0 1 0 0 0 0 0 ...
 $ F.excelsior         : int  0 0 0 0 38 0 0 0 0 0 ...
 $ A.alba              : int  0 0 0 0 0 4 0 0 0 1 ...
 $ A.platanoides       : int  0 0 0 0 0 2 2 2 0 0 ...
 $ T.cordata           : int  0 0 0 0 0 2 12 0 0 0 ...
 $ S.racemosa          : int  0 0 0 0 0 0 0 0 0 0 ...
 $ U.glabra            : int  0 0 0 0 0 0 0 0 1 0 ...
 $ S.nigra             : int  0 0 0 0 0 0 0 0 0 0 ...
 $ P.alba              : int  0 0 0 0 0 0 0 0 0 0 ...
 $ U.minor             : int  0 0 0 0 0 0 0 0 0 0 ...
 $ S.caprea            : int  0 0 0 0 0 0 0 0 0 0 ...
 $ C.betulus           : int  0 0 0 0 0 0 0 0 0 0 ...
 $ P.nigra             : int  0 0 0 0 0 0 0 0 0 0 ...
 $ Q.petraea           : int  0 0 0 0 0 0 0 0 0 0 ...
 $ S.torminalis        : int  0 0 0 0 0 0 0 0 0 0 ...
 $ A.campestre         : int  0 0 0 0 0 0 0 0 0 0 ...
 $ P.strobus           : int  0 0 0 0 0 0 0 0 0 0 ...
 $ Q.rubra             : int  0 0 0 0 0 0 0 0 0 0 ...
 $ volAllha            : num  592 377 438 615 194 ...
 $ GiniDBH             : num  0.448 0.416 0.12 0.133 0.378 ...
 $ ShannonIndexTreeSpp : num  0.68 0.07 0.28 0 1.28 0.78 0.54 0.39 0.75 0.06 ...
 $ Tracheophyta_rich   : num  0.218 0.233 0.209 0.189 0.354 ...
 $ Birds_rich          : num  0.358 0.46 0.485 0.307 0.383 ...
 $ Bryophytes_rich     : num  0.0876 0.0876 NA 0.2629 0.3505 ...
 $ Fungi_rich          : num  0.199 0.133 0.114 0.218 0.262 ...
 $ Lichens_rich        : num  0.0659 0.1976 0.1318 0.1537 0.1537 ...
 $ Beetles_rich        : num  0.16 0.16 0.234 0.258 0.221 ...
 $ dendrocoposMajor    : int  1 1 1 0 1 1 1 1 1 1 ...
 $ certhia             : int  0 0 0 0 0 0 1 0 1 0 ...
 $ bryophitaNumObs     : int  1 1 0 3 4 5 7 4 7 1 ...
 $ birdNumObs          : int  14 18 19 12 15 14 12 14 18 18 ...
 $ PlotID              : int  1 2 3 4 5 6 7 8 9 10 ...</code></pre>
</div>
</div>
<p>You have a description of each of the variables in the section <a href="#sec-dataDescription">Section&nbsp;3.1.1</a>.</p>
<p>You could do further analysis by exploring the data correlations and you can even plot them to explore their values and ranges better. During this process you should start thinking:</p>
<ul>
<li>What am I trying to understand with this model? (your question)</li>
<li>What variables are important to answer my question?</li>
</ul>
<p>You could for example explore the behavior of the variables by plotting a scatterplot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(<span class="sc">~</span>F.sylvatica <span class="sc">+</span> P.sylvestris <span class="sc">+</span> latitude <span class="sc">+</span> volAllha <span class="sc">+</span>  GiniDBH <span class="sc">+</span> ShannonIndexTreeSpp <span class="sc">+</span> Bryophytes_rich, </span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> observations, <span class="at">main =</span> <span class="st">"Scatterplot Matrix"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/explore%20data%202-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>You can also create individual scatterplots or histograms for a variable of interest, for example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Divide the screen in 1 line and 3 columns</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">oma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>)) </span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Make the margin around each graph a bit smaller</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram and Scatterplot</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(observations<span class="sc">$</span>bryophitaNumObs, <span class="at">main =</span> <span class="st">""</span>, <span class="at">breaks =</span> <span class="dv">10</span>,</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">rgb</span>(<span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">0.4</span>) , </span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Number of observed bryophita"</span>)</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">y =</span> observations<span class="sc">$</span>bryophitaNumObs, </span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">x =</span> observations<span class="sc">$</span>GiniDBH,</span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">""</span> , <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">cex =</span> <span class="fl">0.4</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">0.4</span>), </span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Ginni index"</span>, <span class="at">ylab =</span> <span class="st">"Number of observed bryophita"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/example%20scatterplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="sec-C_1" class="level3">
<h3 class="anchored" data-anchor-id="sec-C_1">Question C - Group 1</h3>
<ul>
<li>Does a more diverse forest in structure and composition have more Bryophytes species?</li>
</ul>
<section id="sec-C_1_fit" class="level4">
<h4 class="anchored" data-anchor-id="sec-C_1_fit">Fitting a Poisson GLM in R</h4>
<p>During your data exploration, you should have selected your response variable, <code>bryophitaNumObs</code>. In this case, since we are trying to understand forest structure and composition, you should also choose explanatory variables for that, such as <code>GiniDBH,</code> which indicates the forest structural diversity in diameter sizes; higher values indicate more structural heterogeneity, and lower values indicate more homogeneous stands, or the <code>ShannonIndexTreeSpp</code> which assesses the diversity of tree species in the plot.</p>
<p>We could start by only looking at how the forest structural diversity affects the number of Bryophyte species that we have in a plot. You can create a GLM model with <code>bryophitaNumObs</code> as the response variable and <code>GiniDBH</code> as an explanatory variable. You will use the function glm in R and the <code>family = poisson</code>. You can see how to create and see this model here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>bryoModel1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(bryophitaNumObs <span class="sc">~</span> GiniDBH,</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> poisson,</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> observations)</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bryoModel1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = bryophitaNumObs ~ GiniDBH, family = poisson, data = observations)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   0.4627     0.1388   3.333 0.000859 ***
GiniDBH       2.2797     0.4221   5.401 6.64e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 188.58  on 98  degrees of freedom
Residual deviance: 159.92  on 97  degrees of freedom
AIC: 424.2

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Here you can see that the coefficient table produced by a GLM is very similar to a linear model. The intercept tells us the estimated value of the response variable when the continuous explanatory variables (here, just the Gini index) has a value of 0. We then also have coefficients describing the slope of the relationship with our continuous explanatory variables. We can see here that the number of Bryophytes species appears to show a positive relationship with the Gini index, which means that increasing structural diversity in tree diameter sizes has a positive relationship with the number of Bryophytes species in the plot.</p>
<p>We are also interested in understanding the relationship of the number of Bryophytes species and the tree species diversity; we can now try to add this variable into the model and see if it helps us to understand things. You can do that by adding the variable <code>ShannonIndexTreeSpp</code> to the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>bryoModel2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(bryophitaNumObs <span class="sc">~</span> GiniDBH <span class="sc">+</span> ShannonIndexTreeSpp,</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> poisson,</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> observations)</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bryoModel2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = bryophitaNumObs ~ GiniDBH + ShannonIndexTreeSpp, 
    family = poisson, data = observations)

Coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          0.45277    0.14060   3.220  0.00128 ** 
GiniDBH              2.17411    0.46413   4.684 2.81e-06 ***
ShannonIndexTreeSpp  0.09209    0.16202   0.568  0.56977    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 188.58  on 98  degrees of freedom
Residual deviance: 159.60  on 96  degrees of freedom
AIC: 425.88

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Here we can see that the variable Shannon index also has a positive relationship with the number of Bryophytes species in the plot, but its effect is much smaller. We can also observe that this variable is not significant. This does not mean it is wrong to add this variable because we want to understand its effect, but keeping this variable in the model depends on what you’re trying to do and what “reality” is. Adding variables that are not significant will not help your model (particularly your estimates) but also might not matter much (e.g., predictions). However, removing actual variables can create a useless model even if they don’t meet significance.</p>
<p>Variable selection is a long and complicated topic. Some general rules of thumb include: (1) Include the variable if it is of interest, (2) Include the variable if you have some prior knowledge that it should be relevant. This can be misleading because it’s a confirmation bias, but in most cases, this makes sense. (3) If you want a model that can generalize many cases, you should favor fewer variables.</p>
</section>
<section id="explanatory-power-of-the-model" class="level4">
<h4 class="anchored" data-anchor-id="explanatory-power-of-the-model">Explanatory Power of the model</h4>
<p>When we ran linear models, we used the coefficient of determination, or R<sup>2</sup>&nbsp;to assess how much of the variability in our response variable is explained by a given model. R<sup>2</sup>&nbsp;is based on the sums of squares of our model, and so cannot be calculated for GLMs. Instead, we can calculate the deviance explained by our model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the null and residual deviance from the model</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>dev.null <span class="ot">&lt;-</span> bryoModel1<span class="sc">$</span>null.deviance</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>dev.resid <span class="ot">&lt;-</span> bryoModel1<span class="sc">$</span>deviance</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the deviance explained by the model</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>dev.explained <span class="ot">&lt;-</span> (dev.null <span class="sc">-</span> dev.resid)<span class="sc">/</span>dev.null</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Round to 3 decimal places</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>dev.explained <span class="ot">&lt;-</span> <span class="fu">round</span>(dev.explained, <span class="dv">3</span>)</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>dev.explained</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.152</code></pre>
</div>
</div>
<p>Variability in forest structure (Gini index) explain 15% of the variation in Bryophytes species richness in this study. That is an ok explanatory power for a very simple model of a complex ecological system (many factors determine the species richness for Bryophytes and we are attempting to explain everything with just one variable).</p>
</section>
<section id="model-assumptions" class="level4">
<h4 class="anchored" data-anchor-id="model-assumptions">Model Assumptions</h4>
<p>For Poisson GLMs, there is one further assumption that we have not encountered before. If data follow a Poisson distribution, then the mean of the distribution is equal to the variance. Accordingly, a Poisson distribution is represented by just one parameter <span class="math inline">\(\lambda\)</span>, which describes both the mean and the variance of the distribution.</p>
<p>Count data in ecology are often&nbsp;<strong>overdispersed</strong>, where the variance is greater than the mean. This violates the assumption of a Poisson GLM, and means that any statistics that we calculate from the model may be unreliable.</p>
<p>We can get look whether a model is over-dispersed by inspecting the model summary as you did in <a href="#sec-C_1_fit">Section&nbsp;3.4.4.1</a>. As a rule of thumb, if the response variable conforms to a true Poisson distribution, we expect the residual deviance to be approximately equal to the residual degrees of freedom. If the deviance is much greater than the degrees of freedom, this indicates over-dispersion. This is the case in our models (see outputs from running the code in <a href="#sec-C_1_fit">Section&nbsp;3.4.4.1</a>).</p>
<p>To check the model assumptions in a GLM is not as straight forward as with a linear model. This is because classical residuals are not expected to behave in the same way for GLMs. We can use the DHARMa package in R for working with GLMs, which uses a simulation-based approach to compare the residuals from the actual model with the expectation if the model is behaving normally:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate residuals </span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>simResids <span class="ot">&lt;-</span> DHARMa<span class="sc">::</span><span class="fu">simulateResiduals</span>(bryoModel1)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate plots to compare the model residuals to expectations</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simResids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/model%20assumptions1-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>These plots show us that this model is not behaving as we would expect in terms of homogeneity of variance and distribution of residuals. A follow up to this would be to try alternatives to deal with over-dispersed count data in GLMs such as fit a quasi-Poisson GLM or a negative binomial GLM. Unfortunately we do not have time to continuou in this exercise.</p>
</section>
</section>
<section id="sec-D_1" class="level3">
<h3 class="anchored" data-anchor-id="sec-D_1">Question D - Group 1</h3>
<ul>
<li>Is the number of Briophites species affected by forest management type and the forest structural diversity?</li>
</ul>
<section id="sec-D_1_fit" class="level4">
<h4 class="anchored" data-anchor-id="sec-D_1_fit">Fitting a Poisson GLM in R</h4>
<p>Fitting a Poisson GLM in R is very similar to fitting an analysis of covariance (or linear model), except that now we need to use the glm function. To run a GLM, we need to provide one extra piece of information beyond that needed for a linear model: the family of model we want to use. In this case, we want a Poisson family.</p>
<p>We could start by only looking at how the forest structural diversity affects the number Bryophytes species that we have in a plot. You can do this by creating a GLM model which has <code>bryophitaNumObs</code> as response variable and <code>GiniDBH</code> as explanatory variable. For that you will use the function <code>glm</code> in R and use the <code>family = poisson</code>. You can see how to create and see this model here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>bryoModel1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(bryophitaNumObs <span class="sc">~</span> GiniDBH,</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> poisson,</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> observations)</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bryoModel1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = bryophitaNumObs ~ GiniDBH, family = poisson, data = observations)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   0.4627     0.1388   3.333 0.000859 ***
GiniDBH       2.2797     0.4221   5.401 6.64e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 188.58  on 98  degrees of freedom
Residual deviance: 159.92  on 97  degrees of freedom
AIC: 424.2

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Here you can see that the coefficient table produced by a GLM is very similar to a linear model. The intercept tells us the estimated value of the response variable when the continuous explanatory variables (here just Gini index) have a value of 0. We then also have coefficients describing the slope of the relationship with our continuous explanatory variables. We can see here that the bryophita numbers appears to show a positive relationship with Gini index, which means that increasing structural diversity in trees diameter sizes has a positive relationship with the number of bryophita species in the plot.</p>
<p>We are also interested in understanding the relationship of the number of observed Bryophytes species and forest management, we can now try to add this variable into the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>bryoModel2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(bryophitaNumObs <span class="sc">~</span> forestManagementType,</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> poisson,</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> observations)</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bryoModel2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = bryophitaNumObs ~ forestManagementType, family = poisson, 
    data = observations)

Coefficients:
                                        Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                               0.9651     0.1543   6.254 3.99e-10
forestManagementTypesimple clearcutting  -0.1335     0.1750  -0.763    0.445
forestManagementTypeunmanaged             0.7633     0.1821   4.192 2.76e-05
                                           
(Intercept)                             ***
forestManagementTypesimple clearcutting    
forestManagementTypeunmanaged           ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 188.58  on 98  degrees of freedom
Residual deviance: 141.54  on 96  degrees of freedom
AIC: 407.82

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>The intercept here tells us the estimated value of the response variable when the reference groups in our grouping (categorical) variables (here for retention clear-cutting). We then also have coefficients describing the slope of the relationship with our continuous explanatory variables, and coefficients giving the estimated difference in the response variable for non-reference groupings. We can see here that number of bryophites species appears to show a negative relationship with simple clearcutting, and appears to have a positive relationship with unmanaged and retention clear-cutting.</p>
<p>The type simple clearcutting appears to be non significant, which only tells us about the&nbsp;pairwise differences between the levels. To test whether the categorical predictor, as a whole, is significant is equivalent to testing whether there is any heterogeneity in the means of the levels of the predictor. When there are no other predictors in the model, this is a classical&nbsp;<a href="http://en.wikipedia.org/wiki/Analysis_of_variance">ANOVA</a> problem.</p>
</section>
<section id="explanatory-power-of-the-model-1" class="level4">
<h4 class="anchored" data-anchor-id="explanatory-power-of-the-model-1">Explanatory Power of the model</h4>
<p>When we run linear models, we use the coefficient of determination, or R<sup>2</sup>&nbsp;to assess how much of the variability in our response variable is explained by a given model. R<sup>2</sup>&nbsp;is based on the sums of squares of our model, and so it cannot be calculated for GLMs. Instead, we can calculate the the deviance explained by our model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the null and residual deviance from the model</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>dev.null <span class="ot">&lt;-</span> bryoModel1<span class="sc">$</span>null.deviance</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>dev.resid <span class="ot">&lt;-</span> bryoModel1<span class="sc">$</span>deviance</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the deviance explained by the model</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>dev.explained <span class="ot">&lt;-</span> (dev.null <span class="sc">-</span> dev.resid)<span class="sc">/</span>dev.null</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Round to 3 decimal places</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>dev.explained <span class="ot">&lt;-</span> <span class="fu">round</span>(dev.explained, <span class="dv">3</span>)</span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>dev.explained</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.152</code></pre>
</div>
</div>
<p>Variability in forest structure (Gini index) explains 15% of the variation in bryophita species richness in this study system. That is an ok explanatory power for a very simple model of a complex ecological system (many factors determine the species richness of bryophitas and we are attempting to explain everything with one variable).</p>
</section>
<section id="model-assumptions-1" class="level4">
<h4 class="anchored" data-anchor-id="model-assumptions-1">Model Assumptions</h4>
<p>For Poisson GLMs, there is one further assumption that we have not encountered before. If data follow a Poisson distribution, then the mean of the distribution is equal to the variance. Accordingly, a Poisson distribution is represented by just one parameter <span class="math inline">\(\lambda\)</span>, which describes both the mean and the variance of the distribution.</p>
<p>Count data in ecology are often&nbsp;<strong><em>overdispersed</em></strong>, where the variance is greater than the mean. This violates the assumption of a Poisson GLM, and means that any statistics that we calculate from the model may be unreliable.</p>
<p>We can get look whether a model is over-dispersed by inspecting the model summary as you did in <a href="#sec-D_1_fit">Section&nbsp;3.4.5.1</a>. As a rule of thumb, if the response variable conforms to a true Poisson distribution, we expect the residual deviance to be approximately equal to the residual degrees of freedom. If the deviance is much greater than the degrees of freedom, this indicates over-dispersion. This is the case in our models (see outputs from running the code in <a href="#sec-D_1_fit">Section&nbsp;3.4.5.1</a>).</p>
<p>To check the model assumptions in a GLM is not as straight-forward as with a linear model. This is because classical residuals are not expected to behave in the same way for GLMs. We can use the DHARMa package in R for working with GLMs, which uses a simulation-based approach to compare the residuals from the actual model with the expectation if the model is behaving normally.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate residuals </span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>simResids <span class="ot">&lt;-</span> DHARMa<span class="sc">::</span><span class="fu">simulateResiduals</span>(bryoModel1)</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate plots to compare the model residuals to expectations</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simResids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/model%20assumptions2%20-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>These plots show us that this model is not behaving as we would expect in terms of homogeneity of variance and distribution of residuals. A follow up to this would be to try alternatives to deal with over-dispersed count data in GLMs such as fit a quasi-Poisson GLM or a negative binomial GLM. Unfortunately we do not have to continue in this exercise.</p>
</section>
</section>
<section id="sec-C_2" class="level3">
<h3 class="anchored" data-anchor-id="sec-C_2">Question C - Group 2</h3>
<ul>
<li>Does a more diverse forest in structure and composition have more bird species?</li>
</ul>
<section id="sec-C_2_fit" class="level4">
<h4 class="anchored" data-anchor-id="sec-C_2_fit">Fitting a Poisson GLM in R</h4>
<p>During your data exploration you should have selected your response variable: <code>birdNumObs</code>. In this case since we are trying to understand forest structure and composition you should also select explanatory variables for that such as <code>GiniDBH</code> which indicates the forest structural diversity in diameter sizes, higher values indicate more structural heterogeneity and lower values indicate more homogeneous stands, or the <code>ShannonIndexTreeSpp</code> which assess the diversity of tree species in the plot.</p>
<p>We could start by only looking at how the forest structural diversity affects the number bird species that we have in a plot. You can do this by creating a GLM model which has <code>birdNumObs</code> as response variable and <code>GiniDBH</code> as explanatory variable. For that you will use the function <code>glm</code>in R and use the <code>family = poisson</code>. You can see how to create and see this model here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>birdModel1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(birdNumObs <span class="sc">~</span> GiniDBH,</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> poisson,</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> observations)</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(birdModel1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = birdNumObs ~ GiniDBH, family = poisson, data = observations)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.63827    0.05636  46.809   &lt;2e-16 ***
GiniDBH      0.42725    0.19030   2.245   0.0248 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 59.277  on 98  degrees of freedom
Residual deviance: 54.280  on 97  degrees of freedom
AIC: 511.57

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>Here you can see that the coefficient table produced by a GLM is very similar to a linear model. The intercept tells us the estimated value of the response variable when the continuous explanatory variables (here just Gini index) has a value of 0. We then also have coefficients describing the slope of the relationship with our continuous explanatory variables. We can see here that the number of bird species appears to show a positive relationship with Gini index, which means that increasing structural diversity in trees diameter sizes has a positive relationship with the number of bird species in the plot.</p>
<p>We are also interested in understanding the relationship of the number of bird species and the trees species diversity, we can now try to add this variable into the model and see if it help us to understand things. You can do that by adding the variable <code>ShannonIndexTreeSpp</code> into the model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>birdModel2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(birdNumObs <span class="sc">~</span> GiniDBH <span class="sc">+</span> ShannonIndexTreeSpp,</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> poisson,</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> observations)</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(birdModel2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = birdNumObs ~ GiniDBH + ShannonIndexTreeSpp, family = poisson, 
    data = observations)

Coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          2.63499    0.05665  46.513   &lt;2e-16 ***
GiniDBH              0.33323    0.21661   1.538    0.124    
ShannonIndexTreeSpp  0.06923    0.07444   0.930    0.352    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 59.277  on 98  degrees of freedom
Residual deviance: 53.419  on 96  degrees of freedom
AIC: 512.71

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>Here we can see that the variable Shannon index also has a positive relationship with the number of bird species in the plot but its effect is much smaller. We can also observe that this variable is not significant and that including this variable also made Gini index variable not significant. This does not mean that is wrong to add this variable, because we want to understand its effect, but keeping this variable in the model or not depends on what you’re trying to do, and what “reality” is. Adding variables that are not needed will not help your model (particularly your estimates), but also might not matter much (e.g.&nbsp;predictions). However, removing variables that are real, even if they don’t meet significance, can create a useless model.</p>
<p>Variable selection is a long and complicated topic. some general rules of thumb include: (1) Include the variable if it is of interest, (2) Include the variable if you have some prior knowledge that it should be relevant. This can be misleading, because it’s a confirmation bias, but in most cases this makes sense. (3) If you want a model that can generalize to many cases, you should favor fewer variables.</p>
</section>
<section id="explanatory-power-of-the-model-2" class="level4">
<h4 class="anchored" data-anchor-id="explanatory-power-of-the-model-2">Explanatory Power of the model</h4>
<p>When we ran linear models, we used the coefficient of determination, or R<sup>2</sup>&nbsp;to assess how much of the variability in our response variable is explained by a given model. R<sup>2</sup>&nbsp;is based on the sums of squares of our model, and so cannot be calculated for GLMs. Instead, we can calculate the the deviance explained by our model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the null and residual deviance from the model</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>dev.null <span class="ot">&lt;-</span> birdModel1<span class="sc">$</span>null.deviance</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>dev.resid <span class="ot">&lt;-</span> birdModel1<span class="sc">$</span>deviance</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the deviance explained by the model</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>dev.explained <span class="ot">&lt;-</span> (dev.null <span class="sc">-</span> dev.resid)<span class="sc">/</span>dev.null</span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Round to 3 decimal places</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>dev.explained <span class="ot">&lt;-</span> <span class="fu">round</span>(dev.explained, <span class="dv">3</span>)</span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>dev.explained</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.084</code></pre>
</div>
</div>
<p>Variability in forest structure (Gini index) explain 8% of the variation in bird species richness in this study. That is an ok explanatory power for a very simple model of a complex ecological system (many factors determine the species richness for birds and we are attempting to explain everything with just one variable).</p>
</section>
<section id="model-assumptions-2" class="level4">
<h4 class="anchored" data-anchor-id="model-assumptions-2">Model Assumptions</h4>
<p>For Poisson GLMs, there is one further assumption that we have not encountered before. If data follow a Poisson distribution, then the mean of the distribution is equal to the variance. Accordingly, a Poisson distribution is represented by just one parameter <span class="math inline">\(\lambda\)</span>, which describes both the mean and the variance of the distribution.</p>
<p>Count data in ecology are often&nbsp;<strong>overdispersed</strong>, where the variance is greater than the mean. This violates the assumption of a Poisson GLM, and means that any statistics that we calculate from the model may be unreliable.</p>
<p>We can get look whether a model is over-dispersed by inspecting the model summary as you did in <a href="#sec-C_2_fit">Section&nbsp;3.4.6.1</a>. As a rule of thumb, if the response variable conforms to a true Poisson distribution, we expect the residual deviance to be approximately equal to the residual degrees of freedom. If the deviance is much greater than the degrees of freedom, this indicates over-dispersion. This is the case in our models (see outputs from running the code in <a href="#sec-C_2_fit">Section&nbsp;3.4.6.1</a>).</p>
<p>To check the model assumptions in a GLM is not as straight-forward as with a linear model. This is because classical residuals are not expected to behave in the same way for GLMs. We can use the DHARMa package in R for working with GLMs, which uses a simulation-based approach to compare the residuals from the actual model with the expectation if the model is behaving normally:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate residuals </span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>simResids <span class="ot">&lt;-</span> DHARMa<span class="sc">::</span><span class="fu">simulateResiduals</span>(birdModel1)</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate plots to compare the model residuals to expectations</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simResids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/model%20assumptions3-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>These plots show us that this model is not behaving as we would expect in terms of homogeneity of variance and distribution of residuals. A follow up to this would be to try alternatives to deal with over-dispersed count data in GLMs such as fit a quasi-Poisson GLM or a negative binomial GLM. Unfortunately we do not have time to continuou in this exercise.</p>
</section>
</section>
<section id="sec-D_2" class="level3">
<h3 class="anchored" data-anchor-id="sec-D_2">Question D - Group 2</h3>
<ul>
<li>Is the number of bird species affected by forest management type and the forest structural diversity?</li>
</ul>
<section id="sec-D_2_fit" class="level4">
<h4 class="anchored" data-anchor-id="sec-D_2_fit">Fitting a Poisson GLM in R</h4>
<p>Fitting a Poisson GLM in R is very similar to fitting an analysis of covariance (or linear model), except that now we need to use the glm function. To run a GLM, we need to provide one extra piece of information beyond that needed for a linear model: the family of model we want to use. In this case, we want a Poisson family.</p>
<p>We could start by only looking at how the forest structural diversity affects the number bird species that we have in a plot. You can do this by creating a GLM model which has <code>birdNumObs</code> as response variable and <code>GiniDBH</code> as explanatory variable. For that you will use the function <code>glm</code> in R and use the <code>family = poisson</code>. You can see how to create and see this model here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>birdModel1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(birdNumObs <span class="sc">~</span> GiniDBH,</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> poisson,</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> observations)</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(birdModel1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = birdNumObs ~ GiniDBH, family = poisson, data = observations)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.63827    0.05636  46.809   &lt;2e-16 ***
GiniDBH      0.42725    0.19030   2.245   0.0248 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 59.277  on 98  degrees of freedom
Residual deviance: 54.280  on 97  degrees of freedom
AIC: 511.57

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>Here you can see that the coefficient table produced by a GLM is very similar to a linear model. The intercept tells us the estimated value of the response variable when the continuous explanatory variables (here just Gini index) have a value of 0. We then also have coefficients describing the slope of the relationship with our continuous explanatory variables. We can see here that the bird numbers appears to show a positive relationship with Gini index, which means that increasing structural diversity in trees diameter sizes has a positive relationship with the number of bird species in the plot.</p>
<p>We are also interested in understanding the relationship of the number of observed bird species and forest management, we can now try to add this variable into the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>birdModel2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(birdNumObs <span class="sc">~</span> forestManagementType,</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> poisson,</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> observations)</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(birdModel2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = birdNumObs ~ forestManagementType, family = poisson, 
    data = observations)

Coefficients:
                                        Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                              2.83688    0.06052  46.873   &lt;2e-16
forestManagementTypesimple clearcutting -0.11744    0.06850  -1.714   0.0865
forestManagementTypeunmanaged           -0.06429    0.08338  -0.771   0.4407
                                           
(Intercept)                             ***
forestManagementTypesimple clearcutting .  
forestManagementTypeunmanaged              
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 59.277  on 98  degrees of freedom
Residual deviance: 56.205  on 96  degrees of freedom
AIC: 515.49

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>The intercept here tells us the estimated value of the response variable when the reference groups in our grouping (categorical) variables (here for retention clear-cutting). We then also have coefficients describing the slope of the relationship with our continuous explanatory variables, and coefficients giving the estimated difference in the response variable for non-reference groupings. We can see here that number of bird species appears to show a negative relationship with simple clearcutting, unmanaged and a positive relationship with retention clear-cutting.</p>
<p>The type simple clearcutting and unmanaged appear to be no significant, which only tell us about the&nbsp;pairwise differences between the levels. To test whether the categorical predictor, as a whole, is significant is equivalent to testing whether there is any heterogeneity in the means of the levels of the predictor. When there are no other predictors in the model, this is a classical&nbsp;<a href="http://en.wikipedia.org/wiki/Analysis_of_variance">ANOVA</a> problem.</p>
</section>
<section id="explanatory-power-of-the-model-3" class="level4">
<h4 class="anchored" data-anchor-id="explanatory-power-of-the-model-3">Explanatory Power of the model</h4>
<p>When we ran linear models, we used the coefficient of determination, or R<sup>2</sup>&nbsp;to assess how much of the variability in our response variable is explained by a given model. R<sup>2</sup>&nbsp;is based on the sums of squares of our model, and so cannot be calculated for GLMs. Instead, we can calculate the the deviance explained by our model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the null and residual deviance from the model</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>dev.null <span class="ot">&lt;-</span> birdModel1<span class="sc">$</span>null.deviance</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>dev.resid <span class="ot">&lt;-</span> birdModel1<span class="sc">$</span>deviance</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the deviance explained by the model</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>dev.explained <span class="ot">&lt;-</span> (dev.null <span class="sc">-</span> dev.resid)<span class="sc">/</span>dev.null</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Round to 3 decimal places</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>dev.explained <span class="ot">&lt;-</span> <span class="fu">round</span>(dev.explained, <span class="dv">3</span>)</span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>dev.explained</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.084</code></pre>
</div>
</div>
<p>Variability in forest structure (Gini index) explain 15% of the variation in bird species richness in this study system. That is an ok explanatory power for a very simple model of a complex ecological system (many factors determine the species richness and we are attempting to explain everything with one variable).</p>
</section>
<section id="model-assumptions-3" class="level4">
<h4 class="anchored" data-anchor-id="model-assumptions-3">Model Assumptions</h4>
<p>For Poisson GLMs, there is one further assumption that we have not encountered before. If data follow a Poisson distribution, then the mean of the distribution is equal to the variance. Accordingly, a Poisson distribution is represented by just one parameter <span class="math inline">\(\lambda\)</span>, which describes both the mean and the variance of the distribution.</p>
<p>Count data in ecology are often&nbsp;<strong><em>overdispersed</em></strong>, where the variance is greater than the mean. This violates the assumption of a Poisson GLM, and means that any statistics that we calculate from the model may be unreliable.</p>
<p>We can get look whether a model is over-dispersed by inspecting the model summary as you did in <a href="#sec-D_2_fit">Section&nbsp;3.4.7.1</a>. As a rule of thumb, if the response variable conforms to a true Poisson distribution, we expect the residual deviance to be approximately equal to the residual degrees of freedom. If the deviance is much greater than the degrees of freedom, this indicates over-dispersion. This is the case in our models (see outputs from running the code in <a href="#sec-D_2_fit">Section&nbsp;3.4.7.1</a>).</p>
<p>To check the model assumptions in a GLM is not as straight forward as with a linear model. This is because classical residuals are not expected to behave in the same way for GLMs. We can use the DHARMa package in R for working with GLMs, which uses a simulation-based approach to compare the residuals from the actual model with the expectation if the model is behaving normally.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate residuals </span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>simResids <span class="ot">&lt;-</span> DHARMa<span class="sc">::</span><span class="fu">simulateResiduals</span>(birdModel1)</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate plots to compare the model residuals to expectations</span></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(simResids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/model%20assumptions4%20-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>These plots show us that this model is not behaving as we would expect in terms of homogeneity of variance and distribution of residuals. A follow up to this would be to try alternatives to deal with over-dispersed count data in GLMs such as fit a quasi-Poisson GLM or a negative binomial GLM. Unfortunately we do not have to continuou in this exercise.</p>
</section>
</section>
<section id="sec-C_3" class="level3">
<h3 class="anchored" data-anchor-id="sec-C_3">Question C - Group 3</h3>
<ul>
<li>Is the presence of the Great spotted woodpecker affected by forest density?</li>
</ul>
<section id="fitting-a-brt-in-r" class="level4">
<h4 class="anchored" data-anchor-id="fitting-a-brt-in-r">Fitting a BRT in R</h4>
<p>In this case we want to assess the occurrence of certain species across the plots. In other words, we want to assess what is the probability of a certain species with biodiversity interest to be present in a plot based on the variables that describe the forest of that plot. In this case the response variable is <code>dendrocoposMajor</code> that represents if the Great spotted woodpecker has been observed in this plot or not.</p>
<p>Then you need to select some variables of interest, after you have explored the data you can decide which variables you want to use to fit this model. We are proposing to select the following variables:</p>
<ul>
<li><p><code>latitude</code> as proxy for plot location or/and climate</p></li>
<li><p><code>forestManagementType</code> to assess if different management types have different impact in the presence / absence of Great spotted woodpecker.</p></li>
<li><p><code>volAllha</code> that is the total volume in the plot, as a proxy of how dense the plot is. Higher volumes will mean that the forest is more dense.</p></li>
<li><p><code>GiniDBH</code> showing how homogeneous the plot is in trees diameters. A value closer to 1 indicate a more structural heterogeneity, lower values indicate more homogeneous plots.</p></li>
</ul>
<p>You can create a vector <code>selVar</code> in which you add the names of the selected variables. Then you only take those variables from the data that you will use to create the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select variables from the dataset for the model</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>selVar <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"dendrocoposMajor"</span>, <span class="st">"latitude"</span>,<span class="st">"forestManagementType"</span>,</span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">"volAllha"</span>, <span class="st">"GiniDBH"</span>,  <span class="st">"ShannonIndexTreeSpp"</span>)</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the dataset to the selected variables</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>modelDataSel <span class="ot">&lt;-</span> observations[, <span class="fu">colnames</span>(observations) <span class="sc">%in%</span> selVar]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unfortunately the amount of that we have in this dataset it is not enough to fit a BRT model for these variables. We are going to do an obviously wrong thing for the shake of being able to demonstrate how to fit a BRT model. In the next code you are going to repeat the same dataset multiple times:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>modelDataSel <span class="ot">&lt;-</span> <span class="fu">rbind</span>(modelDataSel, modelDataSel, modelDataSel, modelDataSel,</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>                      modelDataSel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now it is important to assess if the variables have the right categories. Variables should be type numeric or factor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelDataSel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    latitude     forestManagementType    volAllha          GiniDBH       
 Min.   :48.65   Length:495           Min.   :  1.681   Min.   :0.08209  
 1st Qu.:49.31   Class :character     1st Qu.:319.920   1st Qu.:0.13684  
 Median :49.40   Mode  :character     Median :434.729   Median :0.20358  
 Mean   :49.49                        Mean   :425.694   Mean   :0.25683  
 3rd Qu.:50.19                        3rd Qu.:558.355   3rd Qu.:0.37368  
 Max.   :50.34                        Max.   :777.882   Max.   :0.52852  
 ShannonIndexTreeSpp dendrocoposMajor
 Min.   :0.000       Min.   :0.0000  
 1st Qu.:0.060       1st Qu.:0.0000  
 Median :0.280       Median :1.0000  
 Mean   :0.392       Mean   :0.7071  
 3rd Qu.:0.680       3rd Qu.:1.0000  
 Max.   :1.450       Max.   :1.0000  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two variables are character, we assign to factor instead:</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>modelDataSel<span class="sc">$</span>forestManagementType <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(modelDataSel<span class="sc">$</span>forestManagementType)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the next step you can see how you can run the model with the selected variables and model parameters. You have a description of the models parameters in the <a href="#sec-modelBRT">Section&nbsp;3.3.2</a> . In this example we are going to use the default parameters for the calibration, where learning rate = 0.01 and tree complexity = 1 and cross-validation = 10-fold. However, the bag fraction is changed from the default value, 0.75, to 0.5. As a family we used the Bernoulli family, because we are predicting presence/absence per plot. These data have 495 plots, comprising 350 presence records for the Great spotted woodpecker. You can check these numbers by doing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(modelDataSel<span class="sc">$</span>dendrocoposMajor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
145 350 </code></pre>
</div>
</div>
<p>As a first guess you could decide there are enough data to model interactions of reasonable complexity, and a lr of about 0.01 could be a reasonable starting point. You can use the model creation function that steps forward and identifies the optimal number of trees (nt) by doing this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>family <span class="ot">&lt;-</span> <span class="st">"bernoulli"</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">=</span> <span class="dv">1</span>    <span class="co"># tree complexity</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    lr <span class="ot">=</span> <span class="fl">0.01</span> <span class="co"># learning rate-shrinkage </span></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>    bag <span class="ot">=</span> <span class="fl">0.5</span> <span class="co"># bag fraction</span></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>    modelBRT <span class="ot">&lt;-</span> dismo<span class="sc">::</span><span class="fu">gbm.step</span>(<span class="at">data =</span> modelDataSel,</span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#indices of predictor variables in data</span></span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gbm.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, </span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#index of response variable in data:</span></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gbm.y =</span> <span class="dv">6</span>,  </span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family =</span> family,</span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">tree.complexity =</span> tc,</span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">learning.rate =</span> lr,</span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">bag.fraction =</span> bag)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/BRTmodel-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Running a model such as that described above writes progress reports to the screen, makes a graph, and returns an object containing a number of components. The R console results reports a brief model summary all the values are also retained in the model object.</p>
<p>The model is built with the default 10-fold cross-validation (CV). In the plotted graph the solid black curve is the mean, and the dotted curves 1 standard error, for the changes in predictive deviance (i.e., as measured on the excluded folds of the CV). The red line shows the minimum of the mean, and the green line the number of trees at which that occurs. The final model that is returned in the model object is built on the full data set, using the number of trees identified as optimal.</p>
<p>Ideally, you should invest time in modifying the parameters and find the parameters that provide the models with the minimum deviance resulting from the best combination of bag, tree complexity and learning rate values. For the shake of limited timing, we will only test here the default values.</p>
</section>
<section id="model-behaviour" class="level4">
<h4 class="anchored" data-anchor-id="model-behaviour">Model behaviour</h4>
<p>You can summarize the model parameters used and the cross validation statistics from the fitted model by doing this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We make a table with the summary statistics  </span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a> results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model parameters</span></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a><span class="at">Tree.Complexity =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>tree.complexity, </span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a><span class="at">Learning.Rate =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>learning.rate, </span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Bag.Fraction =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>bag.fraction,</span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Interaction.depth =</span> modelBRT<span class="sc">$</span>interaction.depth,</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Shrinkage =</span> modelBRT<span class="sc">$</span>shrinkage,</span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">N.trees =</span> modelBRT<span class="sc">$</span>n.trees,</span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross validation statistics </span></span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a><span class="do">## mean total deviance</span></span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a><span class="at">Deviance =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>mean.resid, <span class="co"># mean residual deviance </span></span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a><span class="at">AUC =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>discrimination, <span class="co"># training data AUC score</span></span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a><span class="at">Corr =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>correlation,   <span class="co"># training data correlation</span></span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Cross Validation statistics</span></span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a><span class="co"># We calculate each statistic within each fold (at the identified optimal number</span></span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a><span class="co"># of trees that is calculated on the mean change in predictive deviance over all folds), </span></span>
<span id="cb201-25"><a href="#cb201-25" aria-hidden="true" tabindex="-1"></a><span class="co">#then present here the mean and standard error of those fold-based statistics.</span></span>
<span id="cb201-26"><a href="#cb201-26" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb201-27"><a href="#cb201-27" aria-hidden="true" tabindex="-1"></a><span class="at">devianceCV =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>deviance.mean,  <span class="co"># estimated cv deviance </span></span>
<span id="cb201-28"><a href="#cb201-28" aria-hidden="true" tabindex="-1"></a><span class="at">devianceCVse =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>deviance.se,  <span class="co"># estimated cv deviance se</span></span>
<span id="cb201-29"><a href="#cb201-29" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb201-30"><a href="#cb201-30" aria-hidden="true" tabindex="-1"></a><span class="at">CorrCV =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>correlation.mean,  <span class="co">#cv correlation</span></span>
<span id="cb201-31"><a href="#cb201-31" aria-hidden="true" tabindex="-1"></a><span class="at">CorrCVse =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>correlation.se,  <span class="co">#cv correlation se</span></span>
<span id="cb201-32"><a href="#cb201-32" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb201-33"><a href="#cb201-33" aria-hidden="true" tabindex="-1"></a><span class="at">AUCcv =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>discrimination.mean, <span class="co"># cv AUC score</span></span>
<span id="cb201-34"><a href="#cb201-34" aria-hidden="true" tabindex="-1"></a><span class="at">AUCcvSE =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>discrimination.se)  <span class="co"># cv AUC score se</span></span>
<span id="cb201-35"><a href="#cb201-35" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb201-36"><a href="#cb201-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-37"><a href="#cb201-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">t</span>(results))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          [,1]
Tree.Complexity   1.000000e+00
Learning.Rate     1.000000e-02
Bag.Fraction      5.000000e-01
Interaction.depth 1.000000e+00
Shrinkage         1.000000e-02
N.trees           1.000000e+04
Deviance          2.174491e-01
AUC               1.000000e+00
Corr              9.743705e-01
devianceCV        2.632748e-01
devianceCVse      1.313667e-02
CorrCV            9.581767e-01
CorrCVse          7.434663e-03
AUCcv             9.987800e-01
AUCcvSE           1.220000e-03</code></pre>
</div>
</div>
</section>
<section id="model-output-analysis" class="level4">
<h4 class="anchored" data-anchor-id="model-output-analysis">Model output analysis</h4>
<p>We can look at the relative contribution of each of the predictor variables. The measures are based on the number of times the variable is selected for splitting, weighted by the improvement of the model as a result of each split averaged across all trees. The relative contribution of each of the variables is scaled so the sum is 100%, with higher numbers indicating stronger influence in the response.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables contribution </span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>modelBRT<span class="sc">$</span>contributions </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      var  rel.inf
latitude                         latitude 33.97793
volAllha                         volAllha 24.86506
GiniDBH                           GiniDBH 24.04194
ShannonIndexTreeSpp   ShannonIndexTreeSpp 12.38457
forestManagementType forestManagementType  4.73051</code></pre>
</div>
</div>
<p>Here we can see that the two variables with the highest influence in the response are <code>latitude</code>, and <code>volAllhsa</code>.</p>
<p>Now we can evaluate the model behavior via partial dependence plots, showing the effect of each of the variables on the response by accounting for the average effects of all other predictors in the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>    dismo<span class="sc">::</span><span class="fu">gbm.plot</span>(modelBRT, <span class="at">n.plots =</span> <span class="dv">6</span>,</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">plot.layout =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">write.title =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dismo::gbm.plot(modelBRT, n.plots = 6, plot.layout = c(2, 3), :
reducing no of plotted predictors to maximum available (5)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/marginallEffects-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In partial dependence plots the predictions are on the scale of f(x). In this case, for the Bernoulli loss the returned value is on the log odds scale. You can see how this plot will look by plotting with the function from the package <code>gbm</code> and using the type “response”. Since we are interested in finding out if the forest density has an impact on the presence of the Great spotted woodpecker we can have a look to the plot density variable <code>volAllha</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>gbm<span class="sc">::</span><span class="fu">plot.gbm</span>(modelBRT, <span class="at">i.var =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="st">"response"</span>, </span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">ylab =</span> <span class="st">"Probability of finding a Great spotted woodpecker "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/response-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It seems that there is an increase in probability of finding a Great spotted woodpecker with higher forest densities, but the trend it is not very clear. We could also analyse the interaction effects, of density and for example overall bird richness. The model predictions can be obtained for each pair of predictor variables, setting all other predictors to their means.</p>
<p>To plot this pairwise interactions we have to do:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>dismo<span class="sc">::</span><span class="fu">gbm.perspec</span>(modelBRT, <span class="dv">3</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/pairwise%20int-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>Here we can see that both increasing bird diversity and forest density provides the highest probabilities for finding the Great spotted woodpecker.</p>
</section>
</section>
<section id="sec-D_3" class="level3">
<h3 class="anchored" data-anchor-id="sec-D_3">Question D - Group 3</h3>
<ul>
<li>Is the presence of the Great spotted woodpecker affected by forest diversity?</li>
</ul>
<section id="fitting-a-brt-in-r-1" class="level4">
<h4 class="anchored" data-anchor-id="fitting-a-brt-in-r-1">Fitting a BRT in R</h4>
<p>In this case we want to assess the occurrence of certain species across the plots. In other words, we want to assess what is the probability of a certain species with biodiversity interest to be present in a plot based on the variables that describe the forest of that plot. In this case the response variable is <code>dendrocoposMajor</code> that represents if the Great spotted woodpecker has been observed in this plot or not.</p>
<p>Then you need to select some variables of interest, after you have explored the data you can decide which variables you want to use to fit this model. We are proposing to select the following variables:</p>
<ul>
<li><p><code>latitude</code> as proxy for plot location or/and climate</p></li>
<li><p><code>forestManagementType</code> to assess if different management types have different impact in the presence / absence of Great spotted woodpecker.</p></li>
<li><p><code>volAllha</code> that is the total volume in the plot, as a proxy of how dense the plot is. Higher volumes will mean that the forest is more dense.</p></li>
<li><p><code>GiniDBH</code> showing how homogeneous the plot is in trees diameters. A value closer to 1 will mean that indicate more structural heterogeneity, lower values indicate more homogeneous plots.</p></li>
</ul>
<p>You can create a vector <code>selVar</code> in which you add the names of the selected variables. Then you only take those variables from the data that you will use to create the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select variables from the dataset for the model</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>selVar <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"dendrocoposMajor"</span>, <span class="st">"latitude"</span>,<span class="st">"forestManagementType"</span>,</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">"volAllha"</span>,<span class="st">"GiniDBH"</span>,  <span class="st">"ShannonIndexTreeSpp"</span>)</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the dataset to the selected variables</span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>modelDataSel <span class="ot">&lt;-</span> observations[, <span class="fu">colnames</span>(observations) <span class="sc">%in%</span> selVar]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unfortunately the amount of that we have in this dataset it is not enough to fit a BRT model for these variables. We are going to do an obviously wrong thing for the shake of being able to demonstrate how to fit a BRT model. In the next code you are going to repeat the same dataset multiple times:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>modelDataSel <span class="ot">&lt;-</span> <span class="fu">rbind</span>(modelDataSel, modelDataSel, modelDataSel, modelDataSel,</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>                      modelDataSel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now it is important to assess if the variables have the right categories. Variables should be type numeric or factor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelDataSel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    latitude     forestManagementType    volAllha          GiniDBH       
 Min.   :48.65   Length:495           Min.   :  1.681   Min.   :0.08209  
 1st Qu.:49.31   Class :character     1st Qu.:319.920   1st Qu.:0.13684  
 Median :49.40   Mode  :character     Median :434.729   Median :0.20358  
 Mean   :49.49                        Mean   :425.694   Mean   :0.25683  
 3rd Qu.:50.19                        3rd Qu.:558.355   3rd Qu.:0.37368  
 Max.   :50.34                        Max.   :777.882   Max.   :0.52852  
 ShannonIndexTreeSpp dendrocoposMajor
 Min.   :0.000       Min.   :0.0000  
 1st Qu.:0.060       1st Qu.:0.0000  
 Median :0.280       Median :1.0000  
 Mean   :0.392       Mean   :0.7071  
 3rd Qu.:0.680       3rd Qu.:1.0000  
 Max.   :1.450       Max.   :1.0000  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two variables are character, we assign to factor instead:</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>modelDataSel<span class="sc">$</span>forestManagementType <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(modelDataSel<span class="sc">$</span>forestManagementType)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the next step you can see how you can run the model with the selected variables and model parameters. You have a description of the models parameters in the <a href="#sec-modelBRT">Section&nbsp;3.3.2</a> . In this example we are going to use the default parameters for the calibration, where learning rate = 0.01 and tree complexity = 1 and cross-validation = 10-fold. However, the bag fraction is changed from the default value, 0.75, to 0.5. As a family we used the Bernoulli family, because we are predicting presence/absence per plot. These data have 495 plots, comprising 350 presence records for the Great spotted woodpecker. You can check these numbers by doing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(modelDataSel<span class="sc">$</span>dendrocoposMajor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
145 350 </code></pre>
</div>
</div>
<p>As a first guess you could decide there are enough data to model interactions of reasonable complexity, and a lr of about 0.01 could be a reasonable starting point. You can use the model creation function that steps forward and identifies the optimal number of trees (nt) by doing this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>family <span class="ot">&lt;-</span> <span class="st">"bernoulli"</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">=</span> <span class="dv">1</span>    <span class="co"># tree complexity</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>    lr <span class="ot">=</span> <span class="fl">0.01</span> <span class="co"># learning rate-shrinkage </span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>    bag <span class="ot">=</span> <span class="fl">0.5</span> <span class="co"># bag fraction</span></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>    modelBRT <span class="ot">&lt;-</span> dismo<span class="sc">::</span><span class="fu">gbm.step</span>(<span class="at">data =</span> modelDataSel,</span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#indices of predictor variables in data</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gbm.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, </span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#index of response variable in data:</span></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gbm.y =</span> <span class="dv">6</span>,  </span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family =</span> family,</span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">tree.complexity =</span> tc,</span>
<span id="cb216-14"><a href="#cb216-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">learning.rate =</span> lr,</span>
<span id="cb216-15"><a href="#cb216-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">bag.fraction =</span> bag)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/BRTmodel6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Running a model such as that described above writes progress reports to the screen, makes a graph, and returns an object containing a number of components. The R console results reports a brief model summary all the values are also retained in the model object.</p>
<p>The model is built with the default 10-fold cross-validation (CV). In the plotted graph the solid black curve is the mean, and the dotted curves 1 standard error, for the changes in predictive deviance (i.e., as measured on the excluded folds of the CV). The red line shows the minimum of the mean, and the green line the number of trees at which that occurs. The final model that is returned in the model object is built on the full data set, using the number of trees identified as optimal.</p>
<p>Ideally, you should invest time in modifying the parameters and find the parameters that provide the models with the minimum deviance resulting from the best combination of bag, tree complexity and learning rate values. For the shake of limited timing, we will only test here the default values.</p>
</section>
<section id="model-behaviour-1" class="level4">
<h4 class="anchored" data-anchor-id="model-behaviour-1">Model behaviour</h4>
<p>You can summarize the model parameters used and the cross validation statistics from the fitted model by doing this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We make a table with the summary statistics  </span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a> results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model parameters</span></span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a><span class="at">Tree.Complexity =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>tree.complexity, </span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a><span class="at">Learning.Rate =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>learning.rate, </span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Bag.Fraction =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>bag.fraction,</span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Interaction.depth =</span> modelBRT<span class="sc">$</span>interaction.depth,</span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Shrinkage =</span> modelBRT<span class="sc">$</span>shrinkage,</span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">N.trees =</span> modelBRT<span class="sc">$</span>n.trees,</span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross validation statistics </span></span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a><span class="do">## mean total deviance</span></span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a><span class="at">Deviance =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>mean.resid, <span class="co"># mean residual deviance </span></span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-17"><a href="#cb217-17" aria-hidden="true" tabindex="-1"></a><span class="at">AUC =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>discrimination, <span class="co"># training data AUC score</span></span>
<span id="cb217-18"><a href="#cb217-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-19"><a href="#cb217-19" aria-hidden="true" tabindex="-1"></a><span class="at">Corr =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>correlation,   <span class="co"># training data correlation</span></span>
<span id="cb217-20"><a href="#cb217-20" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb217-21"><a href="#cb217-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Cross Validation statistics</span></span>
<span id="cb217-22"><a href="#cb217-22" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb217-23"><a href="#cb217-23" aria-hidden="true" tabindex="-1"></a><span class="co"># We calculate each statistic within each fold (at the identified optimal number</span></span>
<span id="cb217-24"><a href="#cb217-24" aria-hidden="true" tabindex="-1"></a><span class="co"># of trees that is calculated on the mean change in predictive deviance over all folds), </span></span>
<span id="cb217-25"><a href="#cb217-25" aria-hidden="true" tabindex="-1"></a><span class="co">#then present here the mean and standard error of those fold-based statistics.</span></span>
<span id="cb217-26"><a href="#cb217-26" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb217-27"><a href="#cb217-27" aria-hidden="true" tabindex="-1"></a><span class="at">devianceCV =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>deviance.mean,  <span class="co"># estimated cv deviance </span></span>
<span id="cb217-28"><a href="#cb217-28" aria-hidden="true" tabindex="-1"></a><span class="at">devianceCVse =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>deviance.se,  <span class="co"># estimated cv deviance se</span></span>
<span id="cb217-29"><a href="#cb217-29" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb217-30"><a href="#cb217-30" aria-hidden="true" tabindex="-1"></a><span class="at">CorrCV =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>correlation.mean,  <span class="co">#cv correlation</span></span>
<span id="cb217-31"><a href="#cb217-31" aria-hidden="true" tabindex="-1"></a><span class="at">CorrCVse =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>correlation.se,  <span class="co">#cv correlation se</span></span>
<span id="cb217-32"><a href="#cb217-32" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb217-33"><a href="#cb217-33" aria-hidden="true" tabindex="-1"></a><span class="at">AUCcv =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>discrimination.mean, <span class="co"># cv AUC score</span></span>
<span id="cb217-34"><a href="#cb217-34" aria-hidden="true" tabindex="-1"></a><span class="at">AUCcvSE =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>discrimination.se)  <span class="co"># cv AUC score se</span></span>
<span id="cb217-35"><a href="#cb217-35" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb217-36"><a href="#cb217-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb217-37"><a href="#cb217-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">t</span>(results))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          [,1]
Tree.Complexity   1.000000e+00
Learning.Rate     1.000000e-02
Bag.Fraction      5.000000e-01
Interaction.depth 1.000000e+00
Shrinkage         1.000000e-02
N.trees           1.000000e+04
Deviance          2.175771e-01
AUC               1.000000e+00
Corr              9.748588e-01
devianceCV        2.615452e-01
devianceCVse      1.529550e-02
CorrCV            9.599729e-01
CorrCVse          4.780207e-03
AUCcv             1.000000e+00
AUCcvSE           0.000000e+00</code></pre>
</div>
</div>
</section>
<section id="model-output-analysis-1" class="level4">
<h4 class="anchored" data-anchor-id="model-output-analysis-1">Model output analysis</h4>
<p>We can look at the relative contribution of each of the predictor variables. The measures are based on the number of times the variable is selected for splitting, weighted by the improvement of the model as a result of each split averaged across all trees. The relative contribution of each of the variables is scaled so the sum is 100%, with higher numbers indicating stronger influence in the response.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables contribution </span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>modelBRT<span class="sc">$</span>contributions </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      var   rel.inf
latitude                         latitude 33.204286
volAllha                         volAllha 24.959002
GiniDBH                           GiniDBH 24.483757
ShannonIndexTreeSpp   ShannonIndexTreeSpp 12.578965
forestManagementType forestManagementType  4.773989</code></pre>
</div>
</div>
<p>Here we can see that the two variables with the highest influence in the response are <code>latitude</code>, and <code>volAllhsa</code>.</p>
<p>Now we can evaluate the model behavior via partial dependence plots, showing the effect of each of the variables on the response by accounting for the average effects of all other predictors in the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>    dismo<span class="sc">::</span><span class="fu">gbm.plot</span>(modelBRT, <span class="at">n.plots =</span> <span class="dv">6</span>,</span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">plot.layout =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">write.title =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dismo::gbm.plot(modelBRT, n.plots = 6, plot.layout = c(2, 3), :
reducing no of plotted predictors to maximum available (5)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/marginallEffects6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In this partial dependence plots the predictions are on the scale of f(x). In this case, for the Bernoulli loss the returned value is on the log odds scale. You can see how this plot will look by plotting with the function from the package <code>gbm</code> and using the type “response”. Since we are interesting in finding out if the forest diversity has an impact in the presence of the Great spotted woodpecker we can have a look to the plot density variable <code>volAllha</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>gbm<span class="sc">::</span><span class="fu">plot.gbm</span>(modelBRT, <span class="at">i.var =</span> <span class="dv">5</span>, <span class="at">type =</span> <span class="st">"response"</span>, <span class="at">ylab =</span> <span class="st">"Probability of finding a Great spotted woodpecker "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/response6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It seems that there is an increase in probability of finding a Great spotted woodpecker with higher forest densities, but the trend it is not very clear. We could also analyse the interaction effects, of forest diversity and for example forest density. The model predictions can be obtained for each pair of predictor variables, setting all other predictors to their means.</p>
<p>To plot this pairwise interactions we have to do:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>dismo<span class="sc">::</span><span class="fu">gbm.perspec</span>(modelBRT, <span class="dv">3</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/pairwise%20int6-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>Here we can not see a very clear combined behavior between forest diversity and forest structural diversity in respect to the probabilities for finding the Great spotted woodpecker.</p>
</section>
</section>
<section id="sec-C_4" class="level3">
<h3 class="anchored" data-anchor-id="sec-C_4">Question C - Group 4</h3>
<ul>
<li>Is the presence of the Eurasian treecreeper affected by forest density?</li>
</ul>
<section id="fitting-a-brt-in-r-2" class="level4">
<h4 class="anchored" data-anchor-id="fitting-a-brt-in-r-2">Fitting a BRT in R</h4>
<p>In this case we want to assess the occurrence of certain species across the plots. In other words, we want to assess what is the probability of a certain species with biodiversity interest to be present in a plot based on the variables that describe the forest of that plot. In this case the response variable is <code>certhia</code> that represents if the Eurasian treecreeper has been observed in this plot or not.</p>
<p>Then you need to select some variables of interest, after you have explored the data you can decide which variables you want to use to fit this model. We are proposing to select the following variables:</p>
<ul>
<li><p><code>latitude</code> as proxy for plot location or/and climate</p></li>
<li><p><code>forestManagementType</code> to assess if different management types have different impact in the presence / absence of Great spotted woodpecker.</p></li>
<li><p><code>volAllha</code> that is the total volume in the plot, as a proxy of how dense the plot is. Higher volumes will mean that the forest is more dense.</p></li>
<li><p><code>GiniDBH</code> showing how homogeneous the plot is in trees diameters. A value closer to 1 will mean that indicate more structural heterogeneity, lower values indicate more homogeneous plots.</p></li>
</ul>
<p>You can create a vector <code>selVar</code> in which you add the names of the selected variables. Then you only take those variables from the data that you will use to create the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select variables from the dataset for the model</span></span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>selVar <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"certhia"</span>, <span class="st">"latitude"</span>, <span class="st">"forestManagementType"</span>,</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">"volAllha"</span>, <span class="st">"GiniDBH"</span>,  <span class="st">"ShannonIndexTreeSpp"</span>)</span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the dataset to the selected variables</span></span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a>modelDataSel <span class="ot">&lt;-</span> observations[, <span class="fu">colnames</span>(observations) <span class="sc">%in%</span> selVar]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unfortunately the amount of that we have in this dataset it is not enough to fit a BRT model for these variables. We are going to do an obviously wrong thing for the shake of being able to demonstrate how to fit a BRT model. In the next code you are going to repeat the same dataset multiple times:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>modelDataSel <span class="ot">&lt;-</span> <span class="fu">rbind</span>(modelDataSel, modelDataSel, modelDataSel, modelDataSel,</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>                      modelDataSel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now it is important to assess if the variables have the right categories. Variables should be type numeric or factor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelDataSel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    latitude     forestManagementType    volAllha          GiniDBH       
 Min.   :48.65   Length:495           Min.   :  1.681   Min.   :0.08209  
 1st Qu.:49.31   Class :character     1st Qu.:319.920   1st Qu.:0.13684  
 Median :49.40   Mode  :character     Median :434.729   Median :0.20358  
 Mean   :49.49                        Mean   :425.694   Mean   :0.25683  
 3rd Qu.:50.19                        3rd Qu.:558.355   3rd Qu.:0.37368  
 Max.   :50.34                        Max.   :777.882   Max.   :0.52852  
 ShannonIndexTreeSpp    certhia      
 Min.   :0.000       Min.   :0.0000  
 1st Qu.:0.060       1st Qu.:0.0000  
 Median :0.280       Median :1.0000  
 Mean   :0.392       Mean   :0.5859  
 3rd Qu.:0.680       3rd Qu.:1.0000  
 Max.   :1.450       Max.   :1.0000  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two variables are character, we assign to factor instead:</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>modelDataSel<span class="sc">$</span>forestManagementType <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(modelDataSel<span class="sc">$</span>forestManagementType)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the next step you can see how you can run the model with the selected variables and model parameters. You have a description of the models parameters in the <a href="#sec-modelBRT">Section&nbsp;3.3.2</a> . In this example we are going to use the default parameters for the calibration, where learning rate = 0.01 and tree complexity = 1 and cross-validation = 10-fold. However, the bag fraction is changed from the default value, 0.75, to 0.5. As a family we used the Bernoulli family, because we are predicting presence/absence per plot. These data have 495 plots, comprising 290 presence records for the Eurasian treecreeper. You can check these numbers by doing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(modelDataSel<span class="sc">$</span>certhia)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
205 290 </code></pre>
</div>
</div>
<p>As a first guess you could decide there are enough data to model interactions of reasonable complexity, and a lr of about 0.01 could be a reasonable starting point. You can use the model creation function that steps forward and identifies the optimal number of trees (nt) by doing this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>family <span class="ot">&lt;-</span> <span class="st">"bernoulli"</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">=</span> <span class="dv">1</span>    <span class="co"># tree complexity</span></span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>    lr <span class="ot">=</span> <span class="fl">0.01</span> <span class="co"># learning rate-shrinkage </span></span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>    bag <span class="ot">=</span> <span class="fl">0.5</span> <span class="co"># bag fraction</span></span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a>    modelBRT <span class="ot">&lt;-</span> dismo<span class="sc">::</span><span class="fu">gbm.step</span>(<span class="at">data =</span> modelDataSel,</span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#indices of predictor variables in data</span></span>
<span id="cb232-9"><a href="#cb232-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gbm.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, </span>
<span id="cb232-10"><a href="#cb232-10" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#index of response variable in data:</span></span>
<span id="cb232-11"><a href="#cb232-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gbm.y =</span> <span class="dv">6</span>,  </span>
<span id="cb232-12"><a href="#cb232-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family =</span> family,</span>
<span id="cb232-13"><a href="#cb232-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">tree.complexity =</span> tc,</span>
<span id="cb232-14"><a href="#cb232-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">learning.rate =</span> lr,</span>
<span id="cb232-15"><a href="#cb232-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">bag.fraction =</span> bag)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/BRTmodel7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Running a model such as that described above writes progress reports to the screen, makes a graph, and returns an object containing a number of components. The R console results reports a brief model summary all the values are also retained in the model object.</p>
<p>The model is built with the default 10-fold cross-validation (CV). In the plotted graph the solid black curve is the mean, and the dotted curves 1 standard error, for the changes in predictive deviance (i.e., as measured on the excluded folds of the CV). The red line shows the minimum of the mean, and the green line the number of trees at which that occurs. The final model that is returned in the model object is built on the full data set, using the number of trees identified as optimal.</p>
<p>Ideally, you should invest time in modifying the parameters and find the parameters that provide the models with the minimum deviance resulting from the best combination of bag, tree complexity and learning rate values. For the shake of limited timing, we will only test here the default values.</p>
</section>
<section id="model-behaviour-2" class="level4">
<h4 class="anchored" data-anchor-id="model-behaviour-2">Model behaviour</h4>
<p>You can summarized the model parameters used and the cross validation statistics from the fitted model by doing this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We make a table with the summary statistics  </span></span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a> results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model parameters</span></span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a><span class="at">Tree.Complexity =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>tree.complexity, </span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a><span class="at">Learning.Rate =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>learning.rate, </span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Bag.Fraction =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>bag.fraction,</span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Interaction.depth =</span> modelBRT<span class="sc">$</span>interaction.depth,</span>
<span id="cb233-9"><a href="#cb233-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Shrinkage =</span> modelBRT<span class="sc">$</span>shrinkage,</span>
<span id="cb233-10"><a href="#cb233-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">N.trees =</span> modelBRT<span class="sc">$</span>n.trees,</span>
<span id="cb233-11"><a href="#cb233-11" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb233-12"><a href="#cb233-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross validation statistics </span></span>
<span id="cb233-13"><a href="#cb233-13" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb233-14"><a href="#cb233-14" aria-hidden="true" tabindex="-1"></a><span class="do">## mean total deviance</span></span>
<span id="cb233-15"><a href="#cb233-15" aria-hidden="true" tabindex="-1"></a><span class="at">Deviance =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>mean.resid, <span class="co"># mean residual deviance </span></span>
<span id="cb233-16"><a href="#cb233-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-17"><a href="#cb233-17" aria-hidden="true" tabindex="-1"></a><span class="at">AUC =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>discrimination, <span class="co"># training data AUC score</span></span>
<span id="cb233-18"><a href="#cb233-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-19"><a href="#cb233-19" aria-hidden="true" tabindex="-1"></a><span class="at">Corr =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>correlation,   <span class="co"># training data correlation</span></span>
<span id="cb233-20"><a href="#cb233-20" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb233-21"><a href="#cb233-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Cross Validation statistics</span></span>
<span id="cb233-22"><a href="#cb233-22" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb233-23"><a href="#cb233-23" aria-hidden="true" tabindex="-1"></a><span class="co"># We calculate each statistic within each fold (at the identified optimal number</span></span>
<span id="cb233-24"><a href="#cb233-24" aria-hidden="true" tabindex="-1"></a><span class="co"># of trees that is calculated on the mean change in predictive deviance over all folds), </span></span>
<span id="cb233-25"><a href="#cb233-25" aria-hidden="true" tabindex="-1"></a><span class="co">#then present here the mean and standard error of those fold-based statistics.</span></span>
<span id="cb233-26"><a href="#cb233-26" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb233-27"><a href="#cb233-27" aria-hidden="true" tabindex="-1"></a><span class="at">devianceCV =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>deviance.mean,  <span class="co"># estimated cv deviance </span></span>
<span id="cb233-28"><a href="#cb233-28" aria-hidden="true" tabindex="-1"></a><span class="at">devianceCVse =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>deviance.se,  <span class="co"># estimated cv deviance se</span></span>
<span id="cb233-29"><a href="#cb233-29" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb233-30"><a href="#cb233-30" aria-hidden="true" tabindex="-1"></a><span class="at">CorrCV =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>correlation.mean,  <span class="co">#cv correlation</span></span>
<span id="cb233-31"><a href="#cb233-31" aria-hidden="true" tabindex="-1"></a><span class="at">CorrCVse =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>correlation.se,  <span class="co">#cv correlation se</span></span>
<span id="cb233-32"><a href="#cb233-32" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb233-33"><a href="#cb233-33" aria-hidden="true" tabindex="-1"></a><span class="at">AUCcv =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>discrimination.mean, <span class="co"># cv AUC score</span></span>
<span id="cb233-34"><a href="#cb233-34" aria-hidden="true" tabindex="-1"></a><span class="at">AUCcvSE =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>discrimination.se)  <span class="co"># cv AUC score se</span></span>
<span id="cb233-35"><a href="#cb233-35" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb233-36"><a href="#cb233-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb233-37"><a href="#cb233-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">t</span>(results))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          [,1]
Tree.Complexity   1.000000e+00
Learning.Rate     1.000000e-02
Bag.Fraction      5.000000e-01
Interaction.depth 1.000000e+00
Shrinkage         1.000000e-02
N.trees           1.000000e+04
Deviance          3.646867e-01
AUC               1.000000e+00
Corr              9.538086e-01
devianceCV        4.378538e-01
devianceCVse      2.030625e-02
CorrCV            9.242168e-01
CorrCVse          8.238087e-03
AUCcv             9.979600e-01
AUCcvSE           1.462053e-03</code></pre>
</div>
</div>
</section>
<section id="model-output-analysis-2" class="level4">
<h4 class="anchored" data-anchor-id="model-output-analysis-2">Model output analysis</h4>
<p>We can look at the relative contribution of each of the predictor variables. The measures are based on the number of times the variable is selected for splitting, weighted by the improvement of the model as a result of each split averaged across all trees. The relative contribution of each of the variables is scaled so the sum is 100%, with higher numbers indicating stronger influence in the response.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables contribution </span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>modelBRT<span class="sc">$</span>contributions </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      var   rel.inf
GiniDBH                           GiniDBH 30.742680
latitude                         latitude 25.231987
volAllha                         volAllha 24.104923
ShannonIndexTreeSpp   ShannonIndexTreeSpp 18.709398
forestManagementType forestManagementType  1.211013</code></pre>
</div>
</div>
<p>Here we can see that the two variables with the highest influence in the response are <code>GiniDBH</code> and <code>volAllhsa</code>.</p>
<p>Now we can evaluate the model behavior via partial dependence plots, showing the effect of each of the variables on the response by accounting for the average effects of all other predictors in the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>    dismo<span class="sc">::</span><span class="fu">gbm.plot</span>(modelBRT, <span class="at">n.plots =</span> <span class="dv">6</span>,</span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">plot.layout =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">write.title =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dismo::gbm.plot(modelBRT, n.plots = 6, plot.layout = c(2, 3), :
reducing no of plotted predictors to maximum available (5)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/marginallEffects7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In this partial dependence plots the predictions are on the scale of f(x). In this case, for the Bernoulli loss the returned value is on the log odds scale. You can see how this plot will look by plotting with the function from the package <code>gbm</code> and using the type “response”. Since we are interesting in finding out if the forest density has an impact in the presence of the Eurasian treecreeper affected we can have a look to the plot density variable <code>volAllha</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>gbm<span class="sc">::</span><span class="fu">plot.gbm</span>(modelBRT, <span class="at">i.var =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="st">"response"</span>, <span class="at">ylab =</span> <span class="st">"Probability of finding a Common redstart"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/response7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It seems that there is an increase in probability of finding a Eurasian treecreeper with higher forest densities. We could also analyse the interaction effects, of forest diversity and for example forest density. The model predictions can be obtained for each pair of predictor variables, setting all other predictors to their means.</p>
<p>To plot this pairwise interactions we have to do:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>dismo<span class="sc">::</span><span class="fu">gbm.perspec</span>(modelBRT, <span class="dv">3</span>, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/pairwise%20int7-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>It seems that the highest chances to see a Eurasian treecreeper is in dense forests with highest tree diversity.</p>
</section>
</section>
<section id="sec-D_4" class="level3">
<h3 class="anchored" data-anchor-id="sec-D_4">Question D - Group 4</h3>
<ul>
<li>Is the presence of the Eurasian treecreeper affected by forest management?</li>
</ul>
<section id="fitting-a-brt-in-r-3" class="level4">
<h4 class="anchored" data-anchor-id="fitting-a-brt-in-r-3">Fitting a BRT in R</h4>
<p>In this case we want to assess the occurrence of certain species across the plots. In other words, we want to assess what is the probability of a certain species with biodiversity interest to be present in a plot based on the variables that describe the forest of that plot. In this case the response variable is <code>phoenicurus</code> that represents if the Great spotted woodpecker has been observed in this plot or not.</p>
<p>Then you need to select some variables of interest, after you have explored the data you can decide which variables you want to use to fit this model. We are proposing to select the following variables:</p>
<ul>
<li><p><code>latitude</code> as proxy for plot location or/and climate</p></li>
<li><p><code>forestManagementType</code> to assess if different management types have different impact in the presence / absence of Great spotted woodpecker.</p></li>
<li><p><code>volAllha</code> that is the total volume in the plot, as a proxy of how dense the plot is. Higher volumes will mean that the forest is more dense.</p></li>
<li><p><code>GiniDBH</code> showing how homogeneous the plot is in trees diameters. A value closer to 1 will mean that indicate more structural heterogeneity, lower values indicate more homogeneous plots.</p></li>
</ul>
<p>You can create a vector <code>selVar</code> in which you add the names of the selected variables. Then you only take those variables from the data that you will use to create the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select variables from the dataset for the model</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>selVar <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"certhia"</span>, <span class="st">"latitude"</span>, <span class="st">"forestManagementType"</span>,</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">"volAllha"</span>, <span class="st">"GiniDBH"</span>,  <span class="st">"ShannonIndexTreeSpp"</span>)</span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the dataset to the selected variables</span></span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>modelDataSel <span class="ot">&lt;-</span> observations[, <span class="fu">colnames</span>(observations) <span class="sc">%in%</span> selVar]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unfortunately the amount of that we have in this dataset it is not enough to fit a BRT model for these variables. We are going to do an obviously wrong thing for the shake of being able to demonstrate how to fit a BRT model. In the next code you are going to repeat the same dataset multiple times:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>modelDataSel <span class="ot">&lt;-</span> <span class="fu">rbind</span>(modelDataSel, modelDataSel, modelDataSel, modelDataSel,</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>                      modelDataSel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now it is important to assess if the variables have the right categories. Variables should be type numeric or factor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelDataSel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    latitude     forestManagementType    volAllha          GiniDBH       
 Min.   :48.65   Length:495           Min.   :  1.681   Min.   :0.08209  
 1st Qu.:49.31   Class :character     1st Qu.:319.920   1st Qu.:0.13684  
 Median :49.40   Mode  :character     Median :434.729   Median :0.20358  
 Mean   :49.49                        Mean   :425.694   Mean   :0.25683  
 3rd Qu.:50.19                        3rd Qu.:558.355   3rd Qu.:0.37368  
 Max.   :50.34                        Max.   :777.882   Max.   :0.52852  
 ShannonIndexTreeSpp    certhia      
 Min.   :0.000       Min.   :0.0000  
 1st Qu.:0.060       1st Qu.:0.0000  
 Median :0.280       Median :1.0000  
 Mean   :0.392       Mean   :0.5859  
 3rd Qu.:0.680       3rd Qu.:1.0000  
 Max.   :1.450       Max.   :1.0000  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two variables are character, we assign to factor instead:</span></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>modelDataSel<span class="sc">$</span>forestManagementType <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(modelDataSel<span class="sc">$</span>forestManagementType)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the next step you can see how you can run the model with the selected variables and model parameters. You have a description of the models parameters in the <a href="#sec-modelBRT">Section&nbsp;3.3.2</a> . In this example we are going to use the default parameters for the calibration, where learning rate = 0.01 and tree complexity = 1 and cross-validation = 10-fold. However, the bag fraction is changed from the default value, 0.75, to 0.5. As a family we used the Bernoulli family, because we are predicting presence/absence per plot. These data have 495 plots, comprising 290 presence records for the Eurasian treecreeper. You can check these numbers by doing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(modelDataSel<span class="sc">$</span>certhia)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
205 290 </code></pre>
</div>
</div>
<p>As a first guess you could decide there are enough data to model interactions of reasonable complexity, and a lr of about 0.01 could be a reasonable starting point. You can use the model creation function that steps forward and identifies the optimal number of trees (nt) by doing this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>family <span class="ot">&lt;-</span> <span class="st">"bernoulli"</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>    tc <span class="ot">=</span> <span class="dv">1</span>    <span class="co"># tree complexity</span></span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>    lr <span class="ot">=</span> <span class="fl">0.01</span> <span class="co"># learning rate-shrinkage </span></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>    bag <span class="ot">=</span> <span class="fl">0.5</span> <span class="co"># bag fraction</span></span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>    modelBRT <span class="ot">&lt;-</span> dismo<span class="sc">::</span><span class="fu">gbm.step</span>(<span class="at">data =</span> modelDataSel,</span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#indices of predictor variables in data</span></span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gbm.x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, </span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#index of response variable in data:</span></span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gbm.y =</span> <span class="dv">6</span>,  </span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family =</span> family,</span>
<span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">tree.complexity =</span> tc,</span>
<span id="cb248-14"><a href="#cb248-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">learning.rate =</span> lr,</span>
<span id="cb248-15"><a href="#cb248-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">bag.fraction =</span> bag)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/BRTmodel8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Running a model such as that described above writes progress reports to the screen, makes a graph, and returns an object containing a number of components. The R console results reports a brief model summary all the values are also retained in the model object.</p>
<p>The model is built with the default 10-fold cross-validation (CV). In the plotted graph the solid black curve is the mean, and the dotted curves 1 standard error, for the changes in predictive deviance (i.e., as measured on the excluded folds of the CV). The red line shows the minimum of the mean, and the green line the number of trees at which that occurs. The final model that is returned in the model object is built on the full data set, using the number of trees identified as optimal.</p>
<p>Ideally, you should invest time in modifying the parameters and find the parameters that provide the models with the minimum deviance resulting from the best combination of bag, tree complexity and learning rate values. For the shake of limited timing, we will only test here the default values.</p>
</section>
<section id="model-behaviour-3" class="level4">
<h4 class="anchored" data-anchor-id="model-behaviour-3">Model behaviour</h4>
<p>You can summarize the model parameters used and the cross validation statistics from the fitted model by doing this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We make a table with the summary statistics  </span></span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a> results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model parameters</span></span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a><span class="at">Tree.Complexity =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>tree.complexity, </span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a><span class="at">Learning.Rate =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>learning.rate, </span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Bag.Fraction =</span> modelBRT<span class="sc">$</span>gbm.call<span class="sc">$</span>bag.fraction,</span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Interaction.depth =</span> modelBRT<span class="sc">$</span>interaction.depth,</span>
<span id="cb249-9"><a href="#cb249-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Shrinkage =</span> modelBRT<span class="sc">$</span>shrinkage,</span>
<span id="cb249-10"><a href="#cb249-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">N.trees =</span> modelBRT<span class="sc">$</span>n.trees,</span>
<span id="cb249-11"><a href="#cb249-11" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb249-12"><a href="#cb249-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross validation statistics </span></span>
<span id="cb249-13"><a href="#cb249-13" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb249-14"><a href="#cb249-14" aria-hidden="true" tabindex="-1"></a><span class="do">## mean total deviance</span></span>
<span id="cb249-15"><a href="#cb249-15" aria-hidden="true" tabindex="-1"></a><span class="at">Deviance =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>mean.resid, <span class="co"># mean residual deviance </span></span>
<span id="cb249-16"><a href="#cb249-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-17"><a href="#cb249-17" aria-hidden="true" tabindex="-1"></a><span class="at">AUC =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>discrimination, <span class="co"># training data AUC score</span></span>
<span id="cb249-18"><a href="#cb249-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-19"><a href="#cb249-19" aria-hidden="true" tabindex="-1"></a><span class="at">Corr =</span> modelBRT<span class="sc">$</span>self.statistics<span class="sc">$</span>correlation,   <span class="co"># training data correlation</span></span>
<span id="cb249-20"><a href="#cb249-20" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb249-21"><a href="#cb249-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Cross Validation statistics</span></span>
<span id="cb249-22"><a href="#cb249-22" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb249-23"><a href="#cb249-23" aria-hidden="true" tabindex="-1"></a><span class="co"># We calculate each statistic within each fold (at the identified optimal number</span></span>
<span id="cb249-24"><a href="#cb249-24" aria-hidden="true" tabindex="-1"></a><span class="co"># of trees that is calculated on the mean change in predictive deviance over all folds), </span></span>
<span id="cb249-25"><a href="#cb249-25" aria-hidden="true" tabindex="-1"></a><span class="co">#then present here the mean and standard error of those fold-based statistics.</span></span>
<span id="cb249-26"><a href="#cb249-26" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb249-27"><a href="#cb249-27" aria-hidden="true" tabindex="-1"></a><span class="at">devianceCV =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>deviance.mean,  <span class="co"># estimated cv deviance </span></span>
<span id="cb249-28"><a href="#cb249-28" aria-hidden="true" tabindex="-1"></a><span class="at">devianceCVse =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>deviance.se,  <span class="co"># estimated cv deviance se</span></span>
<span id="cb249-29"><a href="#cb249-29" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb249-30"><a href="#cb249-30" aria-hidden="true" tabindex="-1"></a><span class="at">CorrCV =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>correlation.mean,  <span class="co">#cv correlation</span></span>
<span id="cb249-31"><a href="#cb249-31" aria-hidden="true" tabindex="-1"></a><span class="at">CorrCVse =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>correlation.se,  <span class="co">#cv correlation se</span></span>
<span id="cb249-32"><a href="#cb249-32" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb249-33"><a href="#cb249-33" aria-hidden="true" tabindex="-1"></a><span class="at">AUCcv =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>discrimination.mean, <span class="co"># cv AUC score</span></span>
<span id="cb249-34"><a href="#cb249-34" aria-hidden="true" tabindex="-1"></a><span class="at">AUCcvSE =</span> modelBRT<span class="sc">$</span>cv.statistics<span class="sc">$</span>discrimination.se)  <span class="co"># cv AUC score se</span></span>
<span id="cb249-35"><a href="#cb249-35" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb249-36"><a href="#cb249-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb249-37"><a href="#cb249-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">t</span>(results))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          [,1]
Tree.Complexity   1.000000e+00
Learning.Rate     1.000000e-02
Bag.Fraction      5.000000e-01
Interaction.depth 1.000000e+00
Shrinkage         1.000000e-02
N.trees           1.000000e+04
Deviance          3.646903e-01
AUC               1.000000e+00
Corr              9.536016e-01
devianceCV        4.360243e-01
devianceCVse      1.831040e-02
CorrCV            9.226776e-01
CorrCVse          9.011813e-03
AUCcv             9.983600e-01
AUCcvSE           1.640000e-03</code></pre>
</div>
</div>
</section>
<section id="model-output-analysis-3" class="level4">
<h4 class="anchored" data-anchor-id="model-output-analysis-3">Model output analysis</h4>
<p>We can look at the relative contribution of each of the predictor variables. The measures are based on the number of times the variable is selected for splitting, weighted by the improvement of the model as a result of each split averaged across all trees. The relative contribution of each of the variables is scaled so the sum is 100%, with higher numbers indicating stronger influence in the response.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables contribution </span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>modelBRT<span class="sc">$</span>contributions </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      var   rel.inf
GiniDBH                           GiniDBH 30.419136
latitude                         latitude 25.976155
volAllha                         volAllha 23.653628
ShannonIndexTreeSpp   ShannonIndexTreeSpp 18.808954
forestManagementType forestManagementType  1.142128</code></pre>
</div>
</div>
<p>Here we can see that the two variables with the highest influence in the response are <code>GiniDBH</code> and <code>volAllhsa</code>.</p>
<p>Now we can evaluate the model behavior via partial dependence plots, showing the effect of each of the variables on the response by accounting for the average effects of all other predictors in the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>    dismo<span class="sc">::</span><span class="fu">gbm.plot</span>(modelBRT, <span class="at">n.plots =</span> <span class="dv">6</span>,</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">plot.layout =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">write.title =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dismo::gbm.plot(modelBRT, n.plots = 6, plot.layout = c(2, 3), :
reducing no of plotted predictors to maximum available (5)</code></pre>
</div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/marginallEffects8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In this partial dependence plots the predictions are on the scale of f(x). In this case, for the Bernoulli loss the returned value is on the log odds scale. You can see how this plot will look by plotting with the function from the package <code>gbm</code> and using the type “response”. Since we are interesting in finding out if the forest density has an impact in the presence of the Eurasian treecreeper affected we can have a look to the plot density variable <code>volAllha</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>gbm<span class="sc">::</span><span class="fu">plot.gbm</span>(modelBRT, <span class="at">i.var =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="st">"response"</span>, <span class="at">ylab =</span> <span class="st">"Probability of finding a Common redstart"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/response8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>It seems that there is a small difference in the probability of finding the Eurasian treecreeper different management strategies. We could also analyse the interaction effects, of forest diversity and forest structual diversity. The model predictions can be obtained for each pair of predictor variables, setting all other predictors to their means.</p>
<p>To plot this pairwise interactions we have to do:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>dismo<span class="sc">::</span><span class="fu">gbm.perspec</span>(modelBRT, <span class="dv">5</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="modelEx_files/figure-html/pairwise%20int8-1.png" class="img-fluid" width="864"></p>
</div>
</div>
<p>It seems that there are not clear patterns in the combined effect of forest structure diversity and forest tree species diversity.</p>
</section>
</section>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<p>Aguirre, O., Hui, G., von Gadow, K. and Jiménez, J., 2003. An analysis of spatial forest structure using neighbourhood-based variables. Forest ecology and management, 183 (1-3), pp.137-145.</p>
<p>Gadow, K.V., Zhang, C.Y., Wehenkel, C., Pommerening, A., Corral-Rivas, J., Korol, M., Myklush, S., Hui, G.Y., Kiviste, A. and Zhao, X.H., 2012. Forest structure and diversity. Continuous cover forestry, pp.29-83.</p>

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-elith2008" class="csl-entry" role="listitem">
Elith, J., J. R. Leathwick, and T. Hastie. 2008. <span>“A Working Guide to Boosted Regression Trees.”</span> <em>Journal of Animal Ecology</em> 77 (4): 802–13. <a href="https://doi.org/10.1111/j.1365-2656.2008.01390.x">https://doi.org/10.1111/j.1365-2656.2008.01390.x</a>.
</div>
<div id="ref-friedman" class="csl-entry" role="listitem">
Friedman, Jerome, Trevor Hastie, and Robert Tibshirani. n.d. <span>“ADDITIVE LOGISTIC REGRESSION: A STATISTICAL VIEW OF BOOSTING.”</span>
</div>
<div id="ref-hosek" class="csl-entry" role="listitem">
Hošek, Jan. n.d. <span>“Forest Structure and Dead Wood Properties in Six Representative Forest Areas in the Czech Republic.”</span>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>